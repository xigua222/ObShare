/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";
var __defProp = Object.defineProperty;
var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
var __getOwnPropNames = Object.getOwnPropertyNames;
var __hasOwnProp = Object.prototype.hasOwnProperty;
var __export = (target, all) => {
  for (var name in all)
    __defProp(target, name, { get: all[name], enumerable: true });
};
var __copyProps = (to, from, except, desc) => {
  if (from && typeof from === "object" || typeof from === "function") {
    for (let key of __getOwnPropNames(from))
      if (!__hasOwnProp.call(to, key) && key !== except)
        __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
  }
  return to;
};
var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

// main.ts
var main_exports = {};
__export(main_exports, {
  default: () => FeishuUploaderPlugin
});
module.exports = __toCommonJS(main_exports);
var import_obsidian4 = require("obsidian");

// feishu-api.ts
var import_obsidian = require("obsidian");

// svg-converter.ts
var SvgConverter = class {
  // 4x for better quality
  /**
   * 将SVG内容转换为PNG格式的base64字符串
   * @param svgContent SVG文件内容
   * @param options 转换选项
   * @returns Promise<string> PNG格式的base64字符串
   */
  static async convertSvgToPng(svgContent, options = {}) {
    return new Promise((resolve, reject) => {
      try {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        if (!ctx) {
          throw new Error("\u65E0\u6CD5\u521B\u5EFACanvas\u4E0A\u4E0B\u6587");
        }
        const svgDimensions = this.parseSvgDimensions(svgContent);
        const width = options.width || svgDimensions.width || this.DEFAULT_WIDTH;
        const height = options.height || svgDimensions.height || this.DEFAULT_HEIGHT;
        const scale = options.scale || this.DEFAULT_SCALE;
        canvas.width = width * scale;
        canvas.height = height * scale;
        if (options.backgroundColor) {
          ctx.fillStyle = options.backgroundColor;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        const img = new Image();
        img.onload = () => {
          try {
            const imgWidth = img.naturalWidth || img.width;
            const imgHeight = img.naturalHeight || img.height;
            const actualWidth = imgWidth > 0 ? imgWidth : width;
            const actualHeight = imgHeight > 0 ? imgHeight : height;
            canvas.width = actualWidth * scale;
            canvas.height = actualHeight * scale;
            if (options.backgroundColor) {
              ctx.fillStyle = options.backgroundColor;
              ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            ctx.scale(scale, scale);
            ctx.drawImage(img, 0, 0, actualWidth, actualHeight);
            const dataUrl = canvas.toDataURL("image/png", 1);
            const base64Data = dataUrl.split(",")[1];
            if (base64Data) {
              resolve(base64Data);
            } else {
              reject(new Error("\u65E0\u6CD5\u751F\u6210PNG\u6570\u636E"));
            }
          } catch (error) {
            reject(new Error(`\u7ED8\u5236SVG\u5230Canvas\u5931\u8D25: ${error instanceof Error ? error.message : String(error)}`));
          } finally {
            URL.revokeObjectURL(svgUrl);
          }
        };
        img.onerror = () => {
          reject(new Error("\u52A0\u8F7DSVG\u56FE\u7247\u5931\u8D25"));
          URL.revokeObjectURL(svgUrl);
        };
        const svgBlob = new Blob([svgContent], { type: "image/svg+xml;charset=utf-8" });
        const svgUrl = URL.createObjectURL(svgBlob);
        img.src = svgUrl;
      } catch (error) {
        reject(new Error(`SVG\u8F6C\u6362\u521D\u59CB\u5316\u5931\u8D25: ${error instanceof Error ? error.message : String(error)}`));
      }
    });
  }
  /**
   * 解析SVG内容中的尺寸信息
   * @param svgContent SVG内容
   * @returns 尺寸信息
   */
  static parseSvgDimensions(svgContent) {
    try {
      const widthMatch = svgContent.match(/width\s*=\s*["']?(\d+(?:\.\d+)?)(?:px|pt|pc|mm|cm|in)?["']?/i);
      const heightMatch = svgContent.match(/height\s*=\s*["']?(\d+(?:\.\d+)?)(?:px|pt|pc|mm|cm|in)?["']?/i);
      let width;
      let height;
      if (widthMatch && widthMatch[1]) {
        width = parseFloat(widthMatch[1]);
      }
      if (heightMatch && heightMatch[1]) {
        height = parseFloat(heightMatch[1]);
      }
      if (!width || !height) {
        const viewBoxMatch = svgContent.match(/viewBox\s*=\s*["']?([^"']*?)["']?/i);
        if (viewBoxMatch && viewBoxMatch[1]) {
          const viewBoxValues = viewBoxMatch[1].trim().split(/\s+/);
          if (viewBoxValues.length >= 4 && viewBoxValues[2] && viewBoxValues[3]) {
            const vbWidth = parseFloat(viewBoxValues[2]);
            const vbHeight = parseFloat(viewBoxValues[3]);
            if (!isNaN(vbWidth) && !isNaN(vbHeight)) {
              width = width || vbWidth;
              height = height || vbHeight;
            }
          }
        }
      }
      const result = {};
      if (width !== void 0 && width > 0)
        result.width = width;
      if (height !== void 0 && height > 0)
        result.height = height;
      return result;
    } catch (error) {
      return {};
    }
  }
  /**
   * 检查文件是否为SVG格式
   * @param fileName 文件名
   * @param content 文件内容（可选）
   * @returns boolean
   */
  static isSvgFile(fileName, content) {
    const hasValidExtension = fileName.toLowerCase().endsWith(".svg");
    if (content) {
      const hasValidContent = content.trim().startsWith("<svg") || content.includes("<svg");
      return hasValidExtension && hasValidContent;
    }
    return hasValidExtension;
  }
  /**
   * 生成转换后的PNG文件名
   * @param originalFileName 原始SVG文件名
   * @returns PNG文件名
   */
  static generatePngFileName(originalFileName) {
    const baseName = originalFileName.replace(/\.svg$/i, "");
    return `${baseName}_converted.png`;
  }
  /**
   * 获取推荐的转换选项
   * @param svgContent SVG内容
   * @returns 推荐的转换选项
   */
  static getRecommendedOptions(svgContent) {
    const dimensions = this.parseSvgDimensions(svgContent);
    const defaultOptions = {
      width: 800,
      height: 600,
      scale: 1,
      backgroundColor: "transparent"
    };
    if (dimensions.width && dimensions.height) {
      defaultOptions.width = dimensions.width;
      defaultOptions.height = dimensions.height;
      const maxDimension = Math.max(dimensions.width, dimensions.height);
      if (maxDimension <= 100) {
        defaultOptions.scale = 8;
      } else if (maxDimension <= 200) {
        defaultOptions.scale = 6;
      } else if (maxDimension <= 400) {
        defaultOptions.scale = 4;
      } else if (maxDimension <= 800) {
        defaultOptions.scale = 2;
      } else {
        const maxSize = 2e3;
        if (dimensions.width > maxSize || dimensions.height > maxSize) {
          const scale = Math.min(maxSize / dimensions.width, maxSize / dimensions.height);
          defaultOptions.scale = scale;
        } else {
          defaultOptions.scale = 1;
        }
      }
    }
    const result = {};
    if (dimensions.width !== void 0) {
      result.width = dimensions.width;
    } else {
      result.width = defaultOptions.width;
    }
    if (dimensions.height !== void 0) {
      result.height = dimensions.height;
    } else {
      result.height = defaultOptions.height;
    }
    result.scale = defaultOptions.scale;
    result.backgroundColor = defaultOptions.backgroundColor;
    return result;
  }
};
SvgConverter.DEFAULT_WIDTH = 800;
SvgConverter.DEFAULT_HEIGHT = 600;
SvgConverter.DEFAULT_SCALE = 4;

// feishu-api.ts
var getErrorMeta = (error) => {
  if (typeof error !== "object" || error === null) {
    return {};
  }
  const meta = error;
  const result = {};
  if ("status" in meta) {
    const status = meta.status;
    if (typeof status === "number") {
      result.status = status;
    }
  }
  if ("statusText" in meta) {
    const statusText = meta.statusText;
    if (typeof statusText === "string") {
      result.statusText = statusText;
    }
  }
  if ("response" in meta) {
    result.response = meta.response;
  }
  if ("json" in meta) {
    result.json = meta.json;
  }
  if ("headers" in meta) {
    result.headers = meta.headers;
  }
  return result;
};
var isRecord = (value) => {
  return typeof value === "object" && value !== null;
};
var parseErrorResult = (value) => {
  if (!isRecord(value)) {
    return null;
  }
  const code = value["code"];
  const msg = value["msg"];
  if (typeof code !== "number" || typeof msg !== "string") {
    return null;
  }
  return { code, msg };
};
var parseTenantAccessTokenResponse = (value) => {
  const result = {};
  if (!isRecord(value)) {
    return result;
  }
  const tenantAccessToken = value["tenant_access_token"];
  if (typeof tenantAccessToken === "string") {
    result.tenant_access_token = tenantAccessToken;
  }
  const expire = value["expire"];
  if (typeof expire === "number") {
    result.expire = expire;
  }
  const code = value["code"];
  if (typeof code === "number") {
    result.code = code;
  }
  const msg = value["msg"];
  if (typeof msg === "string") {
    result.msg = msg;
  }
  return result;
};
var getAdapterBasePath = (adapter) => {
  if (!isRecord(adapter)) {
    return void 0;
  }
  const basePath = adapter["basePath"];
  return typeof basePath === "string" ? basePath : void 0;
};
var isImportTaskQueryResponse = (value) => {
  return typeof value === "object" && value !== null && "job_status" in value;
};
var _FeishuApiClient = class {
  // 每次删除请求间隔350ms，确保不超过每秒3次
  constructor(appId, appSecret, app, apiCallCountCallback) {
    this.accessToken = null;
    this.tokenExpireTime = 0;
    this.tokenRefreshPromise = null;
    // 飞书API基础URL
    this.baseUrl = "https://open.feishu.cn/open-apis";
    // 限速相关属性
    this.deleteRequestQueue = [];
    this.isProcessingDeleteQueue = false;
    this.lastDeleteRequestTime = 0;
    this.DELETE_REQUEST_INTERVAL = 350;
    this.appId = appId;
    this.appSecret = appSecret;
    this.app = app;
    this.apiCallCountCallback = apiCallCountCallback;
  }
  static setDebugEnabled(enabled) {
    this.debugEnabled = enabled;
  }
  debug(...args) {
    if (_FeishuApiClient.debugEnabled) {
      console.debug(...args);
    }
  }
  static debug(...args) {
    if (_FeishuApiClient.debugEnabled) {
      console.debug(...args);
    }
  }
  static logError(summary, error, details) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(summary, errorMessage);
    _FeishuApiClient.debug(`${summary} \u8BE6\u60C5:`, {
      ...details,
      error,
      errorMessage,
      errorStack: error instanceof Error ? error.stack : void 0
    });
  }
  logError(summary, error, details) {
    _FeishuApiClient.logError(summary, error, details);
  }
  /**
   * 处理删除请求队列，确保不超过频率限制
   */
  async processDeleteQueue() {
    if (this.isProcessingDeleteQueue || this.deleteRequestQueue.length === 0) {
      return;
    }
    this.isProcessingDeleteQueue = true;
    while (this.deleteRequestQueue.length > 0) {
      const now = Date.now();
      const timeSinceLastRequest = now - this.lastDeleteRequestTime;
      if (timeSinceLastRequest < this.DELETE_REQUEST_INTERVAL) {
        const waitTime = this.DELETE_REQUEST_INTERVAL - timeSinceLastRequest;
        await new Promise((resolve) => setTimeout(resolve, waitTime));
      }
      const request = this.deleteRequestQueue.shift();
      if (request) {
        this.lastDeleteRequestTime = Date.now();
        try {
          await request();
        } catch (error) {
          this.logError("[\u98DE\u4E66API] \u5220\u9664\u8BF7\u6C42\u6267\u884C\u5931\u8D25:", error);
          throw error;
        }
      }
    }
    this.isProcessingDeleteQueue = false;
  }
  /**
   * 将删除请求添加到队列中
   */
  async queueDeleteRequest(request) {
    return new Promise((resolve, reject) => {
      const wrappedRequest = async () => {
        try {
          const result = await request();
          resolve(result);
        } catch (error) {
          reject(error instanceof Error ? error : new Error(String(error)));
        }
      };
      this.deleteRequestQueue.push(wrappedRequest);
      void this.processDeleteQueue().catch((error) => {
        reject(error instanceof Error ? error : new Error(String(error)));
      });
    });
  }
  /**
   * 获取访问令牌
   */
  async getAccessToken() {
    const now = Date.now();
    if (this.accessToken && now < this.tokenExpireTime - 30 * 60 * 1e3) {
      return this.accessToken;
    }
    if (this.tokenRefreshPromise) {
      return await this.tokenRefreshPromise;
    }
    this.tokenRefreshPromise = this.performTokenRefresh();
    try {
      const token = await this.tokenRefreshPromise;
      return token;
    } finally {
      this.tokenRefreshPromise = null;
    }
  }
  /**
   * 执行实际的token刷新操作
   */
  async performTokenRefresh() {
    var _a;
    const now = Date.now();
    const url = `${this.baseUrl}/auth/v3/tenant_access_token/internal`;
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Content-Type": "application/json; charset=utf-8"
      },
      body: JSON.stringify({
        app_id: this.appId,
        app_secret: this.appSecret
      })
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = parseTenantAccessTokenResponse(response.json);
      if (!result.tenant_access_token) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11tenant_access_token\u5B57\u6BB5");
        this.debug("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11tenant_access_token\u5B57\u6BB5\uFF0C\u5B8C\u6574\u54CD\u5E94:", result);
        throw new Error(`API\u54CD\u5E94\u683C\u5F0F\u9519\u8BEF: \u7F3A\u5C11tenant_access_token\u5B57\u6BB5`);
      }
      if (result.code !== 0) {
        throw new Error(`\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25: ${result.msg}`);
      }
      this.accessToken = result.tenant_access_token;
      this.tokenExpireTime = now + (result.expire || 0) * 1e3;
      return result.tenant_access_token;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25:", error);
      if (error instanceof TypeError && error.message.includes("Failed to fetch")) {
        console.error("[\u98DE\u4E66API] \u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25");
        this.debug("[\u98DE\u4E66API] \u7F51\u7EDC\u8FDE\u63A5\u9519\u8BEF\uFF0C\u53EF\u80FD\u539F\u56E0:");
        this.debug("1. \u7F51\u7EDC\u8FDE\u63A5\u4E0D\u7A33\u5B9A\u6216\u65AD\u5F00");
        this.debug("2. \u9632\u706B\u5899\u6216\u4EE3\u7406\u963B\u6B62\u4E86\u8BF7\u6C42");
        this.debug("3. \u98DE\u4E66API\u670D\u52A1\u6682\u65F6\u4E0D\u53EF\u7528");
        this.debug("4. DNS\u89E3\u6790\u95EE\u9898");
        throw new Error("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5");
      }
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 上传文件到飞书云空间
   * 使用 drive/v1/files/upload_all 接口将文件上传到飞书云空间
   * @param fileName 文件名（需包含扩展名）
   * @param fileContent 文件内容（base64编码）
   * @param folderToken 目标文件夹token（可选）
   * @returns 返回上传后的文件token
   */
  async uploadFile(fileName, fileContent, folderToken) {
    var _a;
    const token = await this.getAccessToken();
    const url = `https://open.feishu.cn/open-apis/drive/v1/files/upload_all`;
    const binaryData = Uint8Array.from(atob(fileContent), (c) => c.charCodeAt(0));
    const boundary = "feishu-file-boundary-" + Math.random().toString(36).substring(2, 15);
    const encoder = new TextEncoder();
    const parts = [];
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file_name"\r
\r
`));
    parts.push(encoder.encode(`${fileName}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_type"\r
\r
`));
    parts.push(encoder.encode(`explorer\r
`));
    if (folderToken) {
      parts.push(encoder.encode(`--${boundary}\r
`));
      parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_node"\r
\r
`));
      parts.push(encoder.encode(`${folderToken}\r
`));
    }
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="size"\r
\r
`));
    parts.push(encoder.encode(`${binaryData.length.toString()}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    const fileNameWithoutExt = fileName.replace(/\.[^/.]+$/, "");
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file"; filename="${fileNameWithoutExt}"\r
`));
    parts.push(encoder.encode(`Content-Type: application/octet-stream\r
\r
`));
    parts.push(binaryData);
    parts.push(encoder.encode(`\r
`));
    parts.push(encoder.encode(`--${boundary}--\r
`));
    const totalLength = parts.reduce((sum, part) => sum + part.length, 0);
    const body = new Uint8Array(totalLength);
    let offset = 0;
    for (const part of parts) {
      body.set(part, offset);
      offset += part.length;
    }
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": `multipart/form-data; boundary=${boundary}`
      },
      body: body.buffer
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u4E0A\u4F20\u6587\u4EF6\u5931\u8D25:", result.msg);
        this.debug("[\u98DE\u4E66API] \u4E0A\u4F20\u6587\u4EF6\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      if (!result.data || !result.data.file_token) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11file_token");
        this.debug("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11file_token:", result);
        throw new Error("\u4E0A\u4F20\u6210\u529F\u4F46\u672A\u8FD4\u56DEfile_token");
      }
      return result.data.file_token;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u4E0A\u4F20\u6587\u4EF6\u5230\u98DE\u4E66\u5931\u8D25:", error, {
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 上传图片素材到飞书云文档
   * 使用 drive/v1/medias/upload_all 接口将图片素材上传到指定云文档中
   * @param fileName 图片文件名（需包含扩展名）
   * @param fileContent 图片文件内容（base64编码）
   * @param documentId 目标飞书文档的document_id
   * @param blockId 目标图片块的block_id
   * @returns 返回上传后的文件token
   */
  async uploadImageMaterial(fileName, fileContent, documentId, blockId) {
    var _a;
    const token = await this.getAccessToken();
    const url = `https://open.feishu.cn/open-apis/drive/v1/medias/upload_all`;
    const binaryData = Uint8Array.from(atob(fileContent), (c) => c.charCodeAt(0));
    const boundary = "feishu-image-boundary-" + Math.random().toString(36).substring(2, 15);
    const encoder = new TextEncoder();
    const parts = [];
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file_name"\r
\r
`));
    parts.push(encoder.encode(`${fileName}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_type"\r
\r
`));
    parts.push(encoder.encode(`docx_image\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="parent_node"\r
\r
`));
    parts.push(encoder.encode(`${blockId}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="size"\r
\r
`));
    parts.push(encoder.encode(`${binaryData.length.toString()}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="extra"\r
\r
`));
    const extraData = JSON.stringify({ "drive_route_token": documentId });
    parts.push(encoder.encode(`${extraData}\r
`));
    parts.push(encoder.encode(`--${boundary}\r
`));
    parts.push(encoder.encode(`Content-Disposition: form-data; name="file"; filename="${fileName}"\r
`));
    parts.push(encoder.encode(`Content-Type: application/octet-stream\r
\r
`));
    parts.push(binaryData);
    parts.push(encoder.encode(`\r
`));
    parts.push(encoder.encode(`--${boundary}--\r
`));
    const totalLength = parts.reduce((sum, part) => sum + part.length, 0);
    const body = new Uint8Array(totalLength);
    let offset = 0;
    for (const part of parts) {
      body.set(part, offset);
      offset += part.length;
    }
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": `multipart/form-data; boundary=${boundary}`
      },
      body: body.buffer
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25:", result.msg);
        this.debug("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      if (!result.data || !result.data.file_token) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11file_token");
        this.debug("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11file_token:", result);
        throw new Error("\u4E0A\u4F20\u6210\u529F\u4F46\u672A\u8FD4\u56DEfile_token");
      }
      return result.data.file_token;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5230\u98DE\u4E66\u5931\u8D25:", error, {
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u4E0A\u4F20\u56FE\u7247\u7D20\u6750\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 创建导入任务
   * @param fileName 文件名
   * @param fileToken 文件token（从上传文件接口获取）
   * @param folderToken 目标文件夹token（可选）
   */
  async createImportTask(fileName, fileToken, folderToken) {
    var _a, _b;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/drive/v1/import_tasks`;
    const lastDotIndex = fileName.lastIndexOf(".");
    let pureFileName;
    let fileExtension;
    if (lastDotIndex > 0 && fileName.substring(lastDotIndex + 1).toLowerCase() === "md") {
      pureFileName = fileName.substring(0, lastDotIndex);
      fileExtension = "md";
    } else {
      pureFileName = fileName;
      fileExtension = "md";
    }
    const requestBody = {
      file_extension: fileExtension,
      // Markdown文件扩展名
      file_name: pureFileName,
      // 纯文件名（不含扩展名）
      type: "docx",
      // 导入为飞书文档
      file_token: fileToken
    };
    if (folderToken) {
      requestBody.point = {
        mount_type: 1,
        // 1表示文件夹
        mount_key: folderToken
      };
    }
    const requestParam = {
      url,
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json; charset=utf-8"
      },
      body: JSON.stringify(requestBody)
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code === 0) {
        if (!((_b = result.data) == null ? void 0 : _b.ticket)) {
          console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u6210\u529F\u4F46\u7F3A\u5C11ticket");
          throw new Error("\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u6210\u529F\u4F46\u8FD4\u56DE\u6570\u636E\u4E2D\u7F3A\u5C11ticket");
        }
        return result.data.ticket;
      } else {
        console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25:", result.msg);
        this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25 (\u9519\u8BEF\u7801: ${result.code}): ${result.msg}`);
      }
    } catch (error) {
      const errorMeta = getErrorMeta(error);
      if (errorMeta.status === 400 && errorMeta.json) {
        console.error("[\u98DE\u4E66API] \u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25 (HTTP 400)");
        this.debug("[\u98DE\u4E66API] HTTP 400\u9519\u8BEF\uFF0C\u8BE6\u7EC6\u54CD\u5E94:", {
          status: errorMeta.status,
          responseBody: errorMeta.json,
          headers: errorMeta.headers
        });
        const errorResult = parseErrorResult(errorMeta.json);
        if (errorResult) {
          throw new Error(`\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25 (\u9519\u8BEF\u7801: ${errorResult.code}): ${errorResult.msg}`);
        }
      }
      this.logError("[\u98DE\u4E66API] \u521B\u5EFA\u98DE\u4E66\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25:", error, {
        requestUrl: url,
        hasToken: !!token,
        status: errorMeta.status || "unknown",
        responseBody: errorMeta.json || "no response body"
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 查询导入任务状态
   * @param ticket 任务票据
   */
  async queryImportTask(ticket) {
    var _a;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/drive/v1/import_tasks/${ticket}`;
    const requestParam = {
      url,
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json; charset=utf-8"
      }
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25:", result.msg);
        this.debug("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      let taskResult;
      if (typeof result.data === "object" && result.data !== null && "result" in result.data) {
        taskResult = result.data.result;
      } else if (isImportTaskQueryResponse(result.data)) {
        taskResult = result.data;
      }
      if (!taskResult) {
        throw new Error("\u5BFC\u5165\u4EFB\u52A1\u7ED3\u679C\u4E3A\u7A7A");
      }
      return taskResult;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5F02\u5E38:", error, {
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 等待导入任务完成（支持递增重试间隔）
   * @param ticket 任务票据
   * @param onProgress 进度回调
   * @param maxRetries 最大重试次数（默认5次）
   */
  async waitForImportTask(ticket, onProgress, maxRetries = 5) {
    let retryCount = 0;
    while (retryCount <= maxRetries) {
      try {
        const result = await this.queryImportTask(ticket);
        if (result.job_status === 0) {
          if (!result.token || !result.url) {
            console.error("[\u98DE\u4E66API] \u274C \u5BFC\u5165\u4EFB\u52A1\u5B8C\u6210\u4F46\u7F3A\u5C11\u5FC5\u8981\u4FE1\u606F");
            this.debug("[\u98DE\u4E66API] \u274C \u5BFC\u5165\u4EFB\u52A1\u5B8C\u6210\u4F46\u7F3A\u5C11\u5FC5\u8981\u4FE1\u606F:", result);
            throw new Error("\u5BFC\u5165\u4EFB\u52A1\u5B8C\u6210\u4F46\u672A\u8FD4\u56DE\u6587\u6863\u4FE1\u606F");
          }
          const formattedUrl = this.formatDocumentUrl(result.url, result.token);
          return {
            token: result.token,
            url: formattedUrl
          };
        } else if (result.job_status === 1 || result.job_status === 2) {
          retryCount++;
          onProgress == null ? void 0 : onProgress("\u6587\u6863\u6B63\u5728\u5904\u7406\u4E2D\uFF0C\u8BF7\u7A0D\u5019...");
          if (retryCount > maxRetries) {
            console.error(`[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1\u5904\u7406\u8D85\u65F6\uFF0C\u5DF2\u91CD\u8BD5${maxRetries}\u6B21`);
            throw new Error("\u5BFC\u5165\u4EFB\u52A1\u5904\u7406\u8D85\u65F6\uFF0C\u8BF7\u7A0D\u540E\u624B\u52A8\u68C0\u67E5\u98DE\u4E66\u4E91\u6587\u6863");
          }
          let waitTime = 3e3;
          if (retryCount >= 3) {
            waitTime = 6e3;
          }
          await new Promise((resolve) => setTimeout(resolve, waitTime));
          continue;
        } else {
          console.error("[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1\u72B6\u6001\u672A\u77E5");
          this.debug("[\u98DE\u4E66API] \u5BFC\u5165\u4EFB\u52A1\u72B6\u6001\u672A\u77E5:", {
            job_status: result.job_status,
            job_error_msg: result.job_error_msg,
            fullResult: result
          });
          const errorMsg = result.job_error_msg || `\u672A\u77E5\u7684\u4EFB\u52A1\u72B6\u6001: ${result.job_status}`;
          throw new Error(`\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25: ${errorMsg}`);
        }
      } catch (error) {
        const errorMessage = error instanceof Error ? error.message : String(error);
        if (errorMessage.includes("\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25") || errorMessage.includes("\u5BFC\u5165\u4EFB\u52A1\u5DF2\u63D0\u4EA4")) {
          throw error;
        }
        retryCount++;
        if (retryCount > maxRetries) {
          console.error(`[\u98DE\u4E66API] \u5DF2\u8FBE\u5230\u6700\u5927\u91CD\u8BD5\u6B21\u6570 (${maxRetries})\uFF0C\u505C\u6B62\u91CD\u8BD5`);
          throw error;
        }
        let waitTime = 3e3;
        if (retryCount >= 3) {
          waitTime = 6e3;
        }
        await new Promise((resolve) => setTimeout(resolve, waitTime));
      }
    }
    throw new Error("\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF1A\u5DF2\u8FBE\u5230\u6700\u5927\u91CD\u8BD5\u6B21\u6570");
  }
  /**
   * 获取文档所有块
   * @param documentId 文档ID
   */
  async getDocumentBlocks(documentId) {
    var _a;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks`;
    const requestParam = {
      url,
      method: "GET",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json; charset=utf-8"
      }
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25:", result.msg);
        this.debug("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
      if (!result.data || !result.data.items) {
        console.error("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11items");
        this.debug("[\u98DE\u4E66API] \u54CD\u5E94\u4E2D\u7F3A\u5C11items:", result);
        throw new Error("\u83B7\u53D6\u6210\u529F\u4F46\u672A\u8FD4\u56DE\u6587\u6863\u5757\u6570\u636E");
      }
      return result.data.items;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25:", error, {
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 更新文档块
   * @param documentId 文档ID
   * @param blockId 块ID
   * @param imageToken 图片token（file_token）
   */
  async updateDocumentBlock(documentId, blockId, imageToken, imageInfo) {
    var _a;
    const token = await this.getAccessToken();
    const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${blockId}?document_revision_id=-1`;
    let width = 800;
    let height = 600;
    if (imageInfo) {
      try {
        if (typeof imageInfo.width === "number" && imageInfo.width > 0 && typeof imageInfo.height === "number" && imageInfo.height > 0) {
          width = imageInfo.width;
          height = imageInfo.height;
        } else if (imageInfo.svgConvertOptions) {
          width = imageInfo.svgConvertOptions.originalWidth * imageInfo.svgConvertOptions.scale;
          height = imageInfo.svgConvertOptions.originalHeight * imageInfo.svgConvertOptions.scale;
          this.debug(`[DEBUG] SVG\u8F6C\u6362\u56FE\u7247\u5C3A\u5BF8: originalWidth=${imageInfo.svgConvertOptions.originalWidth}, originalHeight=${imageInfo.svgConvertOptions.originalHeight}, scale=${imageInfo.svgConvertOptions.scale}, finalWidth=${width}, finalHeight=${height}`);
        } else {
          const dimensions = await this.getImageDimensions(imageInfo.path);
          if (dimensions) {
            width = dimensions.width;
            height = dimensions.height;
          }
        }
        const aspectRatio = width / height;
        let maxWidth;
        let maxHeight;
        this.debug(`[DEBUG] \u98DE\u4E66\u4E0A\u4F20\u524D\u5C3A\u5BF8: width=${width}, height=${height}, aspectRatio=${aspectRatio}`);
        if (aspectRatio > 4) {
          maxWidth = 2400;
          maxHeight = 600;
        } else if (aspectRatio > 2) {
          maxWidth = 2e3;
          maxHeight = 800;
        } else if (aspectRatio < 0.8) {
          maxWidth = 1e3;
          maxHeight = 2500;
        } else {
          maxWidth = 1200;
          maxHeight = 800;
        }
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          this.debug(`[DEBUG] \u9700\u8981\u7F29\u653E: maxWidth=${maxWidth}, maxHeight=${maxHeight}, ratio=${ratio}`);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
          this.debug(`[DEBUG] \u7F29\u653E\u540E\u5C3A\u5BF8: width=${width}, height=${height}`);
        } else {
          this.debug(`[DEBUG] \u65E0\u9700\u7F29\u653E: maxWidth=${maxWidth}, maxHeight=${maxHeight}`);
        }
      } catch (error) {
      }
    }
    const requestBody = {
      replace_image: {
        token: imageToken,
        width,
        height,
        align: 2
      }
    };
    const requestBody_str = JSON.stringify(requestBody);
    const requestParam = {
      url,
      method: "PATCH",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      body: requestBody_str
    };
    try {
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code !== 0) {
        console.error("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25:", result.msg);
        this.debug("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25\uFF0C\u9519\u8BEF\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25:", error, {
        requestUrl: url,
        hasToken: !!token
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 处理文档中的图片（完整流程）
   * @param documentId 文档ID
   * @param imageInfos 图片信息数组
   * @param onProgress 进度回调
   */
  async processImagesInDocument(documentId, imageInfos, onProgress) {
    if (!imageInfos || imageInfos.length === 0) {
      return;
    }
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u83B7\u53D6\u6587\u6863\u7ED3\u6784...");
      const blocks = await this.getDocumentBlocks(documentId);
      const imageBlocks = blocks.filter((block) => block.block_type === 27);
      if (imageBlocks.length === 0) {
        return;
      }
      for (let i = 0; i < imageInfos.length && i < imageBlocks.length; i++) {
        const imageInfo = imageInfos[i];
        const imageBlock = imageBlocks[i];
        if (!imageInfo || !imageBlock) {
          continue;
        }
        onProgress == null ? void 0 : onProgress(`\u6B63\u5728\u5904\u7406\u56FE\u7247 ${i + 1}/${imageInfos.length}: ${imageInfo.fileName}`);
        try {
          const fileResult = await this.readImageFileAsBase64(imageInfo.path);
          if (!fileResult) {
            throw new Error(`\u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247\u6587\u4EF6: ${imageInfo.path}`);
          }
          if (typeof fileResult.width === "number" && fileResult.width > 0 && typeof fileResult.height === "number" && fileResult.height > 0) {
            imageInfo.width = fileResult.width;
            imageInfo.height = fileResult.height;
          }
          if (fileResult.svgConvertOptions) {
            imageInfo.svgConvertOptions = fileResult.svgConvertOptions;
          }
          let uploadFileName = imageInfo.fileName;
          if (SvgConverter.isSvgFile(imageInfo.fileName)) {
            uploadFileName = SvgConverter.generatePngFileName(imageInfo.fileName);
          }
          const fileToken = await this.uploadImageMaterial(
            uploadFileName,
            fileResult.base64,
            documentId,
            imageBlock.block_id
          );
          await this.updateDocumentBlock(
            documentId,
            imageBlock.block_id,
            fileToken,
            imageInfo
          );
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : String(error);
          console.error(`[\u98DE\u4E66API] \u5904\u7406\u56FE\u7247 ${imageInfo.fileName} \u5931\u8D25:`, errorMessage);
          this.debug(`[\u98DE\u4E66API] \u5904\u7406\u56FE\u7247 ${imageInfo.fileName} \u5931\u8D25\u8BE6\u60C5:`, {
            error,
            errorMessage,
            errorStack: error instanceof Error ? error.stack : void 0
          });
          onProgress == null ? void 0 : onProgress(`\u56FE\u7247 ${imageInfo.fileName} \u5904\u7406\u5931\u8D25: ${errorMessage}`);
        }
      }
      onProgress == null ? void 0 : onProgress("\u6240\u6709\u56FE\u7247\u5904\u7406\u5B8C\u6210\uFF01");
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u56FE\u7247\u5904\u7406\u6D41\u7A0B\u5931\u8D25:", error, {
        documentId,
        imageCount: imageInfos.length
      });
      const errorMessage = error instanceof Error ? error.message : String(error);
      throw new Error(`\u56FE\u7247\u5904\u7406\u6D41\u7A0B\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 获取图片尺寸
   * @param imagePath 图片文件路径
   * @returns 图片的宽度和高度
   */
  async getImageDimensions(imagePath) {
    var _a;
    try {
      let fullPath = imagePath;
      if (imagePath.match(/^[A-Za-z]:/) || imagePath.startsWith("/")) {
        const fileName = imagePath.split(/[/\\]/).pop();
        if (fileName) {
          fullPath = fileName;
        }
      } else {
        fullPath = imagePath.replace(/^\.\//, "");
      }
      const file = this.searchImageInVault(fullPath);
      if (!file) {
        console.warn("[\u98DE\u4E66API] \u65E0\u6CD5\u627E\u5230\u56FE\u7247\u6587\u4EF6:", fullPath);
        return null;
      }
      const arrayBuffer = await ((_a = this.app) == null ? void 0 : _a.vault.readBinary(file));
      if (!arrayBuffer) {
        console.warn("[\u98DE\u4E66API] \u65E0\u6CD5\u8BFB\u53D6\u56FE\u7247\u6587\u4EF6\u5185\u5BB9:", fullPath);
        return null;
      }
      return new Promise((resolve) => {
        const blob = new Blob([arrayBuffer]);
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve({ width: img.width, height: img.height });
        };
        img.onerror = () => {
          URL.revokeObjectURL(url);
          console.warn("[\u98DE\u4E66API] \u65E0\u6CD5\u89E3\u6790\u56FE\u7247\u5C3A\u5BF8:", fullPath);
          resolve(null);
        };
        img.src = url;
      });
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u83B7\u53D6\u56FE\u7247\u5C3A\u5BF8\u5931\u8D25:", error, { imagePath });
      return null;
    }
  }
  async getImageDimensionsFromArrayBuffer(arrayBuffer) {
    return new Promise((resolve) => {
      const blob = new Blob([arrayBuffer]);
      const url = URL.createObjectURL(blob);
      const img = new Image();
      img.onload = () => {
        URL.revokeObjectURL(url);
        resolve({ width: img.width, height: img.height });
      };
      img.onerror = () => {
        URL.revokeObjectURL(url);
        resolve(null);
      };
      img.src = url;
    });
  }
  async getPngDimensionsFromBase64(base64) {
    return new Promise((resolve) => {
      const img = new Image();
      img.onload = () => {
        resolve({ width: img.width, height: img.height });
      };
      img.onerror = () => {
        resolve(null);
      };
      img.src = `data:image/png;base64,${base64}`;
    });
  }
  /**
   * 读取本地或远程图片文件并转换为base64
   * @param imagePath 图片文件路径或URL
   * @returns base64编码的图片内容和SVG转换选项（如果是SVG）
   */
  async readImageFileAsBase64(imagePath) {
    var _a;
    try {
      if (imagePath.startsWith("http://") || imagePath.startsWith("https://")) {
        this.debug("[\u98DE\u4E66API] \u68C0\u6D4B\u5230\u8FDC\u7A0B\u56FE\u7247\uFF0C\u5F00\u59CB\u4E0B\u8F7D:", imagePath);
        try {
          const response = await (0, import_obsidian.requestUrl)({ url: imagePath });
          const arrayBuffer = response.arrayBuffer;
          const dimensions = await this.getImageDimensionsFromArrayBuffer(arrayBuffer);
          const uint8Array = new Uint8Array(arrayBuffer);
          const binaryString = Array.from(uint8Array, (byte) => String.fromCharCode(byte)).join("");
          const base64Content = btoa(binaryString);
          const result = { base64: base64Content };
          if (dimensions) {
            result.width = dimensions.width;
            result.height = dimensions.height;
          }
          return result;
        } catch (error) {
          console.error("[\u98DE\u4E66API] \u4E0B\u8F7D\u8FDC\u7A0B\u56FE\u7247\u5931\u8D25:", imagePath, error);
          return null;
        }
      }
      const fileName = imagePath.split(/[/\\]/).pop() || imagePath;
      if (_FeishuApiClient.isMermaidTempImage(fileName)) {
        const cachedData = _FeishuApiClient.getMermaidImageFromCache(fileName);
        if (cachedData) {
          this.debug("[\u98DE\u4E66API] \u4F7F\u7528Mermaid\u7F13\u5B58\u56FE\u7247:", fileName);
          const result = {
            base64: cachedData.base64Data
          };
          if (cachedData.svgConvertOptions) {
            result.svgConvertOptions = cachedData.svgConvertOptions;
          }
          return result;
        } else {
          console.error("[\u98DE\u4E66API] Mermaid\u7F13\u5B58\u56FE\u7247\u672A\u627E\u5230:", fileName);
          return null;
        }
      }
      let fullPath = imagePath;
      if (imagePath.match(/^[A-Za-z]:/) || imagePath.startsWith("/")) {
        const fileName2 = imagePath.split(/[/\\]/).pop();
        if (fileName2) {
          fullPath = fileName2;
        }
      } else {
        fullPath = imagePath.replace(/^\.\//, "");
      }
      const app = this.app;
      if (!app) {
        throw new Error("App \u672A\u521D\u59CB\u5316");
      }
      let file = null;
      const abstractFile = app.vault.getAbstractFileByPath(fullPath);
      if (abstractFile instanceof import_obsidian.TFile) {
        file = abstractFile;
      }
      if (!file) {
        this.debug("[\u98DE\u4E66API] \u76F4\u63A5\u8DEF\u5F84\u672A\u627E\u5230\uFF0C\u5F00\u59CB\u5728vault\u4E2D\u641C\u7D22\u6587\u4EF6:", fullPath);
        file = this.searchImageInVault(fullPath);
      }
      if (!file) {
        console.error("[\u98DE\u4E66API] \u627E\u4E0D\u5230\u56FE\u7247\u6587\u4EF6:", fullPath);
        return null;
      }
      const fileExtension = (_a = file.extension) == null ? void 0 : _a.toLowerCase();
      if (fileExtension === "svg") {
        const svgContent = await app.vault.read(file);
        if (!SvgConverter.isSvgFile(file.name, svgContent)) {
          console.error("[\u98DE\u4E66API] \u65E0\u6548\u7684SVG\u6587\u4EF6:", file.path);
          return null;
        }
        try {
          const options = SvgConverter.getRecommendedOptions(svgContent);
          const pngBase64 = await SvgConverter.convertSvgToPng(svgContent, options);
          const dimensions = await this.getPngDimensionsFromBase64(pngBase64);
          const result = {
            base64: pngBase64,
            svgConvertOptions: {
              originalWidth: options.width || 800,
              originalHeight: options.height || 600,
              scale: options.scale || 4
            }
          };
          if (dimensions) {
            result.width = dimensions.width;
            result.height = dimensions.height;
          }
          return result;
        } catch (error) {
          this.logError("[\u98DE\u4E66API] SVG\u8F6CPNG\u5931\u8D25:", error, {
            path: file.path
          });
          return null;
        }
      } else {
        const arrayBuffer = await app.vault.readBinary(file);
        const dimensions = await this.getImageDimensionsFromArrayBuffer(arrayBuffer);
        const uint8Array = new Uint8Array(arrayBuffer);
        const binaryString = Array.from(uint8Array, (byte) => String.fromCharCode(byte)).join("");
        const base64Content = btoa(binaryString);
        const result = { base64: base64Content };
        if (dimensions) {
          result.width = dimensions.width;
          result.height = dimensions.height;
        }
        return result;
      }
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u8BFB\u53D6\u56FE\u7247\u6587\u4EF6\u5931\u8D25:", error, {
        path: imagePath
      });
      return null;
    }
  }
  /**
   * 在整个vault中搜索图片文件
   * @param fileName 文件名或路径
   * @returns 找到的文件对象
   */
  searchImageInVault(fileName) {
    var _a;
    if (!((_a = this.app) == null ? void 0 : _a.vault)) {
      return null;
    }
    const targetFileName = fileName.split(/[/\\]/).pop();
    if (!targetFileName) {
      return null;
    }
    const allFiles = this.app.vault.getFiles();
    const imageExtensions = [".jpg", ".jpeg", ".png", ".gif", ".bmp", ".webp", ".svg"];
    for (const file of allFiles) {
      const hasImageExtension = imageExtensions.some(
        (ext) => file.extension.toLowerCase() === ext.substring(1)
      );
      if (!hasImageExtension) {
        continue;
      }
      if (file.name === targetFileName || file.path === fileName) {
        return file;
      }
      if (!targetFileName.includes(".")) {
        const fileBaseName = file.name.substring(0, file.name.lastIndexOf("."));
        if (fileBaseName === targetFileName) {
          return file;
        }
      }
    }
    return null;
  }
  /**
   * 转换Obsidian图片语法为标准Markdown语法
   * @param markdownContent 包含Obsidian图片语法的Markdown内容
   * @returns 转换后的标准Markdown内容
   */
  static convertObsidianImageSyntax(markdownContent) {
    const obsidianImageRegex = /!\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g;
    let convertedContent = markdownContent;
    let match;
    let convertCount = 0;
    obsidianImageRegex.lastIndex = 0;
    while ((match = obsidianImageRegex.exec(markdownContent)) !== null) {
      const fileName = match[1];
      if (!fileName)
        continue;
      const altText = match[2] || fileName;
      const obsidianSyntax = match[0];
      const encodedFileName = encodeURI(fileName);
      const standardSyntax = `![${altText}](${encodedFileName})`;
      convertedContent = convertedContent.replace(obsidianSyntax, standardSyntax);
      convertCount++;
    }
    return convertedContent;
  }
  /**
   * 提取Markdown中的图片信息
   * @param markdownContent Markdown内容
   * @param basePath 基础路径（用于解析相对路径）
   */
  static extractImageInfoFromMarkdown(markdownContent, basePath) {
    const imageInfos = [];
    const convertedContent = _FeishuApiClient.convertObsidianImageSyntax(markdownContent);
    const markdownImageRegex = /!\[([^\]]*)\]\(([^)\s]+)(?:\s+"([^"]*)")?\)/g;
    let match;
    let position = 0;
    while ((match = markdownImageRegex.exec(convertedContent)) !== null) {
      const alt = match[1];
      const path = match[2];
      const title = match[3];
      if (!path)
        continue;
      const decodedPath = decodeURI(path);
      const fileName = decodedPath.split("/").pop() || decodedPath;
      const fullPath = basePath && !decodedPath.startsWith("http") ? `${basePath}/${decodedPath}` : decodedPath;
      imageInfos.push({
        path: fullPath,
        fileName,
        position: position++
      });
    }
    return imageInfos;
  }
  static encodeBase64Utf8(content) {
    const encoder = new TextEncoder();
    const bytes = encoder.encode(content);
    let binary = "";
    for (const byte of bytes) {
      binary += String.fromCharCode(byte);
    }
    return btoa(binary);
  }
  /**
   * 直接上传文件到飞书云盘
   * @param fileName 文件名
   * @param markdownContent Markdown内容
   * @param documentId 目标文档ID（可选）
   * @param onProgress 进度回调
   */
  async uploadFileDirectly(fileName, markdownContent, documentId, onProgress) {
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u5185\u5BB9...");
      const convertedContent = _FeishuApiClient.convertObsidianImageSyntax(markdownContent);
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u4E0A\u4F20\u6587\u4EF6...");
      const fileContent = _FeishuApiClient.encodeBase64Utf8(convertedContent);
      const fileToken = await this.uploadFile(fileName, fileContent, documentId || "");
      onProgress == null ? void 0 : onProgress("\u4E0A\u4F20\u5B8C\u6210\uFF01");
      const fileUrl = `https://open.feishu.cn/open-apis/drive/v1/files/${fileToken}`;
      return {
        token: fileToken,
        url: fileUrl
      };
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u76F4\u63A5\u4E0A\u4F20\u6587\u4EF6\u5931\u8D25:", error, { fileName, documentId });
      throw error;
    }
  }
  /**
   * 完整的文档上传流程（通过导入任务）- 带预处理图片信息
   * @param fileName 文件名
   * @param markdownContent Markdown内容
   * @param documentId 目标文档ID（可选）
   * @param onProgress 进度回调
   * @param preProcessedImageInfos 预处理的图片信息（按正确顺序）
   */
  async uploadDocumentWithImageInfos(fileName, markdownContent, documentId, onProgress, preProcessedImageInfos) {
    var _a, _b;
    let mdFileToken = null;
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u5185\u5BB9...");
      const convertedContent = _FeishuApiClient.convertObsidianImageSyntax(markdownContent);
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u4E0A\u4F20\u6587\u4EF6\u5230\u4E91\u7A7A\u95F4...");
      const fileContent = _FeishuApiClient.encodeBase64Utf8(convertedContent);
      mdFileToken = await this.uploadFile(fileName, fileContent, documentId || "");
      onProgress == null ? void 0 : onProgress("\u6587\u4EF6\u5DF2\u4E0A\u4F20\uFF0C\u6B63\u5728\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1...");
      const ticket = await this.createImportTask(fileName, mdFileToken, documentId || "");
      onProgress == null ? void 0 : onProgress("\u4EFB\u52A1\u5DF2\u521B\u5EFA\uFF0C\u6B63\u5728\u5904\u7406...");
      await new Promise((resolve) => setTimeout(resolve, 3e3));
      onProgress == null ? void 0 : onProgress("\u5F00\u59CB\u67E5\u8BE2\u5904\u7406\u72B6\u6001...");
      const result = await this.waitForImportTask(ticket, onProgress);
      let imageInfos;
      if (preProcessedImageInfos && preProcessedImageInfos.length > 0) {
        imageInfos = preProcessedImageInfos;
      } else {
        const adapter = (_b = (_a = this.app) == null ? void 0 : _a.vault) == null ? void 0 : _b.adapter;
        const basePath = getAdapterBasePath(adapter);
        imageInfos = _FeishuApiClient.extractImageInfoFromMarkdown(markdownContent, basePath);
      }
      if (imageInfos.length > 0) {
        onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u4E2D\u7684\u56FE\u7247...");
        await this.processImagesInDocument(result.token, imageInfos, onProgress);
      }
      if (mdFileToken) {
        try {
          this.debug("[\u98DE\u4E66API] \u5F00\u59CB\u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\uFF0Cfile_token:", mdFileToken);
          await this.deleteFile(mdFileToken, "file");
          this.debug("[\u98DE\u4E66API] \u4E34\u65F6MD\u6587\u4EF6\u5DF2\u6E05\u7406");
        } catch (deleteError) {
          console.warn("[\u98DE\u4E66API] \u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\u5931\u8D25\uFF08\u4E0D\u5F71\u54CD\u4E3B\u529F\u80FD\uFF09:", deleteError);
        }
      }
      onProgress == null ? void 0 : onProgress("\u4E0A\u4F20\u5B8C\u6210\uFF01");
      return result;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66API] \u6587\u6863\u4E0A\u4F20\u5931\u8D25: ${errorMessage}`);
      this.debug("[\u98DE\u4E66API] \u6587\u6863\u4E0A\u4F20\u5931\u8D25\u8BE6\u60C5:", {
        error,
        errorMessage,
        fileName,
        documentId
      });
      if (mdFileToken) {
        try {
          this.debug("[\u98DE\u4E66API] \u4E0A\u4F20\u5931\u8D25\uFF0C\u5F00\u59CB\u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\uFF0Cfile_token:", mdFileToken);
          await this.deleteFile(mdFileToken, "file");
          this.debug("[\u98DE\u4E66API] \u4E34\u65F6MD\u6587\u4EF6\u5DF2\u6E05\u7406");
        } catch (deleteError) {
          console.warn("[\u98DE\u4E66API] \u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\u5931\u8D25:", deleteError);
        }
      }
      throw new Error(`\u6587\u6863\u4E0A\u4F20\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 完整的文档上传流程（通过导入任务）
   * @param fileName 文件名
   * @param markdownContent Markdown内容
   * @param documentId 目标文档ID（可选）
   * @param onProgress 进度回调
   */
  async uploadDocument(fileName, markdownContent, documentId, onProgress) {
    var _a, _b;
    let mdFileToken = null;
    try {
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u5185\u5BB9...");
      const convertedContent = _FeishuApiClient.convertObsidianImageSyntax(markdownContent);
      onProgress == null ? void 0 : onProgress("\u6B63\u5728\u4E0A\u4F20\u6587\u4EF6\u5230\u4E91\u7A7A\u95F4...");
      const fileContent = _FeishuApiClient.encodeBase64Utf8(convertedContent);
      mdFileToken = await this.uploadFile(fileName, fileContent, documentId || "");
      onProgress == null ? void 0 : onProgress("\u6587\u4EF6\u5DF2\u4E0A\u4F20\uFF0C\u6B63\u5728\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1...");
      const ticket = await this.createImportTask(fileName, mdFileToken, documentId || "");
      onProgress == null ? void 0 : onProgress("\u4EFB\u52A1\u5DF2\u521B\u5EFA\uFF0C\u6B63\u5728\u5904\u7406...");
      await new Promise((resolve) => setTimeout(resolve, 3e3));
      onProgress == null ? void 0 : onProgress("\u5F00\u59CB\u67E5\u8BE2\u5904\u7406\u72B6\u6001...");
      const result = await this.waitForImportTask(ticket, onProgress);
      const adapter = (_b = (_a = this.app) == null ? void 0 : _a.vault) == null ? void 0 : _b.adapter;
      const basePath = getAdapterBasePath(adapter);
      const imageInfos = _FeishuApiClient.extractImageInfoFromMarkdown(markdownContent, basePath);
      if (imageInfos.length > 0) {
        onProgress == null ? void 0 : onProgress("\u6B63\u5728\u5904\u7406\u6587\u6863\u4E2D\u7684\u56FE\u7247...");
        await this.processImagesInDocument(result.token, imageInfos, onProgress);
      }
      if (mdFileToken) {
        try {
          this.debug("[\u98DE\u4E66API] \u5F00\u59CB\u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\uFF0Cfile_token:", mdFileToken);
          await this.deleteFile(mdFileToken, "file");
          this.debug("[\u98DE\u4E66API] \u4E34\u65F6MD\u6587\u4EF6\u5DF2\u6E05\u7406");
        } catch (deleteError) {
          console.warn("[\u98DE\u4E66API] \u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\u5931\u8D25\uFF08\u4E0D\u5F71\u54CD\u4E3B\u529F\u80FD\uFF09:", deleteError);
        }
      }
      onProgress == null ? void 0 : onProgress("\u4E0A\u4F20\u5B8C\u6210\uFF01");
      return result;
    } catch (error) {
      if (mdFileToken) {
        try {
          this.debug("[\u98DE\u4E66API] \u4E3B\u6D41\u7A0B\u5931\u8D25\uFF0C\u5C1D\u8BD5\u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6");
          await this.deleteFile(mdFileToken, "file");
        } catch (deleteError) {
          console.warn("[\u98DE\u4E66API] \u6E05\u7406\u4E34\u65F6MD\u6587\u4EF6\u5931\u8D25:", deleteError);
        }
      }
      this.logError("[\u98DE\u4E66API] \u4E0A\u4F20\u6587\u6863\u5931\u8D25:", error, { fileName, documentId });
      throw error;
    }
  }
  /**
   * 测试API连接
   */
  async testConnection() {
    try {
      await this.getAccessToken();
      return true;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u6D4B\u8BD5\u98DE\u4E66API\u8FDE\u63A5\u5931\u8D25:", error);
      return false;
    }
  }
  /**
   * 格式化飞书文档URL
   * @param url 原始URL
   * @param token 文档token
   */
  formatDocumentUrl(url, token) {
    try {
      if (url.startsWith("https://") && (url.includes("feishu.cn") || url.includes("larkoffice.com"))) {
        return url;
      }
      if (!url.startsWith("http")) {
        const formattedUrl = `https://open.feishu.cn/document/${token}`;
        return formattedUrl;
      }
      return url;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] URL\u683C\u5F0F\u5316\u5931\u8D25:", error, { url, token });
      return url;
    }
  }
  /**
   * 转移文档所有权给用户
   * @param docToken 文档token
   * @param userId 用户ID
   */
  async transferDocumentOwnership(docToken, userId) {
    var _a;
    const token = await this.getAccessToken();
    this.debug("[\u98DE\u4E66API] \u8F6C\u79FB\u6587\u6863\u6240\u6709\u6743:", {
      docToken,
      userId
    });
    try {
      const transferUrl = `${this.baseUrl}/drive/v1/permissions/${docToken}/members/transfer_owner?need_notification=false&old_owner_perm=full_access&remove_old_owner=false&stay_put=true&type=docx`;
      const requestBody = {
        member_id: userId,
        member_type: "userid"
      };
      const requestParam = {
        url: transferUrl,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code === 0) {
        return true;
      } else {
        console.error(`[\u98DE\u4E66API] \u274C \u6587\u6863\u6240\u6709\u6743\u8F6C\u79FB\u5931\u8D25: [${result.code}] ${result.msg}`);
        this.debug("[\u98DE\u4E66API] \u274C \u6587\u6863\u6240\u6709\u6743\u8F6C\u79FB\u5931\u8D25\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u8F6C\u79FB\u6587\u6863\u6240\u6709\u6743\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
    } catch (error) {
      const errorMeta = getErrorMeta(error);
      this.logError("[\u98DE\u4E66API] \u274C \u6240\u6709\u6743\u8F6C\u79FB\u5F02\u5E38:", error, {
        status: errorMeta.status,
        statusText: errorMeta.statusText,
        response: errorMeta.response,
        json: errorMeta.json
      });
      throw error;
    }
  }
  /**
   * 设置文档权限
   * @param docToken 文档token
   * @param permissions 权限设置
   * @param userId 用户ID（用于所有权转移）
   */
  async setDocumentPermissions(docToken, permissions, userId) {
    const token = await this.getAccessToken();
    try {
      if (userId) {
        await this.transferDocumentOwnership(docToken, userId);
        await new Promise((resolve) => setTimeout(resolve, 1e3));
      }
      const requestBody = {
        external_access_entity: "open"
      };
      if (permissions.isPublic) {
        requestBody.link_share_entity = "anyone_readable";
      }
      if (permissions.copyEntity) {
        requestBody.copy_entity = permissions.copyEntity;
      } else if (permissions.allowCopy) {
        requestBody.copy_entity = "anyone_can_view";
      }
      if (permissions.securityEntity) {
        requestBody.security_entity = permissions.securityEntity;
      } else if (permissions.allowCreateCopy || permissions.allowPrintDownload) {
        requestBody.security_entity = "anyone_can_view";
      }
      const publicUrl = `${this.baseUrl}/drive/v2/permissions/${docToken}/public?type=docx`;
      await this.executePermissionRequest(publicUrl, token, requestBody, "\u6743\u9650\u8BBE\u7F6E");
      return true;
    } catch (error) {
      const errorMeta = getErrorMeta(error);
      this.logError("[\u98DE\u4E66API] \u274C \u6743\u9650\u8BBE\u7F6E\u5931\u8D25:", error, {
        status: errorMeta.status,
        statusText: errorMeta.statusText,
        response: errorMeta.response,
        json: errorMeta.json
      });
      throw error;
    }
  }
  /**
   * 仅更新文档权限（不包含所有权转移）
   * @param docToken 文档token
   * @param permissions 权限设置
   */
  async updateDocumentPermissionsOnly(docToken, permissions) {
    const token = await this.getAccessToken();
    try {
      const requestBody = {
        external_access_entity: "open"
      };
      if (permissions.isPublic) {
        requestBody.link_share_entity = "anyone_readable";
      }
      if (permissions.copyEntity) {
        requestBody.copy_entity = permissions.copyEntity;
      } else if (permissions.allowCopy) {
        requestBody.copy_entity = "anyone_can_view";
      }
      if (permissions.securityEntity) {
        requestBody.security_entity = permissions.securityEntity;
      } else if (permissions.allowCreateCopy || permissions.allowPrintDownload) {
        requestBody.security_entity = "anyone_can_view";
      }
      const publicUrl = `${this.baseUrl}/drive/v2/permissions/${docToken}/public?type=docx`;
      await this.executePermissionRequest(publicUrl, token, requestBody, "\u6743\u9650\u8BBE\u7F6E\uFF08\u65E0\u6240\u6709\u6743\u8F6C\u79FB\uFF09");
      return true;
    } catch (error) {
      const errorMeta = getErrorMeta(error);
      this.logError("[\u98DE\u4E66API] \u274C \u6743\u9650\u8BBE\u7F6E\u5931\u8D25\uFF08\u65E0\u6240\u6709\u6743\u8F6C\u79FB\uFF09:", error, {
        status: errorMeta.status,
        statusText: errorMeta.statusText,
        response: errorMeta.response,
        json: errorMeta.json
      });
      throw error;
    }
  }
  /**
   * 执行权限设置请求（带重试机制）
   */
  async executePermissionRequest(url, token, requestBody, stepName) {
    var _a;
    let retryCount = 0;
    const maxRetries = 3;
    const retryDelay = 1e4;
    while (retryCount <= maxRetries) {
      try {
        const requestParam = {
          url,
          method: "PATCH",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json; charset=utf-8"
          },
          body: JSON.stringify(requestBody)
        };
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
        const result = response.json;
        if (result.code === 0) {
          return;
        } else {
          console.error(`[\u98DE\u4E66API] \u274C ${stepName}\u5931\u8D25: [${result.code}] ${result.msg}`);
          this.debug(`[\u98DE\u4E66API] \u274C ${stepName}\u5931\u8D25\u8BE6\u60C5:`, {
            code: result.code,
            msg: result.msg,
            fullResult: result
          });
          throw new Error(`${stepName}\u5931\u8D25: [${result.code}] ${result.msg}`);
        }
      } catch (error) {
        const errorMeta = getErrorMeta(error);
        this.logError(`[\u98DE\u4E66API] \u274C ${stepName}\u7B2C${retryCount + 1}\u6B21\u8BF7\u6C42\u5F02\u5E38:`, error, {
          status: errorMeta.status,
          statusText: errorMeta.statusText,
          response: errorMeta.response,
          json: errorMeta.json,
          retryCount,
          maxRetries
        });
        if (errorMeta.status === 500 && retryCount < maxRetries) {
          retryCount++;
          console.warn(`[\u98DE\u4E66API] \u26A0\uFE0F ${stepName}\u9047\u5230500\u9519\u8BEF\uFF0C${retryDelay / 1e3}\u79D2\u540E\u8FDB\u884C\u7B2C${retryCount + 1}\u6B21\u91CD\u8BD5...`);
          await new Promise((resolve) => setTimeout(resolve, retryDelay));
          continue;
        } else {
          this.logError(`[\u98DE\u4E66API] \u274C ${stepName}\u6700\u7EC8\u5931\u8D25:`, error, {
            status: errorMeta.status,
            statusText: errorMeta.statusText,
            response: errorMeta.response,
            json: errorMeta.json,
            retryCount,
            maxRetries
          });
          throw error;
        }
      }
    }
    if (retryCount > maxRetries) {
      throw new Error(`${stepName}\u5931\u8D25\uFF1A\u670D\u52A1\u5668\u9519\u8BEF\uFF0C\u5DF2\u91CD\u8BD53\u6B21\u4ECD\u65E0\u6CD5\u5B8C\u6210`);
    }
  }
  /**
   * 更新应用凭证
   */
  /**
   * 删除文件
   * @param docToken 文档token
   * @param fileType 文件类型
   */
  async deleteFile(docToken, fileType = "docx") {
    var _a;
    const token = await this.getAccessToken();
    try {
      const deleteUrl = `${this.baseUrl}/drive/v1/files/${docToken}?type=${fileType}`;
      const requestParam = {
        url: deleteUrl,
        method: "DELETE",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json; charset=utf-8"
        }
      };
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      (_a = this.apiCallCountCallback) == null ? void 0 : _a.call(this);
      const result = response.json;
      if (result.code === 0) {
        return true;
      } else {
        console.error(`[\u98DE\u4E66API] \u274C \u6587\u4EF6\u5220\u9664\u5931\u8D25: [${result.code}] ${result.msg}`);
        this.debug("[\u98DE\u4E66API] \u274C \u6587\u4EF6\u5220\u9664\u5931\u8D25\u8BE6\u60C5:", {
          code: result.code,
          msg: result.msg,
          fullResult: result
        });
        throw new Error(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: [${result.code}] ${result.msg}`);
      }
    } catch (error) {
      const errorMeta = getErrorMeta(error);
      this.logError("[\u98DE\u4E66API] \u274C \u5220\u9664\u6587\u4EF6\u5F02\u5E38:", error, {
        status: errorMeta.status,
        statusText: errorMeta.statusText,
        response: errorMeta.response,
        json: errorMeta.json
      });
      throw error;
    }
  }
  updateCredentials(appId, appSecret) {
    this.appId = appId;
    this.appSecret = appSecret;
    this.accessToken = null;
    this.tokenExpireTime = 0;
  }
  /**
   * 添加Mermaid图片到缓存
   * @param fileName 文件名
   * @param base64Data base64图片数据
   * @param svgConvertOptions SVG转换选项（包含原始尺寸信息）
   */
  static addMermaidImageToCache(fileName, base64Data, svgConvertOptions) {
    const cacheData = { base64Data };
    if (svgConvertOptions) {
      cacheData.svgConvertOptions = svgConvertOptions;
    }
    this.mermaidImageCache.set(fileName, cacheData);
  }
  /**
   * 从缓存获取Mermaid图片
   * @param fileName 文件名
   * @returns 缓存的图片信息（包含base64数据和转换选项）
   */
  static getMermaidImageFromCache(fileName) {
    return this.mermaidImageCache.get(fileName);
  }
  /**
   * 清除Mermaid图片缓存
   */
  static clearMermaidImageCache() {
    this.mermaidImageCache.clear();
  }
  /**
   * 检查是否为Mermaid临时图片
   * @param fileName 文件名
   * @returns 是否为Mermaid临时图片
   */
  static isMermaidTempImage(fileName) {
    return fileName.startsWith("temp_mermaid-") || this.mermaidImageCache.has(fileName);
  }
  /**
   * 获取文档所有块的详细信息（支持 Callout 转换）
   * @param documentId 文档ID
   * @returns 文档块数组（包含完整的块信息）
   */
  async getDocumentBlocksDetailed(documentId) {
    try {
      const token = await this.getAccessToken();
      const allBlocks = [];
      let pageToken;
      let hasMore = true;
      while (hasMore) {
        const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks`;
        const params = {
          page_size: "500",
          user_id_type: "user_id"
        };
        if (pageToken) {
          params["page_token"] = pageToken;
        }
        const requestParam = {
          url: url + "?" + new URLSearchParams(params).toString(),
          method: "GET",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          }
        };
        if (this.apiCallCountCallback) {
          this.apiCallCountCallback();
        }
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        const result = response.json;
        if (result.code !== 0) {
          throw new Error(`\u83B7\u53D6\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
        }
        allBlocks.push(...result.data.items);
        hasMore = result.data.has_more;
        pageToken = result.data.page_token;
      }
      return allBlocks;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u83B7\u53D6\u6587\u6863\u5757\u8BE6\u7EC6\u4FE1\u606F\u5931\u8D25:", error, { documentId });
      throw error;
    }
  }
  /**
   * 批量更新文档块（支持 Callout 转换）
   * @param documentId 文档ID
   * @param requests 批量更新请求数组
   * @returns 更新结果
   */
  async batchUpdateDocumentBlocks(documentId, requests) {
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/batch_update?document_revision_id=-1`;
      const requestBody = {
        requests
      };
      const requestParam = {
        url,
        method: "PATCH",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      this.debug("[\u98DE\u4E66API] \u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757:", {
        documentId,
        requestCount: requests.length,
        requests: requests.map((req) => ({
          hasInsertBlock: !!req.insert_block,
          hasUpdateTextElements: !!req.update_text_elements,
          hasMergeTableCells: !!req.merge_table_cells,
          hasReplaceImage: !!req.replace_image,
          blockId: req.block_id,
          parentId: req.parent_id,
          index: req.index
        }))
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      if (result.code !== 0) {
        throw new Error(`\u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
      }
      this.debug("[\u98DE\u4E66API] \u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757\u6210\u529F:", {
        documentId,
        updatedCount: requests.length,
        result: result.data
      });
      return result.data;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u6279\u91CF\u66F4\u65B0\u6587\u6863\u5757\u5931\u8D25:", error, {
        documentId,
        requestCount: requests.length
      });
      throw error;
    }
  }
  /**
   * 创建文档块
   * @param documentId 文档ID
   * @param parentId 父块ID
   * @param index 插入位置索引
   * @param children 要创建的子块数组
   * @returns 创建结果
   */
  async createDocumentBlocks(documentId, parentId, index, children) {
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/children?document_revision_id=-1`;
      const requestBody = {
        index,
        children
      };
      const requestParam = {
        url,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757:", {
        documentId,
        parentId,
        index,
        childrenCount: children.length,
        requestBody
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u539F\u59CB\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        body: result
      });
      if (result.code !== 0) {
        const errorDetails = {
          code: result.code,
          msg: result.msg,
          data: result.data,
          httpStatus: response.status,
          requestUrl: url,
          requestBody
        };
        console.error(`[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u5931\u8D25: [${result.code}] ${result.msg}`);
        this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u8BE6\u7EC6\u9519\u8BEF\u4FE1\u606F:", errorDetails);
        throw new Error(`\u521B\u5EFA\u6587\u6863\u5757\u5931\u8D25: ${result.msg} (code: ${result.code})`);
      }
      this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u6210\u529F:", {
        documentId,
        parentId,
        index,
        result: result.data
      });
      return result.data;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u521B\u5EFA\u6587\u6863\u5757\u5931\u8D25:", error, {
        documentId,
        parentId,
        index,
        childrenCount: children.length,
        requestUrl: `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/children?document_revision_id=-1`,
        requestBody: {
          index,
          children
        }
      });
      throw error;
    }
  }
  /**
   * 创建嵌套文档块（使用descendant API）
   * @param documentId 文档ID
   * @param parentId 父块ID
   * @param index 插入位置索引
   * @param childrenIds 子块ID数组
   * @param descendants 嵌套块定义数组
   * @returns 创建结果
   */
  async createDocumentDescendants(documentId, parentId, index, childrenIds, descendants) {
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/descendant?document_revision_id=-1`;
      const requestBody = {
        children_id: childrenIds,
        descendants,
        index
      };
      const requestParam = {
        url,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757:", {
        documentId,
        parentId,
        index,
        childrenIds,
        descendantsCount: descendants.length,
        requestBody
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u539F\u59CB\u54CD\u5E94:", {
        status: response.status,
        headers: response.headers,
        body: result
      });
      if (result.code !== 0) {
        const errorDetails = {
          code: result.code,
          msg: result.msg,
          data: result.data,
          httpStatus: response.status,
          requestUrl: url,
          requestBody
        };
        console.error(`[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u5931\u8D25: [${result.code}] ${result.msg}`);
        this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u8BE6\u7EC6\u9519\u8BEF\u4FE1\u606F:", errorDetails);
        throw new Error(`\u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u5931\u8D25: ${result.msg} (code: ${result.code})`);
      }
      this.debug("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u6210\u529F:", {
        documentId,
        parentId,
        index,
        result: result.data
      });
      return result.data;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u521B\u5EFA\u5D4C\u5957\u6587\u6863\u5757\u5931\u8D25:", error, {
        documentId,
        parentId,
        index,
        childrenIds,
        descendantsCount: descendants.length,
        requestUrl: `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/descendant?document_revision_id=-1`,
        requestBody: {
          children_id: childrenIds,
          descendants,
          index
        }
      });
      throw error;
    }
  }
  /**
   * 批量删除多个文档块
   * @param documentId 文档ID
   * @param parentId 父块ID
   * @param blockIds 要删除的块ID数组
   * @returns 删除结果
   */
  async batchDeleteDocumentBlocks(documentId, parentId, startIndex, endIndex) {
    return this.queueDeleteRequest(async () => {
      try {
        const token = await this.getAccessToken();
        const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId}/children/batch_delete?document_revision_id=-1`;
        const deleteBody = {
          start_index: startIndex,
          end_index: endIndex
        };
        const requestParam = {
          url,
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(deleteBody)
        };
        this.debug("[\u98DE\u4E66API] \u6279\u91CF\u5220\u9664\u6587\u6863\u5757:", {
          documentId,
          parentId,
          startIndex,
          endIndex,
          deleteCount: endIndex - startIndex,
          // 左闭右开区间: [start, end)
          deleteBody
        });
        if (this.apiCallCountCallback) {
          this.apiCallCountCallback();
        }
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        const result = response.json;
        if (result.code !== 0) {
          throw new Error(`\u6279\u91CF\u5220\u9664\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
        }
        this.debug("[\u98DE\u4E66API] \u6279\u91CF\u5220\u9664\u6587\u6863\u5757\u6210\u529F:", {
          documentId,
          parentId,
          startIndex,
          endIndex,
          deletedCount: endIndex - startIndex,
          // 左闭右开区间: [start, end)
          result: result.data
        });
        return result.data;
      } catch (error) {
        this.logError("[\u98DE\u4E66API] \u6279\u91CF\u5220\u9664\u6587\u6863\u5757\u5931\u8D25:", error, {
          documentId,
          parentId,
          startIndex,
          endIndex
        });
        throw error;
      }
    });
  }
  /**
   * 删除文档块
   * @param documentId 文档ID
   * @param blockId 块ID
   * @returns 删除结果
   */
  async deleteDocumentBlock(documentId, blockId, parentId, index) {
    return this.queueDeleteRequest(async () => {
      try {
        const token = await this.getAccessToken();
        const url = `${this.baseUrl}/docx/v1/documents/${documentId}/blocks/${parentId || blockId}/children/batch_delete?document_revision_id=-1`;
        const deleteBody = index !== void 0 ? {
          start_index: index,
          end_index: index + 1
        } : {
          block_ids: [blockId]
        };
        const requestParam = {
          url,
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(deleteBody)
        };
        this.debug("[\u98DE\u4E66API] \u5220\u9664\u6587\u6863\u5757:", {
          documentId,
          blockId,
          parentId,
          index,
          deleteMethod: index !== void 0 ? "by_index" : "by_block_id",
          deleteBody
        });
        if (this.apiCallCountCallback) {
          this.apiCallCountCallback();
        }
        const response = await (0, import_obsidian.requestUrl)(requestParam);
        const result = response.json;
        if (result.code !== 0) {
          throw new Error(`\u5220\u9664\u6587\u6863\u5757\u5931\u8D25: ${result.msg}`);
        }
        this.debug("[\u98DE\u4E66API] \u5220\u9664\u6587\u6863\u5757\u6210\u529F:", {
          documentId,
          blockId,
          result: result.data
        });
        return result.data;
      } catch (error) {
        this.logError("[\u98DE\u4E66API] \u5220\u9664\u6587\u6863\u5757\u5931\u8D25:", error, { documentId, blockId, parentId, index });
        throw error;
      }
    });
  }
  /**
   * 转换 Markdown 为文档块（支持 Callout 检测）
   * @param content Markdown 内容
   * @returns 转换结果
   */
  async convertMarkdownToBlocks(content) {
    var _a, _b;
    try {
      const token = await this.getAccessToken();
      const url = `${this.baseUrl}/docx/v1/documents/blocks/convert`;
      const requestBody = {
        content_type: "markdown",
        content
      };
      const requestParam = {
        url,
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(requestBody)
      };
      this.debug("[\u98DE\u4E66API] \u8F6C\u6362 Markdown \u4E3A\u6587\u6863\u5757:", {
        contentLength: content.length,
        contentPreview: content.substring(0, 100) + (content.length > 100 ? "..." : "")
      });
      if (this.apiCallCountCallback) {
        this.apiCallCountCallback();
      }
      const response = await (0, import_obsidian.requestUrl)(requestParam);
      const result = response.json;
      if (result.code !== 0) {
        throw new Error(`\u8F6C\u6362 Markdown \u5931\u8D25: ${result.msg}`);
      }
      this.debug("[\u98DE\u4E66API] \u8F6C\u6362 Markdown \u6210\u529F:", {
        blocksCount: ((_b = (_a = result.data) == null ? void 0 : _a.blocks) == null ? void 0 : _b.length) || 0
      });
      return result.data;
    } catch (error) {
      this.logError("[\u98DE\u4E66API] \u8F6C\u6362 Markdown \u5931\u8D25:", error, { contentLength: content.length });
      throw error;
    }
  }
};
var FeishuApiClient = _FeishuApiClient;
// 防止并发token获取
FeishuApiClient.debugEnabled = false;
// Mermaid图片缓存，用于存储临时生成的图片数据
FeishuApiClient.mermaidImageCache = /* @__PURE__ */ new Map();
function createFeishuClient(appId, appSecret, app, apiCallCountCallback) {
  return new FeishuApiClient(appId, appSecret, app, apiCallCountCallback);
}

// crypto-utils.ts
var import_obsidian2 = require("obsidian");
var _CryptoUtils = class {
  static setDebugEnabled(enabled) {
    this.debugEnabled = enabled;
  }
  static debug(...args) {
    if (this.debugEnabled) {
      console.debug(...args);
    }
  }
  static logError(summary, error, details) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(summary, errorMessage);
    this.debug(`${summary} \u8BE6\u60C5:`, {
      ...details,
      error,
      errorMessage,
      errorStack: error instanceof Error ? error.stack : void 0
    });
  }
  /**
   * 获取缓存的加密密钥，如果不存在则生成新的
   */
  static async getEncryptionKey() {
    if (this.encryptionKey) {
      return this.encryptionKey;
    }
    this.encryptionKey = await this.generateDeviceKey();
    return this.encryptionKey;
  }
  /**
   * 生成基于设备特征的固定密钥
   * 使用设备的硬件和系统信息生成唯一且稳定的密钥
   */
  static async generateDeviceKey() {
    const platformLabel = import_obsidian2.Platform.isMacOS ? "macos" : import_obsidian2.Platform.isWin ? "windows" : import_obsidian2.Platform.isLinux ? "linux" : import_obsidian2.Platform.isMobile ? "mobile" : "unknown";
    const deviceInfo = [
      `platform:${platformLabel}`,
      `desktop:${import_obsidian2.Platform.isDesktop}`,
      `mobile:${import_obsidian2.Platform.isMobile}`,
      `app:${import_obsidian2.Platform.isDesktopApp ? "desktop" : import_obsidian2.Platform.isMobileApp ? "mobile" : "web"}`,
      navigator.language,
      screen.width + "x" + screen.height,
      new Date().getTimezoneOffset().toString(),
      window.location.hostname || "obsidian",
      "feishu-plugin-v1"
    ].join("|");
    const encoder = new TextEncoder();
    const data = encoder.encode(deviceInfo);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return await crypto.subtle.importKey(
      "raw",
      hashBuffer,
      { name: this.ALGORITHM },
      false,
      ["encrypt", "decrypt"]
    );
  }
  /**
   * 加密敏感字符串
   * @param plaintext 明文字符串
   * @returns 加密后的字符串（Base64编码）
   */
  static async encrypt(plaintext) {
    if (!plaintext || plaintext.trim() === "") {
      return plaintext;
    }
    if (this.lastEncryptedData === plaintext && typeof this.lastEncryptedResult === "string") {
      return this.lastEncryptedResult;
    }
    try {
      const key = await this.getEncryptionKey();
      const iv = crypto.getRandomValues(new Uint8Array(this.IV_LENGTH));
      const encoder = new TextEncoder();
      const data = encoder.encode(plaintext);
      const encrypted = await crypto.subtle.encrypt(
        {
          name: this.ALGORITHM,
          iv
        },
        key,
        data
      );
      const combined = new Uint8Array(iv.length + encrypted.byteLength);
      combined.set(iv);
      combined.set(new Uint8Array(encrypted), iv.length);
      const result = this.arrayBufferToBase64(combined.buffer);
      this.lastEncryptedData = plaintext;
      this.lastEncryptedResult = result;
      return result;
    } catch (error) {
      this.logError("[\u52A0\u5BC6\u5DE5\u5177] \u52A0\u5BC6\u5931\u8D25:", error);
      return plaintext;
    }
  }
  /**
   * 解密敏感字符串
   * @param encryptedData 加密的字符串（Base64编码）
   * @returns 解密后的明文字符串
   */
  static async decrypt(encryptedData) {
    if (!encryptedData || encryptedData.trim() === "") {
      return encryptedData;
    }
    if (!this.isEncryptedData(encryptedData)) {
      return encryptedData;
    }
    try {
      const key = await this.getEncryptionKey();
      const combined = this.base64ToArrayBuffer(encryptedData);
      const combinedArray = new Uint8Array(combined);
      const iv = combinedArray.slice(0, this.IV_LENGTH);
      const encrypted = combinedArray.slice(this.IV_LENGTH);
      const decrypted = await crypto.subtle.decrypt(
        {
          name: this.ALGORITHM,
          iv
        },
        key,
        encrypted
      );
      const decoder = new TextDecoder();
      return decoder.decode(decrypted);
    } catch (error) {
      this.logError("[\u52A0\u5BC6\u5DE5\u5177] \u89E3\u5BC6\u5931\u8D25:", error);
      return encryptedData;
    }
  }
  /**
  * 判断字符串是否为加密数据
  * @param data 待检查的字符串
  * @returns 是否为加密数据
  */
  static isEncryptedData(data) {
    const base64Regex = /^[A-Za-z0-9+/]+=*$/;
    if (!base64Regex.test(data)) {
      return false;
    }
    try {
      const decoded = this.base64ToArrayBuffer(data);
      return decoded.byteLength >= this.IV_LENGTH + 1;
    } catch (e) {
      return false;
    }
  }
  /**
   * ArrayBuffer转Base64
   */
  static arrayBufferToBase64(buffer) {
    const bytes = new Uint8Array(buffer);
    let binary = "";
    for (let i = 0; i < bytes.byteLength; i++) {
      const byte = bytes[i];
      if (byte !== void 0) {
        binary += String.fromCharCode(byte);
      }
    }
    return btoa(binary);
  }
  /**
   * Base64转ArrayBuffer
   */
  static base64ToArrayBuffer(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) {
      bytes[i] = binary.charCodeAt(i);
    }
    return bytes.buffer;
  }
  /**
   * 加密敏感设置对象（带缓存优化）
   * @param settings 设置对象
   * @returns 加密后的设置对象
   */
  static async encryptSensitiveSettings(settings) {
    const sensitiveData = this.extractSensitiveData(settings);
    const sensitiveDataString = JSON.stringify(sensitiveData);
    const encrypted = { ...settings };
    const cachedEncryptedFields = this.lastEncryptedResult;
    if (this.lastEncryptedData === sensitiveDataString && cachedEncryptedFields && typeof cachedEncryptedFields === "object" && !Array.isArray(cachedEncryptedFields)) {
      return Object.assign(encrypted, cachedEncryptedFields);
    }
    const encryptedFields = {};
    for (const field of this.SENSITIVE_FIELDS) {
      if (encrypted[field] && typeof encrypted[field] === "string") {
        encryptedFields[field] = await _CryptoUtils.encrypt(encrypted[field]);
        encrypted[field] = encryptedFields[field];
      }
    }
    this.lastEncryptedData = sensitiveDataString;
    this.lastEncryptedResult = encryptedFields;
    return encrypted;
  }
  /**
   * 提取敏感数据用于缓存比较
   */
  static extractSensitiveData(settings) {
    const sensitiveData = {};
    for (const field of this.SENSITIVE_FIELDS) {
      if (settings[field]) {
        sensitiveData[field] = settings[field];
      }
    }
    return sensitiveData;
  }
  /**
   * 解密敏感设置对象（带缓存优化）
   * @param settings 加密的设置对象
   * @returns 解密后的设置对象
   */
  static async decryptSensitiveSettings(settings) {
    const result = { ...settings };
    let hasEncryptedData = false;
    for (const field of this.SENSITIVE_FIELDS) {
      if (settings[field] && typeof settings[field] === "string") {
        try {
          if (this.isEncryptedData(settings[field])) {
            result[field] = await this.decrypt(settings[field]);
            hasEncryptedData = true;
          } else {
            result[field] = settings[field];
          }
        } catch (error) {
          console.warn(`[\u52A0\u5BC6\u5DE5\u5177] \u5B57\u6BB5 ${field} \u89E3\u5BC6\u5931\u8D25\uFF0C\u53EF\u80FD\u662F\u672A\u52A0\u5BC6\u6570\u636E:`, error);
          result[field] = settings[field];
        }
      }
    }
    if (!hasEncryptedData) {
      this.clearCache();
    }
    return result;
  }
  /**
   * 清空缓存
   */
  static clearCache() {
    this.lastEncryptedData = null;
    this.lastEncryptedResult = null;
  }
};
var CryptoUtils = _CryptoUtils;
// 加密算法配置
CryptoUtils.ALGORITHM = "AES-GCM";
CryptoUtils.KEY_LENGTH = 256;
// 256 bits
CryptoUtils.IV_LENGTH = 12;
// 96 bits for GCM
// 敏感字段列表
CryptoUtils.SENSITIVE_FIELDS = ["appId", "appSecret", "folderToken", "userId"];
// 缓存机制
CryptoUtils.encryptionKey = null;
CryptoUtils.lastEncryptedData = null;
CryptoUtils.lastEncryptedResult = null;
CryptoUtils.debugEnabled = false;

// callout-converter.ts
var _CalloutConverter = class {
  static setDebugEnabled(enabled) {
    this.debugEnabled = enabled;
  }
  debug(...args) {
    if (_CalloutConverter.debugEnabled) {
      console.debug(...args);
    }
  }
  constructor(feishuClient) {
    this.feishuClient = feishuClient;
  }
  /**
   * 从 Markdown 文本中提取所有 Callout
   * @param markdown Markdown 文本
   * @returns Callout 信息数组
   */
  extractCallouts(markdown) {
    const callouts = [];
    let match;
    _CalloutConverter.CALLOUT_REGEX.lastIndex = 0;
    while ((match = _CalloutConverter.CALLOUT_REGEX.exec(markdown)) !== null) {
      const [fullMatch, type, contentBlock] = match;
      if (!type)
        continue;
      const startIndex = match.index;
      const endIndex = startIndex + fullMatch.length;
      const contentLines = [];
      if (contentBlock) {
        const lines = contentBlock.split("\n");
        for (const line of lines) {
          if (line.startsWith("> ")) {
            contentLines.push(line.substring(2));
          } else if (line.trim()) {
            contentLines.push(line);
          }
        }
      }
      const processedContent = contentLines.join("\n").trim();
      callouts.push({
        type: type.toUpperCase(),
        content: processedContent || "\u65E0\u5185\u5BB9",
        originalText: fullMatch,
        startIndex,
        endIndex
      });
    }
    return callouts;
  }
  /**
   * 获取 Callout 类型对应的飞书背景色
   * @param type Callout 类型
   * @returns 飞书背景色
   */
  getBackgroundColor(type) {
    return _CalloutConverter.CALLOUT_TYPE_MAPPING[type.toUpperCase()] || "LightGrayBackground";
  }
  /**
   * 获取飞书API需要的数字格式背景颜色
   * @param type Callout类型
   * @returns 数字格式的背景颜色
   */
  getBackgroundColorNumber(type) {
    return _CalloutConverter.CALLOUT_COLOR_NUMBER_MAPPING[type.toUpperCase()] || 1;
  }
  /**
   * 创建飞书高亮块结构
   * @param callout Callout 信息
   * @returns 飞书高亮块结构
   */
  createFeishuCalloutBlock(callout) {
    const backgroundColor = this.getBackgroundColor(callout.type);
    const emoji = this.getEmojiForType(callout.type);
    return {
      block_type: 19,
      // 高亮块类型
      callout: {
        background_color: backgroundColor,
        icon: {
          emoji
        },
        children: [
          {
            block_type: 2,
            // 文本块类型
            text: {
              elements: [
                {
                  text_run: {
                    content: callout.content
                  }
                }
              ]
            }
          }
        ]
      }
    };
  }
  /**
   * 创建包含完整内容的飞书Callout块（用于从引用块转换）
   * @param type Callout类型
   * @param content 实际内容
   * @returns 飞书块对象
   */
  createFeishuCalloutBlockWithContent(type, content) {
    const backgroundColor = this.getBackgroundColor(type);
    const emoji = this.getEmojiForType(type);
    return {
      block_type: 19,
      // 高亮块类型
      callout: {
        background_color: backgroundColor,
        icon: {
          emoji
        },
        children: [
          {
            block_type: 2,
            // 文本块类型
            text: {
              elements: [
                {
                  text_run: {
                    content
                  }
                }
              ]
            }
          }
        ]
      }
    };
  }
  /**
   * 创建嵌套的飞书Callout块结构（用于descendant API）
   * @param callout Callout信息
   * @returns 嵌套块结构
   */
  createFeishuCalloutDescendants(callout) {
    const backgroundColorNumber = this.getBackgroundColorNumber(callout.type);
    const calloutBlockId = `callout_${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
    const textBlockId = `text_${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
    return {
      childrenIds: [calloutBlockId],
      descendants: [
        {
          block_id: calloutBlockId,
          block_type: 19,
          callout: {
            background_color: backgroundColorNumber,
            border_color: 2,
            text_color: 5
          },
          children: [textBlockId]
        },
        {
          block_id: textBlockId,
          block_type: 2,
          children: [],
          text: {
            elements: [
              {
                text_run: {
                  content: callout.content
                }
              }
            ]
          }
        }
      ]
    };
  }
  /**
   * 根据callout类型获取emoji
   * @param type Callout类型
   * @returns emoji字符串
   */
  getEmojiForType(type) {
    const emojiMap = {
      "note": "\u{1F4DD}",
      "info": "\u2139\uFE0F",
      "abstract": "\u{1F4C4}",
      "tip": "\u{1F4A1}",
      "hint": "\u{1F4A1}",
      "success": "\u2705",
      "warning": "\u26A0\uFE0F",
      "caution": "\u26A0\uFE0F",
      "error": "\u274C",
      "danger": "\u26A0\uFE0F",
      "question": "\u2753",
      "help": "\u2753",
      "faq": "\u2753"
    };
    return emojiMap[type.toLowerCase()] || "\u{1F4CC}";
  }
  /**
   * 在飞书文档块中查找对应的引用块
   * @param blocks 飞书文档块数组
   * @param callouts 提取的 Callout 信息
   * @returns 匹配的块信息
   */
  findMatchingQuoteBlocks(blocks, callouts) {
    const matches = [];
    for (const callout of callouts) {
      const matchingBlock = blocks.find((block) => {
        if (block.block_type !== 15)
          return false;
        if (block.quote && block.quote.elements) {
          const blockContent = block.quote.elements.map((element) => {
            var _a;
            return ((_a = element.text_run) == null ? void 0 : _a.content) || "";
          }).join("").trim();
          const calloutPattern = `[!${callout.type.toLowerCase()}]`;
          const hasCalloutMarker = blockContent.includes(calloutPattern) || blockContent.includes(`[!${callout.type.toUpperCase()}]`);
          return hasCalloutMarker;
        }
        return false;
      });
      if (matchingBlock) {
        matches.push({ callout, block: matchingBlock });
      }
    }
    return matches;
  }
  /**
   * 处理单个 Callout 转换（插入新块并删除原块）
   * @param documentId 文档ID
   * @param callout Callout信息
   * @param block 原引用块
   * @returns 转换结果
   */
  async processSingleCalloutConversion(documentId, callout, block) {
    var _a, _b;
    try {
      if (block.index !== void 0 && block.parent_id) {
        const actualParentId = block.parent_id;
        const blockContent = ((_b = (_a = block.quote) == null ? void 0 : _a.elements) == null ? void 0 : _b.map((element) => {
          var _a2;
          return ((_a2 = element.text_run) == null ? void 0 : _a2.content) || "";
        }).join("").trim()) || "";
        const match = blockContent.match(/\[!(\w+)\]([+-]?)\s*(.*)$/s);
        const actualContent = match && match[3] ? match[3].trim() : blockContent;
        const calloutInfo = { ...callout, content: actualContent };
        const { childrenIds, descendants } = this.createFeishuCalloutDescendants(calloutInfo);
        if (block.block_id) {
          await this.feishuClient.deleteDocumentBlock(
            documentId,
            block.block_id,
            actualParentId,
            block.index
          );
          await new Promise((resolve) => setTimeout(resolve, 500));
        } else {
          console.warn("[Callout\u8F6C\u6362] \u8B66\u544A\uFF1A\u539F\u5757\u6CA1\u6709block_id\uFF0C\u8DF3\u8FC7\u5220\u9664\u6B65\u9AA4");
        }
        await this.feishuClient.createDocumentDescendants(
          documentId,
          actualParentId,
          block.index,
          childrenIds,
          descendants
        );
        return true;
      } else {
        console.error("[Callout\u8F6C\u6362] \u9519\u8BEF\uFF1A\u7F3A\u5C11\u5FC5\u8981\u4FE1\u606F");
        this.debug("[Callout\u8F6C\u6362] \u7F3A\u5C11\u5FC5\u8981\u4FE1\u606F\u8BE6\u60C5:", {
          parentId: block.parent_id,
          index: block.index,
          hasParentId: !!block.parent_id,
          hasIndex: block.index !== void 0
        });
        return false;
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[Callout\u8F6C\u6362] \u5355\u4E2A\u8F6C\u6362\u5931\u8D25: ${errorMessage}`);
      this.debug("[Callout\u8F6C\u6362] \u5355\u4E2A\u8F6C\u6362\u5931\u8D25\u8BE6\u60C5:", {
        documentId,
        calloutType: callout.type,
        blockId: block.block_id,
        error,
        errorMessage,
        errorStack: error instanceof Error ? error.stack : void 0
      });
      return false;
    }
  }
  /**
   * 为文档块添加索引信息
   * @param blocks 原始文档块数组
   * @returns 添加索引后的块数组
   */
  addIndexToBlocks(blocks) {
    const blocksWithIndex = [];
    const parentChildrenMap = /* @__PURE__ */ new Map();
    for (const block of blocks) {
      if (block.parent_id) {
        if (!parentChildrenMap.has(block.parent_id)) {
          parentChildrenMap.set(block.parent_id, []);
        }
        parentChildrenMap.get(block.parent_id).push(block);
      }
    }
    for (const block of blocks) {
      const feishuBlock = {
        block_type: block.block_type
      };
      if (block.block_id !== void 0) {
        feishuBlock.block_id = block.block_id;
      }
      if (block.parent_id !== void 0) {
        feishuBlock.parent_id = block.parent_id;
      }
      if (block.text !== void 0) {
        feishuBlock.text = block.text;
      }
      if (block.quote !== void 0) {
        feishuBlock.quote = block.quote;
      }
      if (block.callout !== void 0) {
        feishuBlock.callout = block.callout;
      }
      if (block.parent_id && parentChildrenMap.has(block.parent_id)) {
        const siblings = parentChildrenMap.get(block.parent_id);
        const index = siblings.findIndex((sibling) => sibling.block_id === block.block_id);
        feishuBlock.index = index >= 0 ? index : 0;
      } else {
        const topLevelBlocks = blocks.filter((b) => !b.parent_id);
        const index = topLevelBlocks.findIndex((b) => b.block_id === block.block_id);
        feishuBlock.index = index >= 0 ? index : 0;
      }
      blocksWithIndex.push(feishuBlock);
    }
    return blocksWithIndex;
  }
  /**
   * 验证 Callout 类型是否支持
   * @param type Callout 类型
   * @returns 是否支持
   */
  isSupportedCalloutType(type) {
    return type.toUpperCase() in _CalloutConverter.CALLOUT_TYPE_MAPPING;
  }
  /**
   * 获取所有支持的 Callout 类型
   * @returns 支持的类型数组
   */
  getSupportedCalloutTypes() {
    return Object.keys(_CalloutConverter.CALLOUT_TYPE_MAPPING);
  }
  /**
   * 预览 Callout 转换结果（不执行实际转换）
   * @param markdown Markdown 文本
   * @returns 转换预览信息
   */
  previewConversion(markdown) {
    const callouts = this.extractCallouts(markdown);
    const supportedCount = callouts.filter((c) => this.isSupportedCalloutType(c.type)).length;
    const unsupportedTypes = [...new Set(
      callouts.filter((c) => !this.isSupportedCalloutType(c.type)).map((c) => c.type)
    )];
    return {
      callouts,
      supportedCount,
      unsupportedTypes
    };
  }
  /**
   * 转换文档中的 Callout 为飞书高亮块
   * @param documentId 飞书文档ID
   * @param markdown Markdown 内容
   * @param selectedCalloutIndices 选中的 Callout 索引数组
   * @returns 转换结果
   */
  async convertCalloutsInDocument(documentId, markdown, selectedCalloutIndices) {
    try {
      const allCallouts = this.extractCallouts(markdown);
      if (allCallouts.length === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u672A\u627E\u5230\u4EFB\u4F55 Callout"
        };
      }
      const selectedCallouts = allCallouts.filter(
        (_, index) => selectedCalloutIndices.includes(index)
      );
      if (selectedCallouts.length === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u672A\u9009\u62E9\u4EFB\u4F55 Callout"
        };
      }
      const conversionResult = await this.feishuClient.convertMarkdownToBlocks(markdown);
      if (!(conversionResult == null ? void 0 : conversionResult.blocks)) {
        return {
          success: false,
          convertedCount: 0,
          error: "Markdown \u8F6C\u6362\u5931\u8D25"
        };
      }
      const documentBlocks = await this.feishuClient.getDocumentBlocksDetailed(documentId);
      const blocksWithIndex = this.addIndexToBlocks(documentBlocks);
      const matches = this.findMatchingQuoteBlocks(blocksWithIndex, selectedCallouts);
      if (matches.length === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u672A\u627E\u5230\u5339\u914D\u7684\u5F15\u7528\u5757\uFF0C\u8BF7\u786E\u4FDD\u6587\u6863\u5DF2\u540C\u6B65"
        };
      }
      let convertedCount = 0;
      for (const { callout, block } of matches) {
        const success = await this.processSingleCalloutConversion(
          documentId,
          callout,
          block
        );
        if (success) {
          convertedCount++;
          if (convertedCount < matches.length) {
            await new Promise((resolve) => setTimeout(resolve, 800));
          }
        } else {
          console.error(`[Callout\u8F6C\u6362] \u7B2C ${convertedCount + 1} \u4E2A\u8F6C\u6362\u5931\u8D25`);
        }
      }
      if (convertedCount === 0) {
        return {
          success: false,
          convertedCount: 0,
          error: "\u6240\u6709 Callout \u8F6C\u6362\u90FD\u5931\u8D25\u4E86"
        };
      }
      return {
        success: true,
        convertedCount
      };
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[CalloutConverter] \u8F6C\u6362\u5931\u8D25: ${errorMessage}`);
      this.debug("[CalloutConverter] \u8F6C\u6362\u5931\u8D25\u8BE6\u60C5:", {
        error,
        errorMessage,
        errorStack: error instanceof Error ? error.stack : void 0
      });
      return {
        success: false,
        convertedCount: 0,
        error: error instanceof Error ? error.message : String(error)
      };
    }
  }
};
var CalloutConverter = _CalloutConverter;
CalloutConverter.debugEnabled = false;
// Callout 类型映射表
CalloutConverter.CALLOUT_TYPE_MAPPING = {
  "NOTE": "LightBlueBackground",
  "INFO": "LightBlueBackground",
  "ABSTRACT": "LightBlueBackground",
  "WARNING": "LightOrangeBackground",
  "CAUTION": "LightOrangeBackground",
  "ERROR": "LightRedBackground",
  "DANGER": "LightRedBackground",
  "TIP": "LightGreenBackground",
  "HINT": "LightGreenBackground",
  "SUCCESS": "LightGreenBackground",
  "QUESTION": "LightYellowBackground",
  "HELP": "LightYellowBackground",
  "FAQ": "LightYellowBackground"
};
// 飞书API需要的数字格式背景颜色映射
CalloutConverter.CALLOUT_COLOR_NUMBER_MAPPING = {
  "NOTE": 1,
  // 蓝色
  "INFO": 1,
  // 蓝色
  "ABSTRACT": 1,
  // 蓝色
  "WARNING": 3,
  // 橙色
  "CAUTION": 3,
  // 橙色
  "ERROR": 2,
  // 红色
  "DANGER": 2,
  // 红色
  "TIP": 4,
  // 绿色
  "HINT": 4,
  // 绿色
  "SUCCESS": 4,
  // 绿色
  "QUESTION": 5,
  // 黄色
  "HELP": 5,
  // 黄色
  "FAQ": 5
  // 黄色
};
// Callout 正则表达式 - 匹配完整的 Callout 块
CalloutConverter.CALLOUT_REGEX = /^> \[!([A-Za-z]+)\][+-]?[^\n]*(?:\n((?:> .*\n?)*))?/gm;

// yaml-processor.ts
var _YamlProcessor = class {
  static setDebugEnabled(enabled) {
    this.debugEnabled = enabled;
  }
  debug(...args) {
    if (_YamlProcessor.debugEnabled) {
      console.debug(...args);
    }
  }
  logError(summary, error, details) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(summary, errorMessage);
    this.debug(`${summary} \u8BE6\u60C5:`, {
      ...details,
      error,
      errorMessage,
      errorStack: error instanceof Error ? error.stack : void 0
    });
  }
  constructor(feishuClient) {
    this.feishuClient = feishuClient;
  }
  /**
   * 从 Markdown 文本中提取 YAML frontmatter
   * @param markdown Markdown 文本
   * @returns YAML 信息数组
   */
  extractYaml(markdown) {
    const match = _YamlProcessor.YAML_REGEX.exec(markdown);
    if (!match) {
      return null;
    }
    const yamlContent = match[1];
    const originalText = match[0];
    const startIndex = match.index || 0;
    const endIndex = (match.index || 0) + originalText.length;
    try {
      if (!yamlContent) {
        return null;
      }
      const yamlInfo = this.parseYamlContent(yamlContent);
      return {
        ...yamlInfo,
        originalText,
        startIndex,
        endIndex
      };
    } catch (error) {
      this.logError("[YAML\u5904\u7406\u5668] YAML \u89E3\u6790\u9519\u8BEF:", error);
      return null;
    }
  }
  /**
   * 解析 YAML 内容
   * @param yamlContent YAML 字符串内容
   * @returns 解析后的 YAML 对象
   */
  parseYamlContent(yamlContent) {
    const result = {};
    const lines = yamlContent.split("\n");
    let currentKey = "";
    let isInArray = false;
    let arrayItems = [];
    for (const line of lines) {
      const trimmedLine = line.trim();
      if (!trimmedLine || trimmedLine.startsWith("#")) {
        continue;
      }
      if (trimmedLine.startsWith("- ")) {
        if (isInArray && currentKey) {
          arrayItems.push(trimmedLine.substring(2).trim());
        }
        continue;
      }
      if (isInArray && !trimmedLine.startsWith("- ")) {
        if (currentKey) {
          result[currentKey] = arrayItems;
        }
        isInArray = false;
        arrayItems = [];
      }
      const colonIndex = trimmedLine.indexOf(":");
      if (colonIndex > 0) {
        const key = trimmedLine.substring(0, colonIndex).trim();
        const value = trimmedLine.substring(colonIndex + 1).trim();
        currentKey = key;
        if (value === "") {
          isInArray = true;
          arrayItems = [];
        } else {
          result[key] = this.parseYamlValue(value);
        }
      }
    }
    if (isInArray && currentKey) {
      result[currentKey] = arrayItems;
    }
    return result;
  }
  /**
   * 解析YAML值，自动推断类型
   * @param value 原始字符串值
   * @returns 解析后的值
   */
  parseYamlValue(value) {
    const trimmedValue = value.replace(/^["']|["']$/g, "");
    if (trimmedValue.toLowerCase() === "true")
      return true;
    if (trimmedValue.toLowerCase() === "false")
      return false;
    if (trimmedValue.toLowerCase() === "null" || trimmedValue === "~")
      return null;
    if (/^-?\d+$/.test(trimmedValue)) {
      return parseInt(trimmedValue, 10);
    }
    if (/^-?\d*\.\d+$/.test(trimmedValue)) {
      return parseFloat(trimmedValue);
    }
    if (trimmedValue.includes(",")) {
      return trimmedValue.split(",").map((item) => item.trim());
    }
    return trimmedValue;
  }
  /**
   * 创建飞书 YAML 高亮块
   * @param yamlInfo YAML 信息
   * @returns 飞书高亮块对象
   */
  createFeishuYamlBlock(yamlInfo) {
    const content = this.formatYamlContent(yamlInfo);
    return {
      block_type: 19,
      // 高亮块类型
      callout: {
        background_color: "LightGrayBackground",
        // 使用灰色背景
        icon: {
          emoji: "\u{1F4C4}"
          // 使用页面图标
        },
        children: [
          {
            block_type: 2,
            // 文本块类型
            text: {
              elements: [
                {
                  text_run: {
                    content
                    // 移除代码样式
                  }
                }
              ]
            }
          }
        ]
      }
    };
  }
  /**
   * 创建数字格式的飞书 YAML 高亮块（用于 descendant API）
   * @param yamlInfo YAML 信息
   * @returns 嵌套块结构
   */
  createFeishuYamlDescendants(yamlInfo) {
    const content = this.formatYamlContent(yamlInfo);
    const calloutBlockId = `yaml_${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
    const textBlockId = `text_${Date.now()}_${Math.random().toString(36).slice(2, 11)}`;
    return {
      childrenIds: [calloutBlockId],
      descendants: [
        {
          block_id: calloutBlockId,
          block_type: 19,
          callout: {
            background_color: 6,
            // 灰色背景（数字格式）
            border_color: 2,
            text_color: 5,
            emoji_id: "page_facing_up"
          },
          children: [textBlockId]
        },
        {
          block_id: textBlockId,
          block_type: 2,
          children: [],
          text: {
            elements: [
              {
                text_run: {
                  content
                  // 移除代码样式
                }
              }
            ]
          }
        }
      ]
    };
  }
  /**
   * 格式化 YAML 内容为可读的字符串
   * @param yamlInfo YAML 信息
   * @returns 格式化后的字符串
   */
  formatYamlContent(yamlInfo) {
    const lines = ["\u{1F4C4} \u6587\u6863\u4FE1\u606F"];
    const fieldConfig = {
      title: { icon: "\u{1F4DD}", label: "\u6807\u9898", priority: 1 },
      date: { icon: "\u{1F4C5}", label: "\u65E5\u671F", priority: 2 },
      category: { icon: "\u{1F4C2}", label: "\u7C7B\u522B", priority: 3 },
      tags: { icon: "\u{1F3F7}\uFE0F", label: "\u6807\u7B7E", priority: 4 },
      alias: { icon: "\u{1F517}", label: "\u522B\u540D", priority: 5 },
      stars: { icon: "\u2B50", label: "\u8BC4\u7EA7", priority: 6 },
      from: { icon: "\u{1F4D6}", label: "\u6765\u6E90", priority: 7 },
      url: { icon: "\u{1F517}", label: "\u94FE\u63A5", priority: 8 },
      author: { icon: "\u{1F464}", label: "\u4F5C\u8005", priority: 9 },
      status: { icon: "\u{1F4CA}", label: "\u72B6\u6001", priority: 10 },
      priority: { icon: "\u{1F525}", label: "\u4F18\u5148\u7EA7", priority: 11 },
      created: { icon: "\u{1F195}", label: "\u521B\u5EFA\u65F6\u95F4", priority: 12 },
      updated: { icon: "\u{1F504}", label: "\u66F4\u65B0\u65F6\u95F4", priority: 13 },
      version: { icon: "\u{1F522}", label: "\u7248\u672C", priority: 14 },
      description: { icon: "\u{1F4C4}", label: "\u63CF\u8FF0", priority: 15 }
    };
    const allFields = Object.keys(yamlInfo).filter((key) => !["originalText", "startIndex", "endIndex"].includes(key)).sort((a, b) => {
      var _a, _b;
      const priorityA = ((_a = fieldConfig[a]) == null ? void 0 : _a.priority) || 999;
      const priorityB = ((_b = fieldConfig[b]) == null ? void 0 : _b.priority) || 999;
      return priorityA - priorityB;
    });
    for (const key of allFields) {
      const value = yamlInfo[key];
      if (value === void 0 || value === null)
        continue;
      const config = fieldConfig[key] || { icon: "\u{1F4CC}", label: key, priority: 999 };
      const formattedValue = this.formatFieldValue(key, value);
      if (formattedValue) {
        lines.push(`${config.icon} ${config.label}: ${formattedValue}`);
      }
    }
    return lines.join("\n");
  }
  /**
   * 格式化字段值用于显示
   * @param key 字段名
   * @param value 字段值
   * @returns 格式化后的字符串
   */
  formatFieldValue(key, value) {
    if (value === void 0 || value === null)
      return "";
    switch (key) {
      case "stars":
        if (typeof value === "number" && value >= 0 && value <= 5) {
          const starString = "\u2B50".repeat(Math.floor(value));
          return `${starString} (${value}/5)`;
        }
        return this.stringifyValue(value);
      case "tags":
        if (Array.isArray(value)) {
          return value.join(", ");
        }
        return this.stringifyValue(value);
      case "date":
      case "created":
      case "updated":
        if (typeof value === "string") {
          const date = new Date(value);
          if (!isNaN(date.getTime())) {
            return date.toLocaleDateString("zh-CN");
          }
        }
        return this.stringifyValue(value);
      default:
        if (Array.isArray(value)) {
          return value.join(", ");
        }
        return this.stringifyValue(value);
    }
  }
  stringifyValue(value) {
    if (value === void 0 || value === null) {
      return "";
    }
    if (typeof value === "object") {
      return JSON.stringify(value);
    }
    return String(value);
  }
  /**
   * 检查文档是否包含 YAML frontmatter
   * @param markdown Markdown 文本
   * @returns 是否包含 YAML
   */
  hasYamlFrontmatter(markdown) {
    return _YamlProcessor.YAML_REGEX.test(markdown);
  }
  /**
   * 移除 Markdown 文本中的 YAML frontmatter
   * @param markdown Markdown 文本
   * @returns 移除 YAML 后的文本
   */
  removeYamlFrontmatter(markdown) {
    return markdown.replace(_YamlProcessor.YAML_REGEX, "");
  }
  /**
   * 预览 YAML 转换结果
   * @param markdown Markdown 文本
   * @returns 预览信息
   */
  previewYamlConversion(markdown) {
    const yamlInfo = this.extractYaml(markdown);
    return {
      hasYaml: yamlInfo !== null,
      yamlInfo,
      formattedContent: yamlInfo ? this.formatYamlContent(yamlInfo) : null
    };
  }
  /**
   * 在文档中插入YAML信息块
   * @param documentId 文档ID
   * @param yamlInfo YAML信息
   * @param insertIndex 插入位置索引
   */
  async insertYamlBlockInDocument(documentId, yamlInfo, insertIndex = 0) {
    try {
      const documentBlocks = await this.feishuClient.getDocumentBlocksDetailed(documentId);
      if (!documentBlocks || documentBlocks.length === 0) {
        console.error("[YAML\u5904\u7406\u5668] \u65E0\u6CD5\u83B7\u53D6\u6587\u6863\u5757\u4FE1\u606F");
        return false;
      }
      const rootBlock = documentBlocks.find((block) => !block.parent_id) || documentBlocks[0];
      if (!rootBlock) {
        console.error("[YAML\u5904\u7406\u5668] \u65E0\u6CD5\u627E\u5230\u6587\u6863\u6839\u5757");
        return false;
      }
      const descendants = this.createFeishuYamlDescendants(yamlInfo);
      await this.feishuClient.createDocumentDescendants(
        documentId,
        rootBlock.block_id,
        insertIndex,
        descendants.childrenIds,
        descendants.descendants
      );
      return true;
    } catch (error) {
      this.logError("[YAML\u5904\u7406\u5668] \u63D2\u5165YAML\u5757\u5931\u8D25:", error, { documentId, insertIndex });
      return false;
    }
  }
};
var YamlProcessor = _YamlProcessor;
YamlProcessor.debugEnabled = false;
// YAML frontmatter 正则表达式
YamlProcessor.YAML_REGEX = /^---\s*\n([\s\S]*?)\n---\s*\n/;

// link-processor.ts
var _LinkProcessor = class {
  constructor(app, feishuClient, plugin) {
    this.uploadedDocuments = /* @__PURE__ */ new Map();
    // 缓存已上传的文档
    this.processingDocuments = /* @__PURE__ */ new Set();
    this.app = app;
    this.vault = app.vault;
    this.feishuClient = feishuClient;
    this.plugin = plugin;
  }
  static setDebugEnabled(enabled) {
    this.debugEnabled = enabled;
  }
  debug(...args) {
    if (_LinkProcessor.debugEnabled) {
      console.debug(...args);
    }
  }
  logError(summary, error, details) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(summary, errorMessage);
    this.debug(`${summary} \u8BE6\u60C5:`, {
      ...details,
      error,
      errorMessage,
      errorStack: error instanceof Error ? error.stack : void 0
    });
  }
  /**
   * 从Markdown内容中提取所有双链引用
   * @param content Markdown内容
   * @returns 双链信息数组
   */
  extractWikiLinks(content) {
    const wikiLinks = [];
    const wikiLinkRegex = /\[\[([^\]|]+)(?:\|([^\]]+))?\]\]/g;
    let match;
    while ((match = wikiLinkRegex.exec(content)) !== null) {
      if (!match[1])
        continue;
      const title = match[1].trim();
      const displayText = match[2] || title;
      const originalText = match[0];
      const position = match.index;
      const file = this.findFileByTitle(title);
      wikiLinks.push({
        originalText,
        title,
        position,
        ...file && { file }
        // 只有当file存在时才添加file属性
      });
    }
    return wikiLinks;
  }
  /**
   * 根据标题查找文件
   * @param title 文档标题
   * @returns 对应的文件对象或null
   */
  findFileByTitle(title) {
    const files = this.vault.getMarkdownFiles();
    let matchedFile = files.find((file) => file.basename === title);
    if (matchedFile)
      return matchedFile;
    matchedFile = files.find((file) => {
      const pathWithoutExt = file.path.replace(/\.md$/, "");
      return pathWithoutExt === title || pathWithoutExt.endsWith("/" + title);
    });
    if (matchedFile)
      return matchedFile;
    matchedFile = files.find((file) => {
      const baseName = file.basename.toLowerCase();
      const titleLower = title.toLowerCase();
      return baseName.includes(titleLower) || titleLower.includes(baseName);
    });
    if (matchedFile)
      return matchedFile;
    return null;
  }
  /**
   * 递归上传引用的文档
   * @param wikiLinks 双链信息数组
   * @param onProgress 进度回调
   * @param applyPermissions 是否应用权限设置（与主文档保持一致）
   * @param permissions 权限设置对象
   * @param userId 用户ID（用于转移所有权）
   * @returns 上传结果映射
   */
  async uploadReferencedDocuments(wikiLinks, onProgress, applyPermissions = false, permissions, userId) {
    const results = /* @__PURE__ */ new Map();
    for (let i = 0; i < wikiLinks.length; i++) {
      const wikiLink = wikiLinks[i];
      if (!wikiLink)
        continue;
      const progress = `\u6B63\u5728\u5904\u7406\u5F15\u7528\u6587\u6863 ${i + 1}/${wikiLinks.length}: ${wikiLink.title}`;
      onProgress == null ? void 0 : onProgress(progress);
      try {
        const result = await this.uploadSingleDocument(wikiLink);
        if (result) {
          results.set(wikiLink.title, result);
          wikiLink.feishuUrl = result.url;
          wikiLink.feishuToken = result.token;
          if (applyPermissions && permissions && result.token) {
            try {
              onProgress == null ? void 0 : onProgress(`\u6B63\u5728\u4E3A\u5F15\u7528\u6587\u6863\u8BBE\u7F6E\u6743\u9650: ${wikiLink.title}`);
              await this.feishuClient.setDocumentPermissions(result.token, permissions, userId);
              if (this.plugin.updateHistoryPermissions) {
                const permissionsToSave = {
                  isPublic: permissions.isPublic,
                  allowCopy: permissions.allowCopy,
                  allowCreateCopy: permissions.allowCreateCopy
                };
                await this.plugin.updateHistoryPermissions(result.token, permissionsToSave);
              }
            } catch (permissionError) {
              this.logError(`[\u53CC\u94FE\u5904\u7406] \u5F15\u7528\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u5931\u8D25: ${wikiLink.title}`, permissionError, {
                title: wikiLink.title
              });
            }
          }
        }
      } catch (error) {
        this.logError(`[\u53CC\u94FE\u5904\u7406] \u6587\u6863\u4E0A\u4F20\u5931\u8D25: ${wikiLink.title}`, error, {
          title: wikiLink.title
        });
      }
    }
    return results;
  }
  /**
   * 上传单个文档到飞书
   * @param wikiLink 双链信息
   * @returns 上传结果
   */
  async uploadSingleDocument(wikiLink) {
    if (!wikiLink.file) {
      const foundFile = this.findFileByTitle(wikiLink.title);
      if (!foundFile)
        return null;
      wikiLink.file = foundFile;
    }
    if (this.uploadedDocuments.has(wikiLink.title)) {
      return this.uploadedDocuments.get(wikiLink.title);
    }
    if (this.processingDocuments.has(wikiLink.title)) {
      return null;
    }
    this.processingDocuments.add(wikiLink.title);
    try {
      const content = await this.app.vault.read(wikiLink.file);
      const uploadResult = await this.feishuClient.uploadDocument(
        wikiLink.file.name,
        content,
        this.plugin.settings.folderToken
      );
      const result = {
        token: uploadResult.token,
        url: uploadResult.url,
        title: wikiLink.title
      };
      this.uploadedDocuments.set(wikiLink.title, result);
      return result;
    } catch (error) {
      this.logError(`[\u53CC\u94FE\u5904\u7406] \u6587\u6863\u4E0A\u4F20\u5931\u8D25: ${wikiLink.title}`, error, {
        title: wikiLink.title
      });
      return null;
    } finally {
      this.processingDocuments.delete(wikiLink.title);
    }
  }
  /**
   * 将双链替换为飞书文档链接
   * @param content 原始内容
   * @param wikiLinks 双链信息数组
   * @returns 替换后的内容
   */
  replaceWikiLinksWithFeishuLinks(content, wikiLinks) {
    let processedContent = content;
    const sortedWikiLinks = [...wikiLinks].sort((a, b) => b.position - a.position);
    for (const wikiLink of sortedWikiLinks) {
      if (wikiLink.feishuUrl) {
        const markdownLink = `[${wikiLink.title}](${wikiLink.feishuUrl})`;
        processedContent = processedContent.replace(wikiLink.originalText, markdownLink);
      }
    }
    return processedContent;
  }
  /**
   * 处理文档中的所有双链引用
   * @param content 文档内容
   * @param onProgress 进度回调
   * @param applyPermissions 是否应用权限设置（与主文档保持一致）
   * @param permissions 权限设置对象
   * @param userId 用户ID（用于转移所有权）
   * @returns 处理后的内容和上传结果
   */
  async processWikiLinks(content, onProgress, applyPermissions = false, permissions, userId) {
    const wikiLinks = this.extractWikiLinks(content);
    if (wikiLinks.length === 0) {
      return {
        processedContent: content,
        uploadResults: /* @__PURE__ */ new Map()
      };
    }
    onProgress == null ? void 0 : onProgress("\u6B63\u5728\u4E0A\u4F20\u5F15\u7528\u7684\u6587\u6863...");
    const uploadResults = await this.uploadReferencedDocuments(
      wikiLinks,
      onProgress,
      applyPermissions,
      permissions,
      userId
    );
    onProgress == null ? void 0 : onProgress("\u6B63\u5728\u66FF\u6362\u53CC\u94FE\u4E3A\u98DE\u4E66\u94FE\u63A5...");
    const processedContent = this.replaceWikiLinksWithFeishuLinks(content, wikiLinks);
    return {
      processedContent,
      uploadResults
    };
  }
  /**
   * 清理缓存
   */
  clearCache() {
    this.uploadedDocuments.clear();
    this.processingDocuments.clear();
  }
  /**
   * 获取已上传文档的统计信息
   */
  getUploadStats() {
    return {
      totalUploaded: this.uploadedDocuments.size,
      uploadedTitles: Array.from(this.uploadedDocuments.keys())
    };
  }
};
var LinkProcessor = _LinkProcessor;
// 正在处理的文档，防止循环引用
LinkProcessor.debugEnabled = false;

// mermaid-converter.ts
var import_obsidian3 = require("obsidian");
var MermaidConverter = class {
  static setDebugEnabled(enabled) {
    this.debugEnabled = enabled;
  }
  static debug(...args) {
    if (this.debugEnabled) {
      console.debug(...args);
    }
  }
  static logError(summary, error, details) {
    const errorMessage = error instanceof Error ? error.message : String(error);
    console.error(summary, errorMessage);
    this.debug(`${summary} \u8BE6\u60C5:`, {
      ...details,
      error,
      errorMessage,
      errorStack: error instanceof Error ? error.stack : void 0
    });
  }
  /**
   * 检查内容是否包含Mermaid图表
   * @param content 文档内容
   * @returns 是否包含Mermaid图表
   */
  static hasMermaidCharts(content) {
    const mermaidRegex = /```mermaid\s*\n([\s\S]*?)\n\s*```/g;
    return mermaidRegex.test(content);
  }
  /**
   * 从内容中提取所有Mermaid图表信息
   * @param content 文档内容
   * @returns Mermaid图表信息数组
   */
  static extractMermaidCharts(content) {
    var _a;
    const mermaidInfos = [];
    const mermaidRegex = /```mermaid\s*\n([\s\S]*?)\n\s*```/g;
    let match;
    let index = 0;
    while ((match = mermaidRegex.exec(content)) !== null) {
      const mermaidContent = (_a = match[1]) == null ? void 0 : _a.trim();
      if (mermaidContent) {
        const type = this.detectMermaidType(mermaidContent);
        const fileName = `mermaid-${type}-${Date.now()}-${index}.png`;
        mermaidInfos.push({
          content: mermaidContent,
          fileName,
          type
        });
        index++;
      }
    }
    return mermaidInfos;
  }
  /**
   * 检测Mermaid图表类型
   * @param content Mermaid内容
   * @returns 图表类型
   */
  static detectMermaidType(content) {
    const lines = content.split("\n");
    const firstLine = lines.length > 0 && lines[0] ? lines[0].trim().toLowerCase() : "";
    if (firstLine.includes("flowchart") || firstLine.includes("graph")) {
      return "flowchart";
    } else if (firstLine.includes("sequencediagram")) {
      return "sequence";
    } else if (firstLine.includes("classdiagram")) {
      return "class";
    } else if (firstLine.includes("statediagram")) {
      return "state";
    } else if (firstLine.includes("erdiagram")) {
      return "er";
    } else if (firstLine.includes("gantt")) {
      return "gantt";
    } else if (firstLine.includes("pie")) {
      return "pie";
    } else if (firstLine.includes("journey")) {
      return "journey";
    } else if (firstLine.includes("gitgraph")) {
      return "gitgraph";
    } else {
      return "diagram";
    }
  }
  /**
   * 将Mermaid内容转换为PNG格式的base64字符串
   * 使用Obsidian内置渲染，通过DOM捕获SVG元素
   * @param app Obsidian应用实例
   * @param mermaidContent Mermaid图表内容
   * @param options 转换选项
   * @returns Promise<MermaidConversionResult> 包含PNG数据和尺寸信息的结果对象
   */
  static async convertMermaidToPng(app, mermaidContent, options = {}) {
    let tempContainer = null;
    let component = null;
    try {
      this.debug("[Mermaid\u8F6C\u6362] \u5F00\u59CB\u4F7F\u7528Obsidian\u5185\u7F6E\u6E32\u67D3\u8F6C\u6362Mermaid");
      tempContainer = document.createElement("div");
      tempContainer.classList.add("obshare-mermaid-temp-container");
      document.body.appendChild(tempContainer);
      component = new import_obsidian3.Component();
      const markdownContent = `\`\`\`mermaid
${mermaidContent}
\`\`\``;
      await import_obsidian3.MarkdownRenderer.render(
        app,
        markdownContent,
        tempContainer,
        "",
        component
      );
      await this.waitForMermaidRender(tempContainer);
      const svgElement = tempContainer.querySelector("svg");
      if (!svgElement) {
        throw new Error("\u672A\u627E\u5230\u6E32\u67D3\u540E\u7684SVG\u5143\u7D20");
      }
      this.debug("[Mermaid\u8F6C\u6362] \u6210\u529F\u83B7\u53D6SVG\u5143\u7D20\uFF0C\u5F00\u59CB\u8F6C\u6362\u4E3APNG");
      let svgWidth;
      let svgHeight;
      const widthAttr = svgElement.getAttribute("width");
      const heightAttr = svgElement.getAttribute("height");
      if (widthAttr && heightAttr && !widthAttr.includes("%") && !heightAttr.includes("%")) {
        svgWidth = parseFloat(widthAttr);
        svgHeight = parseFloat(heightAttr);
      } else {
        const rect = svgElement.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          svgWidth = rect.width;
          svgHeight = rect.height;
        } else {
          try {
            const bbox = svgElement.getBBox();
            svgWidth = bbox.width || svgElement.clientWidth || 800;
            svgHeight = bbox.height || svgElement.clientHeight || 600;
          } catch (e) {
            svgWidth = svgElement.clientWidth || 800;
            svgHeight = svgElement.clientHeight || 600;
          }
        }
      }
      this.debug(`[SVG\u8F6CPNG] SVG\u5C3A\u5BF8: ${svgWidth}x${svgHeight}`);
      const pngBase64 = await this.svgElementToPng(svgElement, options);
      const scale = options.scale || this.DEFAULT_SCALE;
      this.debug("[Mermaid\u8F6C\u6362] \u8F6C\u6362\u5B8C\u6210");
      return {
        pngBase64,
        originalWidth: Math.round(svgWidth),
        originalHeight: Math.round(svgHeight),
        scale
      };
    } catch (error) {
      this.logError("[Mermaid\u8F6C\u6362] \u8F6C\u6362\u5931\u8D25:", error);
      throw error instanceof Error ? error : new Error(String(error));
    } finally {
      if (component) {
        component.unload();
      }
      if (tempContainer && tempContainer.parentNode) {
        tempContainer.parentNode.removeChild(tempContainer);
      }
    }
  }
  /**
   * 等待Mermaid渲染完成
   * @param container 容器元素
   * @returns Promise<void>
   */
  static async waitForMermaidRender(container) {
    return new Promise((resolve, reject) => {
      const startTime = Date.now();
      const checkRender = () => {
        const svgElement = container.querySelector("svg");
        if (svgElement) {
          setTimeout(() => resolve(), 100);
          return;
        }
        if (Date.now() - startTime > this.RENDER_TIMEOUT) {
          reject(new Error("Mermaid\u6E32\u67D3\u8D85\u65F6"));
          return;
        }
        setTimeout(checkRender, 50);
      };
      checkRender();
    });
  }
  /**
   * 将SVG元素转换为PNG
   * @param svgElement SVG元素
   * @param options 转换选项
   * @returns Promise<string> PNG的base64字符串
   */
  static async svgElementToPng(svgElement, options) {
    return new Promise((resolve, reject) => {
      try {
        let svgWidth;
        let svgHeight;
        const widthAttr = svgElement.getAttribute("width");
        const heightAttr = svgElement.getAttribute("height");
        if (widthAttr && heightAttr && !widthAttr.includes("%") && !heightAttr.includes("%")) {
          svgWidth = parseFloat(widthAttr);
          svgHeight = parseFloat(heightAttr);
        } else {
          const rect = svgElement.getBoundingClientRect();
          if (rect.width > 0 && rect.height > 0) {
            svgWidth = rect.width;
            svgHeight = rect.height;
          } else {
            try {
              const bbox = svgElement.getBBox();
              svgWidth = bbox.width + (bbox.x || 0);
              svgHeight = bbox.height + (bbox.y || 0);
            } catch (e) {
              svgWidth = svgElement.clientWidth || 800;
              svgHeight = svgElement.clientHeight || 600;
            }
          }
        }
        svgWidth = Math.max(svgWidth, 100);
        svgHeight = Math.max(svgHeight, 100);
        this.debug(`[SVG\u8F6CPNG] SVG\u5C3A\u5BF8: ${svgWidth}x${svgHeight}`);
        const scale = options.scale || this.DEFAULT_SCALE;
        const targetWidth = Math.round(svgWidth * scale);
        const targetHeight = Math.round(svgHeight * scale);
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        if (!ctx) {
          reject(new Error("\u65E0\u6CD5\u521B\u5EFACanvas\u4E0A\u4E0B\u6587"));
          return;
        }
        canvas.width = targetWidth;
        canvas.height = targetHeight;
        const backgroundColor = options.backgroundColor || this.DEFAULT_BACKGROUND_COLOR;
        ctx.fillStyle = backgroundColor;
        ctx.fillRect(0, 0, targetWidth, targetHeight);
        const clonedNode = svgElement.cloneNode(true);
        if (!(clonedNode instanceof SVGSVGElement)) {
          reject(new Error("SVG\u514B\u9686\u5931\u8D25"));
          return;
        }
        const clonedSvg = clonedNode;
        clonedSvg.setAttribute("xmlns", "http://www.w3.org/2000/svg");
        clonedSvg.setAttribute("xmlns:xlink", "http://www.w3.org/1999/xlink");
        clonedSvg.setAttribute("width", svgWidth.toString());
        clonedSvg.setAttribute("height", svgHeight.toString());
        clonedSvg.setAttribute("viewBox", `0 0 ${svgWidth} ${svgHeight}`);
        this.inlineStyles(clonedSvg);
        const svgData = new XMLSerializer().serializeToString(clonedSvg);
        const encodedSvgData = encodeURIComponent(svgData);
        const svgDataUrl = `data:image/svg+xml;charset=utf-8,${encodedSvgData}`;
        const img = new Image();
        img.onload = () => {
          try {
            ctx.drawImage(img, 0, 0, targetWidth, targetHeight);
            const pngDataUrl = canvas.toDataURL("image/png", 1);
            const base64Data = pngDataUrl.split(",")[1];
            if (!base64Data) {
              reject(new Error("\u65E0\u6CD5\u751F\u6210PNG\u6570\u636E"));
              return;
            }
            this.debug(`[SVG\u8F6CPNG] \u8F6C\u6362\u5B8C\u6210\uFF0C\u6700\u7EC8\u5C3A\u5BF8: ${targetWidth}x${targetHeight}`);
            resolve(base64Data);
          } catch (error) {
            reject(error instanceof Error ? error : new Error(String(error)));
          }
        };
        img.onerror = () => {
          reject(new Error("SVG\u56FE\u7247\u52A0\u8F7D\u5931\u8D25"));
        };
        img.src = svgDataUrl;
      } catch (error) {
        this.logError("[SVG\u8F6CPNG] \u8F6C\u6362\u5931\u8D25:", error);
        reject(error instanceof Error ? error : new Error(String(error)));
      }
    });
  }
  /**
   * 内联SVG样式，确保样式不丢失
   * @param svgElement SVG元素
   */
  static inlineStyles(svgElement) {
    try {
      const allElements = svgElement.querySelectorAll("*");
      allElements.forEach((element) => {
        const computedStyle = window.getComputedStyle(element);
        const importantStyles = [
          "fill",
          "stroke",
          "stroke-width",
          "stroke-dasharray",
          "stroke-linecap",
          "font-family",
          "font-size",
          "font-weight",
          "font-style",
          "text-anchor",
          "dominant-baseline",
          "alignment-baseline",
          "opacity",
          "visibility",
          "display"
        ];
        importantStyles.forEach((prop) => {
          const value = computedStyle.getPropertyValue(prop);
          if (value && value !== "initial" && value !== "inherit") {
            element.setAttribute(prop, value.trim());
          }
        });
      });
    } catch (error) {
      console.warn("[SVG\u6837\u5F0F\u5185\u8054] \u6837\u5F0F\u5185\u8054\u5931\u8D25\uFF0C\u7EE7\u7EED\u4F7F\u7528\u539F\u59CB\u6837\u5F0F:", error);
    }
  }
  /**
   * 获取推荐的转换选项
   * @param mermaidContent Mermaid内容
   * @returns 推荐的转换选项
   */
  static getRecommendedOptions(mermaidContent) {
    return {
      scale: this.DEFAULT_SCALE,
      backgroundColor: this.DEFAULT_BACKGROUND_COLOR
    };
  }
};
MermaidConverter.DEFAULT_SCALE = 2;
MermaidConverter.DEFAULT_BACKGROUND_COLOR = "#ffffff";
MermaidConverter.RENDER_TIMEOUT = 1e4;
// 10秒超时
MermaidConverter.debugEnabled = false;

// main.ts
var NotificationManager = class {
  constructor() {
    this.activeNotifications = /* @__PURE__ */ new Set();
    this.notificationTimeouts = /* @__PURE__ */ new Map();
  }
  /**
   * 显示通知，防止重复
   * @param message 通知消息
   * @param duration 显示时长（毫秒）
   * @param type 通知类型，用于去重
   */
  showNotice(message, duration = 4e3, type) {
    const noticeKey = type || message;
    if (this.activeNotifications.has(noticeKey)) {
      return;
    }
    this.activeNotifications.add(noticeKey);
    new import_obsidian4.Notice(message, duration);
    const timeout = setTimeout(() => {
      this.activeNotifications.delete(noticeKey);
      this.notificationTimeouts.delete(noticeKey);
    }, duration);
    this.notificationTimeouts.set(noticeKey, timeout);
  }
  /**
   * 清除所有通知状态
   */
  clearAll() {
    this.notificationTimeouts.forEach((timeout) => clearTimeout(timeout));
    this.activeNotifications.clear();
    this.notificationTimeouts.clear();
  }
};
var DEFAULT_SETTINGS = {
  appId: "",
  appSecret: "",
  folderToken: "",
  userId: "",
  uploadHistory: [],
  uploadCount: 0,
  agreedToTerms: false,
  apiCallCount: 0,
  lastResetDate: new Date().toISOString().substring(0, 7),
  // 当前年月
  enableDoubleLinkMode: true,
  // 默认启用双链模式
  debugLoggingEnabled: false
};
var FeishuUploaderPlugin = class extends import_obsidian4.Plugin {
  constructor() {
    super(...arguments);
    // 飞书客户端实例
    this.feishuClient = null;
    // 飞书富文本客户端实例
    this.feishuRichClient = null;
    // 通知管理器
    this.notificationManager = new NotificationManager();
    // 上次保存的敏感数据哈希，用于检测变化
    this.lastSensitiveDataHash = null;
  }
  applyDebugLoggingSetting() {
    FeishuApiClient.setDebugEnabled(this.settings.debugLoggingEnabled);
    MermaidConverter.setDebugEnabled(this.settings.debugLoggingEnabled);
    CalloutConverter.setDebugEnabled(this.settings.debugLoggingEnabled);
    YamlProcessor.setDebugEnabled(this.settings.debugLoggingEnabled);
    LinkProcessor.setDebugEnabled(this.settings.debugLoggingEnabled);
    CryptoUtils.setDebugEnabled(this.settings.debugLoggingEnabled);
  }
  async onload() {
    await this.loadSettings();
    this.applyDebugLoggingSetting();
    if (!this.settings.agreedToTerms) {
      const termsModal = new UserAgreementModal(this.app, this);
      termsModal.open();
      return;
    }
    this.completeInitialization();
  }
  // 完成插件初始化（用户同意协议后调用）
  completeInitialization() {
    this.initializeFeishuClient();
    this.addCommand({
      id: "publish-current-document",
      name: "\u5206\u4EAB\u5F53\u524D\u6587\u6863\u5230\u98DE\u4E66",
      callback: () => {
        void this.uploadCurrentDocument();
      }
    });
    this.registerEvent(
      this.app.workspace.on("file-menu", (menu, file) => {
        if (file instanceof import_obsidian4.TFile && file.extension === "md") {
          menu.addItem((item) => {
            item.setTitle("\u5206\u4EAB\u8BE5\u9875\u9762").setIcon("share").onClick(() => {
              void this.uploadFile(file);
            });
          });
        }
      })
    );
    this.addRibbonIcon("share", "\u5206\u4EAB\u5F53\u524D\u9875\u9762", (evt) => {
      void this.uploadCurrentDocument();
    });
    this.addSettingTab(new FeishuUploaderSettingTab(this.app, this));
  }
  /**
   * 初始化飞书API客户端
   */
  initializeFeishuClient() {
    if (this.settings.appId && this.settings.appSecret) {
      const asyncCallback = () => {
        void this.incrementApiCallCount().catch((error) => {
          const errorMessage = error instanceof Error ? error.message : String(error);
          console.error(`[\u98DE\u4E66\u63D2\u4EF6] API\u8C03\u7528\u8BA1\u6570\u66F4\u65B0\u5931\u8D25: ${errorMessage}`);
          if (this.settings.debugLoggingEnabled) {
            console.debug("[\u98DE\u4E66\u63D2\u4EF6] API\u8C03\u7528\u8BA1\u6570\u66F4\u65B0\u5931\u8D25\u8BE6\u60C5:", error);
          }
        });
      };
      if (this.feishuClient) {
        this.feishuClient.updateCredentials(this.settings.appId, this.settings.appSecret);
      } else {
        this.feishuClient = createFeishuClient(this.settings.appId, this.settings.appSecret, this.app, asyncCallback);
      }
      if (this.feishuRichClient) {
        this.feishuRichClient.updateCredentials(this.settings.appId, this.settings.appSecret);
      } else {
        this.feishuRichClient = createFeishuClient(this.settings.appId, this.settings.appSecret, this.app, asyncCallback);
      }
    } else {
      this.feishuClient = null;
      this.feishuRichClient = null;
    }
  }
  onunload() {
    this.notificationManager.clearAll();
  }
  async loadSettings() {
    const loadedData = await this.loadData();
    const loadedSettings = typeof loadedData === "object" && loadedData !== null ? loadedData : {};
    this.settings = Object.assign({}, DEFAULT_SETTINGS, loadedSettings);
    const sensitiveFields = ["appId", "appSecret", "folderToken", "userId"];
    let hasPlaintextData = false;
    for (const field of sensitiveFields) {
      const value = loadedSettings[field];
      if (value && typeof value === "string" && !CryptoUtils.isEncryptedData(value)) {
        hasPlaintextData = true;
        break;
      }
    }
    this.settings = await CryptoUtils.decryptSensitiveSettings(this.settings);
    const sensitiveData = sensitiveFields.map((field) => this.settings[field] || "").join("|");
    this.lastSensitiveDataHash = await this.simpleHash(sensitiveData);
    if (hasPlaintextData) {
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      await this.saveData(encryptedSettings);
    }
    if (this.settings.uploadHistory) {
      this.settings.uploadHistory.forEach((item) => {
        if (!item.docToken) {
          item.docToken = "\u672A\u77E5";
        }
      });
    }
  }
  async saveSettings() {
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.initializeFeishuClient();
    this.applyDebugLoggingSetting();
  }
  /**
   * 优化的保存方法：只在必要时进行加密
   */
  async saveDataOptimized() {
    const sensitiveFields = ["appId", "appSecret", "folderToken", "userId"];
    const sensitiveData = sensitiveFields.map((field) => this.settings[field] || "").join("|");
    const currentHash = await this.simpleHash(sensitiveData);
    if (this.lastSensitiveDataHash === currentHash) {
      await this.saveData(this.settings);
      return;
    }
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.lastSensitiveDataHash = currentHash;
  }
  /**
   * 简单哈希函数
   */
  async simpleHash(data) {
    const encoder = new TextEncoder();
    const dataBuffer = encoder.encode(data);
    const hashBuffer = await crypto.subtle.digest("SHA-256", dataBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
  }
  /**
   * 统一收集文档中所有类型的图片信息（包括普通图片、SVG、Mermaid）
   * @param content 文档内容
   * @returns 按原文档位置排序的图片信息数组
   */
  collectAllImageInfos(content) {
    var _a;
    const allImages = [];
    if (MermaidConverter.hasMermaidCharts(content)) {
      const mermaidInfos = MermaidConverter.extractMermaidCharts(content);
      mermaidInfos.forEach((mermaidInfo) => {
        const mermaidPattern = new RegExp(`\`\`\`mermaid[\\s\\S]*?\`\`\``, "g");
        let match2;
        while ((match2 = mermaidPattern.exec(content)) !== null) {
          const matchContent = match2[0].replace(/```mermaid\s*\n?/, "").replace(/\n?\s*```$/, "").trim();
          if (matchContent === mermaidInfo.content.trim()) {
            allImages.push({
              type: "mermaid",
              position: match2.index,
              info: mermaidInfo,
              originalMatch: match2[0]
            });
            break;
          }
        }
      });
    }
    const obsidianImageRegex = /!\[\[([^\]]+)\]\]/g;
    let match;
    while ((match = obsidianImageRegex.exec(content)) !== null) {
      const fileName = match[1];
      if (!fileName) {
        continue;
      }
      const info = {
        fileName,
        path: fileName,
        originalSyntax: "obsidian"
      };
      allImages.push({
        type: "regular",
        position: match.index,
        info,
        originalMatch: match[0]
      });
    }
    const markdownImageRegex = /!\[([^\]]*)\]\(([^)\s]+)(?:\s+"([^"]*)")?\)/g;
    while ((match = markdownImageRegex.exec(content)) !== null) {
      const alt = (_a = match[1]) != null ? _a : "";
      const path = match[2];
      const title = match[3];
      if (!path)
        continue;
      const decodedPath = decodeURI(path);
      const fileName = decodedPath.split("/").pop() || decodedPath;
      const info = {
        fileName,
        path: decodedPath,
        alt,
        originalSyntax: "markdown",
        ...title !== void 0 ? { title } : {}
      };
      allImages.push({
        type: "regular",
        position: match.index,
        info,
        originalMatch: match[0]
      });
    }
    allImages.sort((a, b) => a.position - b.position);
    return allImages;
  }
  /**
   * 上传当前文档
   */
  async uploadCurrentDocument() {
    const activeView = this.app.workspace.getActiveViewOfType(import_obsidian4.MarkdownView);
    if (!activeView) {
      this.notificationManager.showNotice("\u8BF7\u5148\u6253\u5F00\u4E00\u4E2AMarkdown\u6587\u6863", 4e3, "no-markdown-doc");
      return;
    }
    const file = activeView.file;
    if (!file) {
      this.notificationManager.showNotice("\u65E0\u6CD5\u83B7\u53D6\u5F53\u524D\u6587\u6863", 4e3, "no-current-doc");
      return;
    }
    await this.uploadFile(file);
  }
  /**
   * 转换当前文档中的 Callout 为飞书高亮块
   */
  /**
   * 上传指定文件
   */
  async uploadFile(file) {
    const client = this.feishuClient;
    if (!client) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25\uFF1A\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316");
      this.notificationManager.showNotice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u98DE\u4E66\u5E94\u7528\u51ED\u8BC1", 5e3, "missing-credentials");
      return;
    }
    if (!this.settings.folderToken) {
      console.error("[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25\uFF1A\u6587\u4EF6\u5939 token \u672A\u914D\u7F6E");
      this.notificationManager.showNotice("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u98DE\u4E66\u6587\u4EF6\u5939 token", 5e3, "missing-folder-token");
      return;
    }
    let content = await this.app.vault.read(file);
    const title = file.basename;
    const progressModal = new UploadProgressModal(this.app);
    progressModal.open();
    try {
      progressModal.updateProgress(5, "\u6B63\u5728\u8BFB\u53D6\u6587\u6863\u5185\u5BB9...");
      progressModal.updateProgress(10, "\u6B63\u5728\u5206\u6790\u6587\u6863\u683C\u5F0F...");
      let linkProcessor = null;
      let linkResult = null;
      if (this.settings.enableDoubleLinkMode && this.feishuClient) {
        linkProcessor = new LinkProcessor(this.app, this.feishuClient, this);
        linkResult = await linkProcessor.processWikiLinks(content, (status) => {
          const baseProgress = 15;
          const maxProgress = 35;
          let currentProgress = baseProgress;
          if (status.includes("\u6B63\u5728\u4E0A\u4F20\u5F15\u7528\u7684\u6587\u6863")) {
            currentProgress = baseProgress + 5;
          } else if (status.includes("\u6B63\u5728\u5904\u7406\u5F15\u7528\u6587\u6863")) {
            const match = status.match(/(\d+)\/(\d+)/);
            if (match && match[1] && match[2]) {
              const current = parseInt(match[1]);
              const total = parseInt(match[2]);
              const progressRatio = current / total;
              currentProgress = baseProgress + 5 + progressRatio * 10;
            } else {
              currentProgress = baseProgress + 8;
            }
          } else if (status.includes("\u6B63\u5728\u66FF\u6362\u53CC\u94FE\u4E3A\u98DE\u4E66\u94FE\u63A5")) {
            currentProgress = maxProgress - 2;
          }
          progressModal.updateProgress(Math.min(currentProgress, maxProgress), status);
        });
        content = linkResult.processedContent;
      }
      let cachedYaml = null;
      if (this.feishuClient) {
        const yamlProcessor = new YamlProcessor(this.feishuClient);
        cachedYaml = yamlProcessor.extractYaml(content);
        if (cachedYaml) {
          content = yamlProcessor.removeYamlFrontmatter(content);
        }
      }
      progressModal.updateProgress(30, "\u6B63\u5728\u5206\u6790\u6587\u6863\u4E2D\u7684\u56FE\u7247...");
      const allImageInfos = this.collectAllImageInfos(content);
      const hasImages = allImageInfos.length > 0;
      let processedContent = content;
      let cachedMermaidInfos = [];
      if (hasImages) {
        progressModal.updateProgress(35, "\u6B63\u5728\u5904\u7406\u56FE\u7247...");
        try {
          for (let i = 0; i < allImageInfos.length; i++) {
            const imageInfo = allImageInfos[i];
            if (!imageInfo)
              continue;
            const progress = 35 + i / allImageInfos.length * 20;
            if (imageInfo.type === "mermaid") {
              progressModal.updateProgress(progress, `\u6B63\u5728\u6E32\u67D3Mermaid\u56FE\u8868 ${i + 1}/${allImageInfos.length}...`);
              const mermaidInfo = imageInfo.info;
              const options = MermaidConverter.getRecommendedOptions(mermaidInfo.content);
              const conversionResult = await MermaidConverter.convertMermaidToPng(this.app, mermaidInfo.content, options);
              const tempFileName = `temp_${mermaidInfo.fileName}`;
              const svgConvertOptions = {
                originalWidth: conversionResult.originalWidth,
                originalHeight: conversionResult.originalHeight,
                scale: conversionResult.scale
              };
              FeishuApiClient.addMermaidImageToCache(tempFileName, conversionResult.pngBase64, svgConvertOptions);
              FeishuApiClient.addMermaidImageToCache(mermaidInfo.fileName, conversionResult.pngBase64, svgConvertOptions);
              mermaidInfo.pngBase64 = conversionResult.pngBase64;
              mermaidInfo.tempFileName = tempFileName;
              cachedMermaidInfos.push(mermaidInfo);
              const imageReference = `![${mermaidInfo.fileName}](${mermaidInfo.fileName})`;
              if (imageInfo.originalMatch) {
                processedContent = processedContent.replace(imageInfo.originalMatch, imageReference);
              }
            }
          }
          content = processedContent;
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : String(error);
          console.error(`[\u56FE\u7247\u5904\u7406] \u5904\u7406\u56FE\u7247\u5931\u8D25: ${errorMessage}`);
          if (this.settings.debugLoggingEnabled) {
            console.debug("[\u56FE\u7247\u5904\u7406] \u5904\u7406\u56FE\u7247\u5931\u8D25\u8BE6\u60C5:", error);
          }
          this.notificationManager.showNotice(`\u56FE\u7247\u5904\u7406\u5931\u8D25: ${errorMessage}`, 6e3);
        }
      }
      let cachedCallouts = [];
      if (this.feishuClient) {
        const calloutConverter = new CalloutConverter(this.feishuClient);
        cachedCallouts = calloutConverter.extractCallouts(content);
      }
      let orderedImageInfos = [];
      if (hasImages) {
        for (const imageInfo of allImageInfos) {
          if (imageInfo.type === "mermaid") {
            const mermaidInfo = imageInfo.info;
            orderedImageInfos.push({
              path: mermaidInfo.fileName,
              fileName: mermaidInfo.fileName,
              position: orderedImageInfos.length
            });
          } else {
            orderedImageInfos.push({
              path: imageInfo.info.path,
              fileName: imageInfo.info.fileName,
              position: orderedImageInfos.length
            });
          }
        }
      }
      progressModal.updateProgress(55, "\u6B63\u5728\u4E0A\u4F20\u6587\u6863\u5230\u98DE\u4E66...");
      const result = await this.performNormalUpload(file, content, hasImages, orderedImageInfos, progressModal);
      let processStep = 80;
      if (cachedYaml) {
        progressModal.updateProgress(processStep, "\u6B63\u5728\u5904\u7406\u6587\u6863\u4FE1\u606F\u5757...");
        await this.autoProcessYaml(result.token, cachedYaml);
        processStep = 85;
      }
      if (cachedCallouts.length > 0) {
        progressModal.updateProgress(processStep, "\u6B63\u5728\u5904\u7406\u6807\u6CE8\u5757...");
        await this.autoConvertCallouts(result.token, cachedCallouts);
        processStep = 90;
      }
      progressModal.updateProgress(95, "\u6B63\u5728\u4FDD\u5B58\u4E0A\u4F20\u8BB0\u5F55...");
      const referencedDocs = this.settings.enableDoubleLinkMode && linkProcessor && linkResult && linkResult.uploadResults.size > 0 ? Array.from(linkResult.uploadResults.values()).map((result2) => ({
        title: result2.title,
        docToken: result2.token,
        url: result2.url
      })) : void 0;
      await this.addUploadHistory(title, result.url, result.token, void 0, referencedDocs);
      if (this.settings.enableDoubleLinkMode && referencedDocs && referencedDocs.length > 0) {
        for (const refDoc of referencedDocs) {
          await this.addUploadHistory(
            refDoc.title,
            refDoc.url,
            refDoc.docToken,
            void 0,
            void 0,
            true
            // 标识为引用文档
          );
        }
      }
      progressModal.complete();
      new DocumentPermissionModal(this.app, result.token, result.url, title, this, false).open();
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25: ${errorMessage}`);
      if (this.settings.debugLoggingEnabled) {
        console.debug("[\u98DE\u4E66\u63D2\u4EF6] \u4E0A\u4F20\u5931\u8D25\u8BE6\u60C5:", error);
      }
      let userMessage = "";
      if (errorMessage.includes("\u5BFC\u5165\u4EFB\u52A1\u5904\u7406\u8D85\u65F6")) {
        userMessage = "\u6587\u6863\u5904\u7406\u65F6\u95F4\u8F83\u957F\uFF0C\u8BF7\u7A0D\u540E\u624B\u52A8\u68C0\u67E5\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u7684\u65B0\u6587\u6863\u3002";
        progressModal.complete();
        new import_obsidian4.Notice(userMessage, 1e4);
        return;
      } else if (errorMessage.includes("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25")) {
        userMessage = "\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u4EE5\u4E0B\u9879\u76EE\uFF1A\n1. \u786E\u4FDD\u7F51\u7EDC\u8FDE\u63A5\u6B63\u5E38\n2. \u68C0\u67E5\u9632\u706B\u5899\u8BBE\u7F6E\n3. \u5C1D\u8BD5\u91CD\u65B0\u8FDE\u63A5\u7F51\u7EDC\u540E\u91CD\u8BD5";
      } else if (errorMessage.includes("\u83B7\u53D6\u8BBF\u95EE\u4EE4\u724C\u5931\u8D25")) {
        userMessage = "API \u8BA4\u8BC1\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\uFF1A\n1. app ID \u548C app secret \u662F\u5426\u6B63\u786E\n2. \u5E94\u7528\u6743\u9650\u662F\u5426\u914D\u7F6E\u6B63\u786E\n3. \u7F51\u7EDC\u662F\u5426\u80FD\u8BBF\u95EE\u98DE\u4E66 API";
      } else if (errorMessage.includes("\u6587\u4EF6\u5939")) {
        userMessage = "\u6587\u4EF6\u5939\u914D\u7F6E\u9519\u8BEF\uFF0C\u8BF7\u68C0\u67E5\uFF1A\n1. \u6587\u4EF6\u5939 token \u662F\u5426\u6B63\u786E\n2. \u662F\u5426\u6709\u6587\u4EF6\u5939\u5199\u5165\u6743\u9650";
      } else if (errorMessage.includes("\u67E5\u8BE2\u5BFC\u5165\u4EFB\u52A1\u5931\u8D25\uFF0C\u5DF2\u91CD\u8BD5")) {
        userMessage = "\u67E5\u8BE2\u5BFC\u5165\u72B6\u6001\u5931\u8D25\uFF0C\u5DF2\u91CD\u8BD52\u6B21\u3002\u6587\u6863\u53EF\u80FD\u5DF2\u6210\u529F\u4E0A\u4F20\uFF0C\u8BF7\u624B\u52A8\u68C0\u67E5\u98DE\u4E66\u4E91\u6587\u6863\u3002";
      } else {
        userMessage = `\u4E0A\u4F20\u5931\u8D25: ${errorMessage}`;
      }
      progressModal.showError(userMessage);
      new import_obsidian4.Notice(userMessage, 8e3);
      if (errorMessage.includes("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25")) {
        this.showRetryDialog(file);
      }
    } finally {
      FeishuApiClient.clearMermaidImageCache();
    }
  }
  /**
   * 执行正常的文档上传流程
   * @param file 文件对象
   * @param content 文档内容
   * @param hasImages 是否包含图片
   * @param orderedImageInfos 图片信息数组
   * @param progressModal 进度模态框
   * @returns 上传结果
   */
  async performNormalUpload(file, content, hasImages, orderedImageInfos, progressModal) {
    let result;
    if (hasImages) {
      result = await this.feishuRichClient.uploadDocumentWithImageInfos(
        file.name,
        // 完整文件名（包含扩展名）用于上传到云空间
        content,
        this.settings.folderToken,
        (status) => {
          let currentProgress = 55;
          if (status.includes("\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1")) {
            currentProgress = 60;
          } else if (status.includes("\u7B49\u5F85\u5904\u7406") || status.includes("\u6B63\u5728\u5904\u7406")) {
            currentProgress = 65;
          } else if (status.includes("\u5904\u7406\u4E2D") || status.includes("\u8F6C\u6362")) {
            currentProgress = 75;
          } else if (status.includes("\u5904\u7406\u56FE\u7247")) {
            currentProgress = 80;
          } else if (status.includes("\u5B8C\u6210")) {
            currentProgress = 85;
          }
          progressModal.updateProgress(currentProgress, status);
        },
        orderedImageInfos
      );
    } else {
      result = await this.feishuClient.uploadDocument(
        file.name,
        // 完整文件名（包含扩展名）用于上传到云空间
        content,
        this.settings.folderToken,
        (status) => {
          let currentProgress = 55;
          if (status.includes("\u521B\u5EFA\u5BFC\u5165\u4EFB\u52A1")) {
            currentProgress = 60;
          } else if (status.includes("\u7B49\u5F85\u5904\u7406") || status.includes("\u6B63\u5728\u5904\u7406")) {
            currentProgress = 65;
          } else if (status.includes("\u5904\u7406\u4E2D") || status.includes("\u8F6C\u6362")) {
            currentProgress = 75;
          } else if (status.includes("\u5B8C\u6210")) {
            currentProgress = 85;
          }
          progressModal.updateProgress(currentProgress, status);
        }
      );
    }
    return result;
  }
  /**
   * 自动处理文档中的 YAML frontmatter（无用户交互）
   * @param docToken 文档Token
   * @param yamlInfo YAML信息
   */
  async autoProcessYaml(docToken, yamlInfo) {
    try {
      if (!this.feishuClient) {
        console.warn("[\u98DE\u4E66\u63D2\u4EF6] \u98DE\u4E66\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316\uFF0C\u8DF3\u8FC7 YAML \u5904\u7406");
        return;
      }
      const yamlProcessor = new YamlProcessor(this.feishuClient);
      await new Promise((resolve) => setTimeout(resolve, 2e3));
      await yamlProcessor.insertYamlBlockInDocument(docToken, yamlInfo, 0);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66\u63D2\u4EF6] YAML \u5904\u7406\u5931\u8D25: ${errorMessage}`);
      if (this.settings.debugLoggingEnabled) {
        console.debug("[\u98DE\u4E66\u63D2\u4EF6] YAML \u5904\u7406\u5931\u8D25\u8BE6\u60C5:", error);
      }
    }
  }
  /**
   * 自动转换文档中的 Callout（无用户交互）
   * 在图片处理完成后调用，此时文档已完全同步
   * @param docToken 文档Token
   * @param cachedCallouts 预先缓存的Callout数组
   */
  async autoConvertCallouts(docToken, cachedCallouts) {
    try {
      if (!this.feishuClient) {
        console.warn("[\u98DE\u4E66\u63D2\u4EF6] \u98DE\u4E66\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316\uFF0C\u8DF3\u8FC7 Callout \u8F6C\u6362");
        return;
      }
      if (cachedCallouts.length > 0) {
        const calloutConverter = new CalloutConverter(this.feishuClient);
        await new Promise((resolve) => setTimeout(resolve, 1e3));
        const documentBlocks = await this.feishuClient.getDocumentBlocksDetailed(docToken);
        if (!documentBlocks || documentBlocks.length === 0) {
          console.warn("[\u98DE\u4E66\u63D2\u4EF6] \u65E0\u6CD5\u83B7\u53D6\u6587\u6863\u5757\u4FE1\u606F\uFF0C\u8DF3\u8FC7 Callout \u8F6C\u6362");
          return;
        }
        const blocksWithIndex = calloutConverter.addIndexToBlocks(documentBlocks);
        const matches = calloutConverter.findMatchingQuoteBlocks(blocksWithIndex, cachedCallouts);
        if (matches.length === 0) {
          return;
        }
        for (const { callout, block } of matches) {
          await calloutConverter.processSingleCalloutConversion(
            docToken,
            callout,
            block
          );
        }
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66\u63D2\u4EF6] Callout \u81EA\u52A8\u8F6C\u6362\u51FA\u9519: ${errorMessage}`);
      if (this.settings.debugLoggingEnabled) {
        console.debug("[\u98DE\u4E66\u63D2\u4EF6] Callout \u81EA\u52A8\u8F6C\u6362\u51FA\u9519\u8BE6\u60C5:", error);
      }
    }
  }
  /**
   * 显示重试对话框
   */
  showRetryDialog(file) {
    const modal = new RetryModal(this.app, () => {
      void this.uploadFile(file);
    });
    modal.open();
  }
  /**
   * 添加上传历史记录
   */
  async addUploadHistory(title, url, docToken, permissions, referencedDocuments, isReferencedDocument) {
    const now = new Date();
    const uploadTime = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0") + "-" + String(now.getDate()).padStart(2, "0") + " " + String(now.getHours()).padStart(2, "0") + ":" + String(now.getMinutes()).padStart(2, "0");
    const historyItem = {
      title,
      url,
      uploadTime,
      docToken,
      ...permissions && { permissions },
      ...referencedDocuments && { referencedDocuments },
      ...isReferencedDocument && { isReferencedDocument }
    };
    this.settings.uploadHistory.unshift(historyItem);
    this.settings.uploadCount++;
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
  }
  /**
   * 更新历史记录中的权限设置
   */
  async updateHistoryPermissions(docToken, permissions) {
    const historyItem = this.settings.uploadHistory.find((item) => item.docToken === docToken);
    if (historyItem) {
      historyItem.permissions = permissions;
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      await this.saveData(encryptedSettings);
    }
  }
  /**
   * 更新现有历史记录的时间戳
   */
  async updateHistoryTimestamp(docToken) {
    const historyItem = this.settings.uploadHistory.find((item) => item.docToken === docToken);
    if (historyItem) {
      const now = new Date();
      const uploadTime = now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0") + "-" + String(now.getDate()).padStart(2, "0") + " " + String(now.getHours()).padStart(2, "0") + ":" + String(now.getMinutes()).padStart(2, "0");
      historyItem.uploadTime = uploadTime;
      const index = this.settings.uploadHistory.indexOf(historyItem);
      if (index > 0) {
        this.settings.uploadHistory.splice(index, 1);
        this.settings.uploadHistory.unshift(historyItem);
      }
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      await this.saveData(encryptedSettings);
    }
  }
  /**
   * 删除单个历史记录项
   * @param docToken 文档token
   */
  async deleteHistoryItem(docToken) {
    const index = this.settings.uploadHistory.findIndex((item) => item.docToken === docToken);
    if (index !== -1) {
      this.settings.uploadHistory.splice(index, 1);
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      await this.saveData(encryptedSettings);
    }
  }
  /**
   * 删除文件并清除历史记录
   * @param docToken 文档token
   * @param title 文档标题
   */
  async deleteFileAndHistory(docToken, title) {
    if (!this.feishuClient) {
      throw new Error("\u98DE\u4E66\u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316");
    }
    try {
      await this.feishuClient.deleteFile(docToken);
      await this.incrementApiCallCount();
      await this.deleteHistoryItem(docToken);
      this.notificationManager.showNotice(`\u6587\u4EF6 "${title}" \u5DF2\u5220\u9664`, 3e3);
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66\u63D2\u4EF6] \u5220\u9664\u6587\u4EF6\u5931\u8D25: ${errorMessage}`);
      if (this.settings.debugLoggingEnabled) {
        console.debug("[\u98DE\u4E66\u63D2\u4EF6] \u5220\u9664\u6587\u4EF6\u5931\u8D25\u8BE6\u60C5:", error);
      }
      throw new Error(`\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${errorMessage}`);
    }
  }
  /**
   * 清空上传历史记录
   */
  async clearUploadHistory() {
    this.settings.uploadHistory = [];
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.notificationManager.showNotice("\u5DF2\u6E05\u7A7A\u4E0A\u4F20\u5386\u53F2\u8BB0\u5F55", 3e3, "history-cleared");
  }
  /**
   * 重置上传次数
   */
  async resetUploadCount() {
    this.settings.uploadCount = 0;
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.notificationManager.showNotice("\u5DF2\u91CD\u7F6E\u4E0A\u4F20\u6B21\u6570", 3e3, "count-reset");
  }
  /**
   * 增加API调用次数
   */
  async incrementApiCallCount() {
    await this.checkAndResetApiCount();
    this.settings.apiCallCount++;
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
  }
  /**
   * 检查并重置API调用次数（每月1日北京时间自动重置）
   */
  async checkAndResetApiCount() {
    const now = new Date();
    const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1e3);
    const currentMonth = beijingTime.toISOString().substring(0, 7);
    if (this.settings.lastResetDate !== currentMonth) {
      this.settings.apiCallCount = 0;
      this.settings.lastResetDate = currentMonth;
      const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
      await this.saveData(encryptedSettings);
    }
  }
  /**
   * 手动重置API调用次数
   */
  async resetApiCallCount() {
    this.settings.apiCallCount = 0;
    const now = new Date();
    const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1e3);
    this.settings.lastResetDate = beijingTime.toISOString().substring(0, 7);
    const encryptedSettings = await CryptoUtils.encryptSensitiveSettings(this.settings);
    await this.saveData(encryptedSettings);
    this.notificationManager.showNotice("\u5DF2\u91CD\u7F6EAPI\u8C03\u7528\u6B21\u6570", 3e3, "api-count-reset");
  }
  /**
   * 测试网络连接
   */
  async testNetworkConnection() {
    try {
      if (!this.feishuClient) {
        console.error("[\u98DE\u4E66\u63D2\u4EF6] \u5BA2\u6237\u7AEF\u672A\u521D\u59CB\u5316\uFF0C\u65E0\u6CD5\u6D4B\u8BD5\u8FDE\u63A5");
        return false;
      }
      const result = await this.feishuClient.testConnection();
      void this.incrementApiCallCount().catch((error) => {
        const errorMessage = error instanceof Error ? error.message : String(error);
        console.error(`[\u98DE\u4E66\u63D2\u4EF6] API\u8C03\u7528\u8BA1\u6570\u66F4\u65B0\u5931\u8D25: ${errorMessage}`);
        if (this.settings.debugLoggingEnabled) {
          console.debug("[\u98DE\u4E66\u63D2\u4EF6] API\u8C03\u7528\u8BA1\u6570\u66F4\u65B0\u5931\u8D25\u8BE6\u60C5:", error);
        }
      });
      return result;
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66\u63D2\u4EF6] \u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: ${errorMessage}`);
      if (this.settings.debugLoggingEnabled) {
        console.debug("[\u98DE\u4E66\u63D2\u4EF6] \u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25\u8BE6\u60C5:", error);
      }
      return false;
    }
  }
};
var DocumentPermissionModal = class extends import_obsidian4.Modal {
  // 标识是否允许关闭
  constructor(app, docToken, docUrl, title, plugin, isFromSettings = false) {
    super(app);
    // 标识是否从设置页面调用
    this.allowClose = false;
    this.docToken = docToken;
    this.docUrl = docUrl;
    this.title = title;
    this.plugin = plugin;
    this.isFromSettings = isFromSettings;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("obshare-feishu-permission-modal");
    new import_obsidian4.Setting(contentEl).setName("\u8BBE\u7F6E\u6587\u6863\u6743\u9650").setHeading();
    contentEl.createEl("p", { text: `\u4E3A\u6587\u6863 "${this.title}" \u8BBE\u7F6E\u8BBF\u95EE\u6743\u9650` });
    const permissionContainer = contentEl.createDiv("obshare-permission-options");
    const publicOption = permissionContainer.createDiv("obshare-permission-option");
    const publicCheckbox = publicOption.createEl("input", { type: "checkbox", cls: "obshare-permission-checkbox" });
    publicCheckbox.id = "isPublic";
    const publicLabel = publicOption.createEl("label", { text: "\u662F\u5426\u516C\u5F00\u6587\u6863\uFF1F", attr: { for: "isPublic" } });
    publicLabel.createEl("div", { text: "\u82E5\u60A8\u5F00\u542F\uFF0C\u60A8\u9700\u8981\u9075\u5B88\u98DE\u4E66\u7684\u76F8\u5173\u534F\u8BAE\uFF0C\u60A8\u4F5C\u4E3A\u6587\u6863\u6240\u6709\u8005\uFF0C\u9700\u5BF9\u5176\u5408\u6CD5\u5408\u89C4\u6027\u8D1F\u8D23\uFF0C\u4EFB\u4F55\u7531\u6B64\u4EA7\u751F\u7684\u7EA0\u7EB7\u4E0E\u672C\u63D2\u4EF6\u65E0\u5173\u3002", cls: "obshare-option-desc" });
    const copyOption = permissionContainer.createDiv("obshare-permission-option");
    const copyCheckbox = copyOption.createEl("input", { type: "checkbox", cls: "obshare-permission-checkbox" });
    copyCheckbox.id = "allowCopy";
    copyCheckbox.disabled = true;
    const copyLabel = copyOption.createEl("label", { text: "\u662F\u5426\u5141\u8BB8\u590D\u5236\uFF1F", attr: { for: "allowCopy" } });
    copyLabel.createEl("div", { text: "\u5141\u8BB8\u7528\u6237\u590D\u5236\u6587\u6863\u5185\u5BB9", cls: "obshare-option-desc" });
    const copyCreateOption = permissionContainer.createDiv("obshare-permission-option");
    const copyCreateCheckbox = copyCreateOption.createEl("input", { type: "checkbox", cls: "obshare-permission-checkbox" });
    copyCreateCheckbox.id = "allowCreateCopy";
    copyCreateCheckbox.disabled = true;
    const copyCreateLabel = copyCreateOption.createEl("label", { text: "\u662F\u5426\u5141\u8BB8\u521B\u5EFA\u526F\u672C\u3001\u6253\u5370\u3001\u4E0B\u8F7D\uFF1F", attr: { for: "allowCreateCopy" } });
    copyCreateLabel.createEl("div", { text: "\u5141\u8BB8\u7528\u6237\u521B\u5EFA\u6587\u6863\u526F\u672C\u3001\u6253\u5370\u548C\u4E0B\u8F7D\u6587\u6863", cls: "obshare-option-desc" });
    const currentPermissions = this.getCurrentPermissions();
    if (currentPermissions) {
      publicCheckbox.checked = currentPermissions.isPublic;
      copyCheckbox.checked = currentPermissions.allowCopy;
      copyCreateCheckbox.checked = currentPermissions.allowCreateCopy;
    }
    const updateOptionStates = () => {
      const isPublic = publicCheckbox.checked;
      copyCheckbox.disabled = !isPublic;
      copyCreateCheckbox.disabled = !isPublic;
      if (!isPublic) {
        copyCheckbox.checked = false;
        copyCreateCheckbox.checked = false;
      }
      if (isPublic) {
        copyOption.removeClass("obshare-permission-option-disabled");
        copyOption.addClass("obshare-permission-option-enabled");
        copyCreateOption.removeClass("obshare-permission-option-disabled");
        copyCreateOption.addClass("obshare-permission-option-enabled");
      } else {
        copyOption.removeClass("obshare-permission-option-enabled");
        copyOption.addClass("obshare-permission-option-disabled");
        copyCreateOption.removeClass("obshare-permission-option-enabled");
        copyCreateOption.addClass("obshare-permission-option-disabled");
      }
    };
    publicOption.onclick = () => {
      publicCheckbox.checked = !publicCheckbox.checked;
      updateOptionStates();
    };
    copyOption.onclick = () => {
      if (!copyCheckbox.disabled) {
        copyCheckbox.checked = !copyCheckbox.checked;
      }
    };
    copyCreateOption.onclick = () => {
      if (!copyCreateCheckbox.disabled) {
        copyCreateCheckbox.checked = !copyCreateCheckbox.checked;
      }
    };
    publicCheckbox.onclick = (e) => {
      e.stopPropagation();
      updateOptionStates();
    };
    copyCheckbox.onclick = (e) => {
      e.stopPropagation();
    };
    copyCreateCheckbox.onclick = (e) => {
      e.stopPropagation();
    };
    updateOptionStates();
    const buttonContainer = contentEl.createDiv("obshare-modal-button-container");
    const submitButton = buttonContainer.createEl("button", { text: "\u63D0\u4EA4\u8BBE\u7F6E", cls: "mod-cta" });
    submitButton.onclick = () => {
      void (async () => {
        const isPublic = publicCheckbox.checked;
        const allowCopy = copyCheckbox.checked;
        const allowCreateCopy = copyCreateCheckbox.checked;
        const permissions = {
          isPublic,
          allowCopy,
          allowCreateCopy,
          allowPrintDownload: allowCreateCopy,
          // 新增参数：根据用户选择设置特殊权限
          copyEntity: allowCopy ? "anyone_can_view" : "only_full_access",
          securityEntity: allowCreateCopy ? "anyone_can_view" : "only_full_access"
        };
        submitButton.disabled = true;
        submitButton.textContent = "\u8BBE\u7F6E\u4E2D...";
        try {
          if (!this.plugin.settings.userId) {
            throw new Error("\u8BF7\u5148\u5728\u8BBE\u7F6E\u4E2D\u914D\u7F6E\u60A8\u7684\u98DE\u4E66\u7528\u6237 ID");
          }
          if (this.isFromSettings) {
            await this.plugin.feishuClient.updateDocumentPermissionsOnly(this.docToken, permissions);
          } else {
            await this.plugin.feishuClient.setDocumentPermissions(this.docToken, permissions, this.plugin.settings.userId);
            await this.applyPermissionsToReferencedDocuments(permissions, this.plugin.settings.userId);
          }
          const permissionsToSave = {
            isPublic,
            allowCopy,
            allowCreateCopy
          };
          this.forceClose();
          if (!this.isFromSettings) {
            await this.plugin.updateHistoryPermissions(this.docToken, permissionsToSave);
            new UploadResultModal(this.app, this.docUrl, this.title).open();
          } else {
            await this.plugin.updateHistoryPermissions(this.docToken, permissionsToSave);
            this.plugin.notificationManager.showNotice("\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u6210\u529F", 3e3);
          }
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : String(error);
          console.error(`[\u98DE\u4E66\u63D2\u4EF6] \u6743\u9650\u8BBE\u7F6E\u5931\u8D25: ${errorMessage}`);
          if (this.plugin.settings.debugLoggingEnabled) {
            console.debug("[\u98DE\u4E66\u63D2\u4EF6] \u6743\u9650\u8BBE\u7F6E\u5931\u8D25\u8BE6\u60C5:", error);
          }
          this.plugin.notificationManager.showNotice(`\u6743\u9650\u8BBE\u7F6E\u5931\u8D25: ${errorMessage}`, 5e3, "permission-error");
          submitButton.disabled = false;
          submitButton.textContent = "\u63D0\u4EA4\u8BBE\u7F6E";
        }
      })();
    };
  }
  onClose() {
    if (this.isFromSettings || this.allowClose) {
      const { contentEl } = this;
      contentEl.empty();
      super.onClose();
    }
  }
  // 获取当前权限设置
  getCurrentPermissions() {
    const historyItem = this.plugin.settings.uploadHistory.find((item) => item.docToken === this.docToken);
    return (historyItem == null ? void 0 : historyItem.permissions) || null;
  }
  // 添加强制关闭方法，仅在权限设置成功后调用
  forceClose() {
    this.allowClose = true;
    this.close();
  }
  /**
   * 为引用文档设置相同的权限
   */
  async applyPermissionsToReferencedDocuments(permissions, userId) {
    try {
      const history = this.plugin.settings.uploadHistory.find((h) => h.docToken === this.docToken);
      if (!history) {
        return;
      }
      if (!history.referencedDocuments) {
        return;
      }
      if (history.referencedDocuments.length === 0) {
        return;
      }
      for (const refDoc of history.referencedDocuments) {
        try {
          await this.plugin.feishuClient.setDocumentPermissions(refDoc.docToken, permissions, userId);
          await this.plugin.updateHistoryPermissions(refDoc.docToken, {
            isPublic: permissions.isPublic,
            allowCopy: permissions.allowCopy,
            allowCreateCopy: permissions.allowCreateCopy
          });
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : String(error);
          console.error(`[\u98DE\u4E66\u63D2\u4EF6] \u5F15\u7528\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u5931\u8D25: ${refDoc.title}: ${errorMessage}`);
          if (this.plugin.settings.debugLoggingEnabled) {
            console.debug(`[\u98DE\u4E66\u63D2\u4EF6] \u5F15\u7528\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u5931\u8D25\u8BE6\u60C5: ${refDoc.title}`, error);
          }
        }
      }
    } catch (error) {
      const errorMessage = error instanceof Error ? error.message : String(error);
      console.error(`[\u98DE\u4E66\u63D2\u4EF6] \u5F15\u7528\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u8FC7\u7A0B\u51FA\u9519: ${errorMessage}`);
      if (this.plugin.settings.debugLoggingEnabled) {
        console.debug("[\u98DE\u4E66\u63D2\u4EF6] \u5F15\u7528\u6587\u6863\u6743\u9650\u8BBE\u7F6E\u8FC7\u7A0B\u51FA\u9519\u8BE6\u60C5:", error);
      }
    }
  }
  /**
   * 检测并转换 Callout
   */
};
var UploadResultModal = class extends import_obsidian4.Modal {
  constructor(app, url, title) {
    super(app);
    this.url = url;
    this.title = title;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("obshare-feishu-success-modal");
    const successTitle = "\u4E0A\u4F20\u6210\u529F\uFF01";
    const successMessage = `\u6587\u6863 "${this.title}" \u5DF2\u6210\u529F\u4E0A\u4F20\u5230\u98DE\u4E66\u4E91\u6587\u6863`;
    new import_obsidian4.Setting(contentEl).setName(successTitle).setHeading();
    contentEl.createEl("p", { text: successMessage });
    const linkEl = contentEl.createEl("a", {
      text: this.url,
      href: this.url
    });
    linkEl.setAttribute("target", "_blank");
    const buttonContainer = contentEl.createDiv("obshare-modal-button-container");
    const copyButton = buttonContainer.createEl("button", { text: "\u590D\u5236\u94FE\u63A5" });
    copyButton.onclick = () => {
      void navigator.clipboard.writeText(this.url).then(() => {
        new import_obsidian4.Notice("\u94FE\u63A5\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F");
      }).catch(() => {
        new import_obsidian4.Notice("\u590D\u5236\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u590D\u5236\u94FE\u63A5");
      });
    };
    const openButton = buttonContainer.createEl("button", { text: "\u6253\u5F00\u6587\u6863" });
    openButton.onclick = () => {
      window.open(this.url, "_blank");
    };
    const closeButton = buttonContainer.createEl("button", { text: "\u5173\u95ED" });
    closeButton.onclick = () => {
      this.close();
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
var RetryModal = class extends import_obsidian4.Modal {
  constructor(app, onRetry) {
    super(app);
    this.onRetry = onRetry;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    new import_obsidian4.Setting(contentEl).setName("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25").setHeading();
    const descEl = contentEl.createEl("div", { cls: "retry-modal-desc" });
    descEl.createEl("p", { text: "\u4E0A\u4F20\u5931\u8D25\uFF0C\u53EF\u80FD\u662F\u7F51\u7EDC\u8FDE\u63A5\u95EE\u9898\u3002" });
    descEl.createEl("p", { text: "\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5\uFF0C\u6216\u7A0D\u540E\u518D\u8BD5\u3002" });
    const buttonContainer = contentEl.createEl("div", { cls: "obshare-retry-modal-buttons" });
    const cancelBtn = buttonContainer.createEl("button", { text: "\u53D6\u6D88" });
    cancelBtn.onclick = () => {
      this.close();
    };
    const retryBtn = buttonContainer.createEl("button", { text: "\u91CD\u8BD5", cls: "mod-cta" });
    retryBtn.onclick = () => {
      this.close();
      this.onRetry();
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
var FeishuUploaderSettingTab = class extends import_obsidian4.PluginSettingTab {
  constructor(app, plugin) {
    super(app, plugin);
    this.plugin = plugin;
  }
  /**
   * 按页面聚合上传历史记录
   * @param uploadHistory 上传历史记录数组
   * @returns 按页面标题聚合的Map
   */
  groupUploadHistoryByPage(uploadHistory) {
    const groupedMap = /* @__PURE__ */ new Map();
    uploadHistory.forEach((item) => {
      const pageTitle = item.title;
      if (!groupedMap.has(pageTitle)) {
        groupedMap.set(pageTitle, {
          uploads: [],
          isReferencedDocument: item.isReferencedDocument || false
        });
      }
      groupedMap.get(pageTitle).uploads.push(item);
    });
    groupedMap.forEach((group) => {
      group.uploads.sort((a, b) => {
        const timeA = new Date(a.uploadTime.replace(" ", "T"));
        const timeB = new Date(b.uploadTime.replace(" ", "T"));
        return timeB.getTime() - timeA.getTime();
      });
    });
    const sortedEntries = Array.from(groupedMap.entries()).sort((a, b) => {
      const uploadsA = a[1].uploads;
      const uploadsB = b[1].uploads;
      if (uploadsA.length === 0 || uploadsB.length === 0) {
        return uploadsB.length - uploadsA.length;
      }
      const firstUploadA = uploadsA[0];
      const firstUploadB = uploadsB[0];
      if (!firstUploadA || !firstUploadB) {
        return 0;
      }
      const latestTimeA = new Date(firstUploadA.uploadTime.replace(" ", "T"));
      const latestTimeB = new Date(firstUploadB.uploadTime.replace(" ", "T"));
      return latestTimeB.getTime() - latestTimeA.getTime();
    });
    return new Map(sortedEntries);
  }
  display() {
    const { containerEl } = this;
    containerEl.empty();
    const headerContainer = containerEl.createDiv({ cls: "obshare-header-container" });
    const headerSetting = new import_obsidian4.Setting(headerContainer).setName("\u57FA\u7840\u8BBE\u7F6E").setHeading();
    headerSetting.nameEl.empty();
    const titleRow = headerSetting.nameEl.createDiv({ cls: "obshare-title-row" });
    titleRow.createSpan({ text: "\u57FA\u7840\u8BBE\u7F6E", cls: "obshare-settings-title" });
    const githubLink = titleRow.createEl("a", {
      href: "https://github.com/xigua222/ObShare",
      cls: "obshare-github-link"
    });
    githubLink.setAttribute("target", "_blank");
    const iconSpan = githubLink.createSpan({ cls: "obshare-github-link-icon" });
    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", "16");
    svg.setAttribute("height", "16");
    svg.setAttribute("viewBox", "0 0 48 48");
    svg.setAttribute("fill", "none");
    const pathOuter = document.createElementNS("http://www.w3.org/2000/svg", "path");
    pathOuter.setAttribute("fill-rule", "evenodd");
    pathOuter.setAttribute("clip-rule", "evenodd");
    pathOuter.setAttribute("d", "M24 4C12.9543 4 4 12.9543 4 24C4 35.0457 12.9543 44 24 44C35.0457 44 44 35.0457 44 24C44 12.9543 35.0457 4 24 4ZM0 24C0 10.7452 10.7452 0 24 0C37.2548 0 48 10.7452 48 24C48 37.2548 37.2548 48 24 48C10.7452 48 0 37.2548 0 24Z");
    pathOuter.setAttribute("fill", "currentColor");
    const pathInner = document.createElementNS("http://www.w3.org/2000/svg", "path");
    pathInner.setAttribute("fill-rule", "evenodd");
    pathInner.setAttribute("clip-rule", "evenodd");
    pathInner.setAttribute("d", "M19.1833 45.4716C18.9898 45.2219 18.9898 42.9973 19.1833 38.798C17.1114 38.8696 15.8024 38.7258 15.2563 38.3667C14.437 37.828 13.6169 36.1667 12.8891 34.9959C12.1614 33.8251 10.5463 33.64 9.89405 33.3783C9.24182 33.1165 9.07809 32.0496 11.6913 32.8565C14.3044 33.6634 14.4319 35.8607 15.2563 36.3745C16.0806 36.8883 18.0515 36.6635 18.9448 36.2519C19.8382 35.8403 19.7724 34.3078 19.9317 33.7007C20.1331 33.134 19.4233 33.0083 19.4077 33.0037C18.5355 33.0037 13.9539 32.0073 12.6955 27.5706C11.437 23.134 13.0581 20.2341 13.9229 18.9875C14.4995 18.1564 14.4485 16.3852 13.7699 13.6737C16.2335 13.3589 18.1347 14.1343 19.4734 16.0001C19.4747 16.0108 21.2285 14.9572 24.0003 14.9572C26.772 14.9572 27.7553 15.8154 28.5142 16.0001C29.2731 16.1848 29.88 12.7341 34.5668 13.6737C33.5883 15.5969 32.7689 18.0001 33.3943 18.9875C34.0198 19.9749 36.4745 23.1147 34.9666 27.5706C33.9614 30.5413 31.9853 32.3523 29.0384 33.0037C28.7005 33.1115 28.5315 33.2855 28.5315 33.5255C28.5315 33.8856 28.9884 33.9249 29.6465 35.6117C30.0853 36.7362 30.117 39.948 29.7416 45.247C28.7906 45.4891 28.0508 45.6516 27.5221 45.7347C26.5847 45.882 25.5669 45.9646 24.5669 45.9965C23.5669 46.0284 23.2196 46.0248 21.837 45.8961C20.9154 45.8103 20.0308 45.6688 19.1833 45.4716Z");
    pathInner.setAttribute("fill", "currentColor");
    svg.appendChild(pathOuter);
    svg.appendChild(pathInner);
    iconSpan.appendChild(svg);
    githubLink.createSpan({ text: "Star on GitHub" });
    const encourageText = headerContainer.createEl("div", {
      text: "\u63D2\u4EF6\u5B8C\u5168\u514D\u8D39\u5F00\u6E90\uFF0C\u5982\u679C\u60A8\u559C\u6B22\u8FD9\u4E2A\u63D2\u4EF6\uFF0C\u6073\u8BF7\u5E2E\u5FD9\u70B9\u4E2A star\uFF0C\u8FD9\u4F1A\u662F\u5BF9\u4F5C\u8005\u6781\u5927\u7684\u9F13\u52B1~",
      cls: "obshare-encourage-text"
    });
    const descEl = containerEl.createDiv();
    descEl.createEl("p", { text: "\u4F60\u9700\u8981\u914D\u7F6E\u98DE\u4E66\u5E94\u7528 app ID\u3001app secret\u3001\u60A8\u7684\u98DE\u4E66\u7528\u6237 ID\u3001\u60A8\u7684\u6587\u4EF6\u5939 token \u624D\u80FD\u6B63\u5E38\u542F\u52A8\u6B64\u63D2\u4EF6" });
    const docLinkP = descEl.createEl("p");
    docLinkP.createSpan({ text: "\u5B8C\u6210\u914D\u7F6E\u9884\u8BA1\u9700\u89815-10\u5206\u949F\uFF0C\u8BF7\u53C2\u9605\uFF1A" });
    const docLink = docLinkP.createEl("a", {
      text: "\u5FEB\u901F\u914D\u7F6E\u60A8\u7684 Obshare",
      href: "https://itlueqqx8t.feishu.cn/docx/XUJmdxbf7octOFx3Vt0c3KJ3nWe"
    });
    docLink.setAttribute("target", "_blank");
    const appIdSetting = new import_obsidian4.Setting(containerEl).setName("App ID").setDesc("\u98DE\u4E66\u5E94\u7528\u7684 app ID").addText((text) => text.setPlaceholder("\u8F93\u5165 app ID").setValue(this.plugin.settings.appId).onChange((value) => {
      this.plugin.settings.appId = value;
      void this.plugin.saveSettings();
    }));
    appIdSetting.nameEl.empty();
    appIdSetting.nameEl.createSpan({ text: "App ID " });
    appIdSetting.nameEl.createSpan({ text: "*", cls: "obshare-required-field" });
    const appSecretSetting = new import_obsidian4.Setting(containerEl).setName("App secret").setDesc("\u98DE\u4E66\u5E94\u7528\u7684 app secret").addText((text) => text.setPlaceholder("\u8F93\u5165 app secret").setValue(this.plugin.settings.appSecret).onChange((value) => {
      this.plugin.settings.appSecret = value;
      void this.plugin.saveSettings();
    }));
    appSecretSetting.nameEl.empty();
    appSecretSetting.nameEl.createSpan({ text: "App secret " });
    appSecretSetting.nameEl.createSpan({ text: "*", cls: "obshare-required-field" });
    const userIdSetting = new import_obsidian4.Setting(containerEl).setName("\u7528\u6237 ID").setDesc("\u60A8\u7684\u98DE\u4E66\u7528\u6237 ID").addText((text) => text.setPlaceholder("\u8F93\u5165\u60A8\u7684\u98DE\u4E66\u7528\u6237 ID").setValue(this.plugin.settings.userId).onChange((value) => {
      this.plugin.settings.userId = value;
      void this.plugin.saveSettings();
    }));
    userIdSetting.nameEl.empty();
    userIdSetting.nameEl.createSpan({ text: "\u7528\u6237 ID " });
    userIdSetting.nameEl.createSpan({ text: "*", cls: "obshare-required-field" });
    const folderTokenSetting = new import_obsidian4.Setting(containerEl).setName("\u6587\u4EF6\u5939 token").setDesc("\u98DE\u4E66\u4E91\u7A7A\u95F4\u6587\u4EF6\u5939\u7684 token\uFF0C\u6587\u6863\u5C06\u4E0A\u4F20\u5230\u6B64\u6587\u4EF6\u5939").addText((text) => text.setPlaceholder("\u8F93\u5165\u6587\u4EF6\u5939 token").setValue(this.plugin.settings.folderToken).onChange((value) => {
      this.plugin.settings.folderToken = value;
      void this.plugin.saveSettings();
    }));
    folderTokenSetting.nameEl.empty();
    folderTokenSetting.nameEl.createSpan({ text: "\u6587\u4EF6\u5939 token " });
    folderTokenSetting.nameEl.createSpan({ text: "*", cls: "obshare-required-field" });
    new import_obsidian4.Setting(containerEl).setName("\u4E0A\u4F20\u8BBE\u7F6E").setHeading();
    new import_obsidian4.Setting(containerEl).setName("\u53CC\u94FE\u6A21\u5F0F").setDesc("\u53CC\u94FE\u6A21\u5F0F\u53EF\u4EE5\u81EA\u52A8\u5E2E\u4F60\u4E0A\u4F20\u6587\u6863\u5185\u6240\u6709[[]]\u5F15\u7528\u7684\u6587\u6863\uFF0C\u81EA\u52A8\u5EFA\u7ACB\u94FE\u63A5\uFF0C\u4F7F\u5F97\u60A8\u7684\u5206\u4EAB\u66F4\u52A0\u4FBF\u6377\u5B8C\u6574\uFF0C\u4F46\u5728\u5F15\u7528\u6587\u6863\u6570\u91CF\u591A\u7684\u60C5\u51B5\u4E0B\uFF0C\u53EF\u80FD\u4F7F\u4E0A\u4F20\u901F\u5EA6\u53D8\u6162\uFF0C\u9700\u8981\u7B49\u5F85\u66F4\u4E45\u3002").addToggle((toggle) => toggle.setValue(this.plugin.settings.enableDoubleLinkMode).onChange((value) => {
      this.plugin.settings.enableDoubleLinkMode = value;
      void this.plugin.saveSettings();
    }));
    new import_obsidian4.Setting(containerEl).setName("\u8C03\u8BD5\u65E5\u5FD7").setDesc("\u542F\u7528\u540E\u4F1A\u5728\u5F00\u53D1\u8005\u63A7\u5236\u53F0\u8F93\u51FA\u8C03\u8BD5\u4FE1\u606F\uFF0C\u7528\u4E8E\u6392\u67E5\u95EE\u9898\u3002").addToggle((toggle) => toggle.setValue(this.plugin.settings.debugLoggingEnabled).onChange((value) => {
      this.plugin.settings.debugLoggingEnabled = value;
      this.plugin.applyDebugLoggingSetting();
      void this.plugin.saveSettings();
    }));
    new import_obsidian4.Setting(containerEl).setName("\u6D4B\u8BD5\u8FDE\u63A5").setDesc("\u6D4B\u8BD5\u98DE\u4E66 API \u8FDE\u63A5\u662F\u5426\u6B63\u5E38").addButton((button) => button.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5").onClick(() => {
      void (async () => {
        if (!this.plugin.feishuClient) {
          this.plugin.notificationManager.showNotice("\u8BF7\u5148\u914D\u7F6E app ID \u548C app secret", 4e3, "missing-config");
          return;
        }
        try {
          button.setButtonText("\u6D4B\u8BD5\u4E2D...");
          const success = await this.plugin.testNetworkConnection();
          if (success) {
            this.plugin.notificationManager.showNotice("\u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u6210\u529F\uFF01", 3e3, "test-success");
          } else {
            new import_obsidian4.Notice("\u7F51\u7EDC\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u548C\u914D\u7F6E");
          }
        } catch (error) {
          const errorMessage = error instanceof Error ? error.message : String(error);
          if (errorMessage.includes("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25")) {
            new import_obsidian4.Notice("\u7F51\u7EDC\u8FDE\u63A5\u5931\u8D25\uFF0C\u8BF7\u68C0\u67E5\u7F51\u7EDC\u8FDE\u63A5\u540E\u91CD\u8BD5");
          } else {
            new import_obsidian4.Notice(`\u8FDE\u63A5\u6D4B\u8BD5\u5931\u8D25: ${errorMessage}`);
          }
        } finally {
          button.setButtonText("\u6D4B\u8BD5\u8FDE\u63A5");
        }
      })();
    }));
    new import_obsidian4.Setting(containerEl).setName("\u6570\u636E\u7EDF\u8BA1").setHeading();
    new import_obsidian4.Setting(containerEl).setName("\u5206\u4EAB\u6587\u6863\u6570").setDesc(`\u60A8\u5DF2\u6210\u529F\u5206\u4EAB ${this.plugin.settings.uploadCount} \u4E2A\u6587\u6863`).addButton((button) => button.setButtonText("\u91CD\u7F6E\u8BA1\u6570").setWarning().onClick(() => {
      void (async () => {
        await this.plugin.resetUploadCount();
        this.display();
      })();
    }));
    const currentMonth = new Date().toISOString().substring(0, 7);
    const isCurrentMonth = this.plugin.settings.lastResetDate === currentMonth;
    const displayCount = isCurrentMonth ? this.plugin.settings.apiCallCount : 0;
    new import_obsidian4.Setting(containerEl).setName("\u672C\u6708 API \u8C03\u7528\u6B21\u6570").setDesc(`\u672C\u6708\u5DF2\u8C03\u7528\u98DE\u4E66 API ${displayCount} \u6B21`).addButton((button) => button.setButtonText("\u91CD\u7F6E\u8BA1\u6570").setWarning().onClick(() => {
      void (async () => {
        await this.plugin.resetApiCallCount();
        this.display();
      })();
    }));
    new import_obsidian4.Setting(containerEl).setName("\u5206\u4EAB\u7BA1\u7406").setHeading();
    if (this.plugin.settings.uploadHistory.length === 0) {
      containerEl.createEl("p", { text: "\u6682\u65E0\u4E0A\u4F20\u8BB0\u5F55", cls: "obshare-upload-history-empty" });
    } else {
      new import_obsidian4.Setting(containerEl).setName("\u6E05\u7A7A\u5386\u53F2\u8BB0\u5F55").setDesc("\u5206\u4EAB\u5386\u53F2\u8BB0\u5F55").addButton((button) => button.setButtonText("\u6E05\u7A7A").setWarning().onClick(() => {
        void (async () => {
          await this.plugin.clearUploadHistory();
          this.display();
        })();
      }));
      const groupedHistory = this.groupUploadHistoryByPage(this.plugin.settings.uploadHistory);
      const historyContainer = containerEl.createDiv("obshare-upload-history-container");
      groupedHistory.forEach((pageGroup, pageTitle) => {
        const pageGroupContainer = historyContainer.createDiv("obshare-page-group-container");
        const pageGroupHeader = pageGroupContainer.createDiv("obshare-page-group-header");
        const groupTitleText = pageGroup.isReferencedDocument ? `\u{1F517} ${pageTitle}` : pageTitle;
        const groupTitleEl = pageGroupHeader.createEl("div", {
          text: groupTitleText,
          cls: "obshare-page-group-title"
        });
        const uploadCountEl = pageGroupHeader.createEl("div", {
          text: `${pageGroup.uploads.length} \u6B21\u4E0A\u4F20`,
          cls: "obshare-page-group-count"
        });
        const uploadsContainer = pageGroupContainer.createDiv("obshare-page-uploads-container");
        pageGroup.uploads.forEach((item, index) => {
          const historyItem = uploadsContainer.createDiv("obshare-upload-history-item");
          if (index === 0) {
            historyItem.addClass("obshare-upload-history-item-latest");
          }
          const headerEl = historyItem.createDiv("obshare-upload-history-header");
          const timeContainer = headerEl.createDiv("obshare-upload-time-container");
          const timeEl = timeContainer.createEl("div", {
            text: item.uploadTime,
            cls: "obshare-upload-history-time"
          });
          if (index === 0) {
            const newTagEl = timeContainer.createEl("span", {
              text: "New",
              cls: "obshare-upload-new-tag"
            });
          }
          const linkRowEl = historyItem.createDiv("obshare-upload-history-link-row");
          const linkEl = linkRowEl.createEl("a", {
            text: item.url,
            href: item.url,
            cls: "obshare-upload-history-link"
          });
          linkEl.setAttribute("target", "_blank");
          const copyIcon = linkRowEl.createEl("span", {
            text: "\u{1F4CB}",
            cls: "obshare-upload-history-copy-icon"
          });
          copyIcon.onclick = () => {
            void navigator.clipboard.writeText(item.url).then(() => {
              new import_obsidian4.Notice("\u94FE\u63A5\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F");
            }).catch(() => {
              new import_obsidian4.Notice("\u590D\u5236\u5931\u8D25\uFF0C\u8BF7\u624B\u52A8\u590D\u5236\u94FE\u63A5");
            });
          };
          const permissionIcon = linkRowEl.createEl("span", {
            text: "\u8BBE\u7F6E",
            cls: "obshare-upload-history-copy-icon"
          });
          permissionIcon.onclick = () => {
            const permissionModal = new DocumentPermissionModal(
              this.app,
              item.docToken,
              item.url,
              item.title,
              this.plugin,
              true
              // isFromSettings = true
            );
            permissionModal.open();
          };
          const deleteIcon = linkRowEl.createEl("span", {
            text: "\u5220\u9664",
            cls: "obshare-upload-history-copy-icon"
          });
          deleteIcon.onclick = () => {
            const modal = new DeleteConfirmationModal(
              this.app,
              `\u786E\u5B9A\u8981\u5220\u9664\u6587\u4EF6 "${item.title}" \u5417\uFF1F

\u6CE8\u610F\uFF1A\u6B64\u64CD\u4F5C\u5C06\u5220\u9664\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u7684\u6587\u4EF6\uFF01`,
              async () => {
                await this.plugin.deleteHistoryItem(item.docToken);
                this.display();
                try {
                  if (this.plugin.feishuClient) {
                    await this.plugin.feishuClient.deleteFile(item.docToken);
                    await this.plugin.incrementApiCallCount();
                  }
                } catch (error) {
                  const errorMessage = error instanceof Error ? error.message : String(error);
                  console.error(`[\u8BBE\u7F6E\u9875\u9762] API\u5220\u9664\u6587\u4EF6\u5931\u8D25: ${errorMessage}`);
                  if (this.plugin.settings.debugLoggingEnabled) {
                    console.debug("[\u8BBE\u7F6E\u9875\u9762] API\u5220\u9664\u6587\u4EF6\u5931\u8D25\u8BE6\u60C5:", error);
                  }
                  if (error instanceof Error && (error.message.includes("404") || error.message.includes("not found"))) {
                    this.plugin.notificationManager.showNotice(
                      "\u5220\u9664\u5931\u8D25\uFF0C\u8BF7\u60A8\u5728\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u81EA\u884C\u5C1D\u8BD5\u5220\u9664\u3002",
                      5e3
                    );
                  } else {
                    this.plugin.notificationManager.showNotice(
                      "\u5220\u9664\u5931\u8D25\uFF0C\u8BF7\u60A8\u5728\u98DE\u4E66\u4E91\u6587\u6863\u4E2D\u81EA\u884C\u5C1D\u8BD5\u5220\u9664\u3002",
                      5e3
                    );
                  }
                }
              }
            );
            modal.open();
          };
        });
      });
    }
  }
};
var DeleteConfirmationModal = class extends import_obsidian4.Modal {
  constructor(app, message, onConfirm) {
    super(app);
    this.message = message;
    this.onConfirm = onConfirm;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    new import_obsidian4.Setting(contentEl).setName("\u786E\u8BA4\u5220\u9664").setHeading();
    contentEl.createEl("p", { text: this.message });
    const buttonContainer = contentEl.createDiv("obshare-modal-button-container");
    const confirmButton = buttonContainer.createEl("button", { text: "\u786E\u8BA4\u5220\u9664", cls: "mod-warning" });
    const cancelButton = buttonContainer.createEl("button", { text: "\u53D6\u6D88" });
    cancelButton.onclick = () => {
      this.close();
    };
    confirmButton.onclick = () => {
      void Promise.resolve(this.onConfirm()).finally(() => {
        this.close();
      });
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
var UploadProgressModal = class extends import_obsidian4.Modal {
  // 伪进度最大值
  constructor(app) {
    super(app);
    // 添加标题元素引用
    this.currentProgress = 0;
    this.currentStep = "";
    this.isCompleted = false;
    this.fakeProgressTimer = null;
    this.lastRealProgress = 0;
    this.maxFakeProgress = 90;
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("obshare-feishu-upload-progress-modal");
    const titleText = "\u6B63\u5728\u4E0A\u4F20\u6587\u6863";
    const titleSetting = new import_obsidian4.Setting(contentEl).setName(titleText).setHeading();
    this.titleElement = titleSetting.nameEl;
    this.titleElement.addClass("obshare-progress-modal-title");
    this.stepText = contentEl.createEl("div", { text: "\u51C6\u5907\u4E0A\u4F20...", cls: "obshare-progress-modal-step" });
    const progressContainer = contentEl.createDiv("obshare-feishu-upload-progress");
    this.progressText = progressContainer.createEl("div", { text: "0%", cls: "obshare-progress-text" });
    const progressBarBg = progressContainer.createEl("div", { cls: "obshare-progress-bar" });
    this.progressBar = progressBarBg.createEl("div", { cls: "obshare-progress-fill" });
    this.progressBar.setCssProps({ "--obshare-progress-width": "0%" });
    this.stepText = contentEl.createEl("div", { text: "\u51C6\u5907\u4E0A\u4F20...", cls: "obshare-progress-modal-step" });
    contentEl.createEl("div", { text: "\u8BF7\u4FDD\u6301\u7F51\u7EDC\u8FDE\u63A5\uFF0C\u4E0D\u8981\u5173\u95ED\u6B64\u7A97\u53E3", cls: "obshare-progress-hint" });
    this.startFakeProgress();
  }
  /**
   * 更新进度
   * @param progress 进度百分比 (0-100)
   * @param step 当前步骤描述
   */
  updateProgress(progress, step) {
    const targetProgress = Math.min(100, Math.max(0, progress));
    if (targetProgress > this.lastRealProgress) {
      this.lastRealProgress = targetProgress;
      this.stopFakeProgress();
      this.setProgress(targetProgress);
      if (targetProgress < this.maxFakeProgress && !this.isCompleted) {
        this.startFakeProgress();
      }
    }
    this.currentStep = step;
    if (this.stepText) {
      this.stepText.textContent = step;
    }
  }
  /**
   * 设置进度条显示
   * @param progress 进度百分比
   */
  setProgress(progress) {
    this.currentProgress = progress;
    if (this.progressBar) {
      this.progressBar.setCssProps({ "--obshare-progress-width": `${this.currentProgress}%` });
    }
    if (this.progressText) {
      this.progressText.textContent = `${Math.round(this.currentProgress)}%`;
    }
  }
  /**
   * 启动伪进度
   */
  startFakeProgress() {
    this.stopFakeProgress();
    const fakeProgressStep = () => {
      if (this.isCompleted) {
        return;
      }
      const remainingProgress = this.maxFakeProgress - this.currentProgress;
      if (remainingProgress > 0) {
        const increment = Math.max(0.1, remainingProgress * 0.02);
        const newProgress = Math.min(this.maxFakeProgress, this.currentProgress + increment);
        this.setProgress(newProgress);
        this.fakeProgressTimer = setTimeout(fakeProgressStep, 200);
      }
    };
    this.fakeProgressTimer = setTimeout(fakeProgressStep, 200);
  }
  /**
   * 停止伪进度
   */
  stopFakeProgress() {
    if (this.fakeProgressTimer) {
      clearTimeout(this.fakeProgressTimer);
      this.fakeProgressTimer = null;
    }
  }
  /**
   * 标记为完成状态
   */
  complete() {
    this.isCompleted = true;
    this.stopFakeProgress();
    this.setProgress(100);
    this.currentStep = "\u4E0A\u4F20\u5B8C\u6210\uFF0C\u6B63\u5728\u8BBE\u7F6E\u6743\u9650...";
    if (this.stepText) {
      this.stepText.textContent = this.currentStep;
    }
    setTimeout(() => {
      this.close();
    }, 800);
  }
  /**
   * 显示错误状态
   * @param errorMessage 错误信息
   */
  showError(errorMessage) {
    if (this.stepText) {
      this.stepText.textContent = `\u4E0A\u4F20\u5931\u8D25: ${errorMessage}`;
      this.stepText.addClass("obshare-progress-error");
    }
    if (this.progressBar) {
      this.progressBar.addClass("obshare-progress-error");
    }
    setTimeout(() => {
      this.close();
    }, 3e3);
  }
  onClose() {
    this.stopFakeProgress();
    const { contentEl } = this;
    contentEl.empty();
  }
};
var UserAgreementModal = class extends import_obsidian4.Modal {
  constructor(app, plugin) {
    super(app);
    this.plugin = plugin;
    this.component = new import_obsidian4.Component();
  }
  onOpen() {
    const { contentEl } = this;
    contentEl.empty();
    contentEl.addClass("obshare-user-agreement-modal");
    new import_obsidian4.Setting(contentEl).setName("Obshare \u7528\u6237\u534F\u8BAE").setHeading();
    const agreementContainer = contentEl.createDiv({ cls: "obshare-agreement-content" });
    const agreementText = `\u6B22\u8FCE\u4F7F\u7528ObShare\uFF08\u4EE5\u4E0B\u7B80\u79F0"\u672C\u63D2\u4EF6"\uFF09\u3002\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u4E4B\u524D\uFF0C\u8BF7\u60A8\u4ED4\u7EC6\u9605\u8BFB\u5E76\u7406\u89E3\u4EE5\u4E0B\u6761\u6B3E\u3002\u4F7F\u7528\u672C\u63D2\u4EF6\u5373\u89C6\u4E3A\u60A8\u5DF2\u540C\u610F\u5E76\u9075\u5B88\u672C\u534F\u8BAE\u3002

\u672C\u63D2\u4EF6\u662F\u4E00\u6B3E\u7528\u4E8E\u5C06\u60A8\u50A8\u5B58\u5728\u672C\u5730Obsidian\u7B14\u8BB0\u901A\u8FC7\u98DE\u4E66\uFF08\u4E0B\u79F0"\u76EE\u6807\u670D\u52A1"\uFF09\u5F00\u653E\u5E73\u53F0 api \u63A5\u53E3\u4E0A\u4F20\u5230\u60A8\u7684\u98DE\u4E66\u8D26\u53F7\u6240\u5C5E\u7684\u4E91\u7A7A\u95F4/\u4E91\u6587\u6863\uFF0C\u4ECE\u800C\u4F7F\u5F97\u60A8\u53EF\u4EE5\u66F4\u52A0\u65B9\u4FBF\u5206\u4EAB\u548C\u7BA1\u7406\u81EA\u5DF1\u7684\u7B14\u8BB0\u3002

\u5F53\u60A8\u4F7F\u7528\u63D2\u4EF6\u5C06\u7B14\u8BB0\u4E0A\u4F20\u81F3\u98DE\u4E66\u6587\u6863\u65F6\uFF1A\u8BE5\u6587\u6863\u7684\u5185\u5BB9\u7531\u60A8\u63D0\u4F9B\uFF1B\u6587\u6863\u7684\u53EF\u89C1\u6027\uFF08\u516C\u5F00/\u79C1\u6709\uFF09\u6743\u9650\u8BBE\u7F6E\u7531\u60A8\u63A7\u5236\uFF1B\u82E5\u5F00\u542F\u516C\u5F00\u94FE\u63A5\uFF0C\u4EFB\u4F55\u80FD\u8BBF\u95EE\u94FE\u63A5\u7684\u4EBA\u90FD\u53EF\u67E5\u770B\u3002

\u4E00\u65E6\u6570\u636E\u79BB\u5F00\u60A8\u7684\u8BBE\u5907\u8FDB\u5165\u76EE\u6807\u670D\u52A1\uFF08"\u98DE\u4E66"\u53CA\u5176\u4ED6\u53EF\u80FD\u7684\u670D\u52A1\u5546\uFF09\uFF0C\u540E\u7EED\u7684\u5B58\u50A8\u3001\u8BBF\u95EE\u3001\u5206\u4EAB\u3001\u7F13\u5B58\u3001\u65E5\u5FD7\u8BB0\u5F55\u7B49\u90FD\u9075\u5FAA\u5176\u81EA\u8EAB\u7684\u9690\u79C1\u653F\u7B56\u4E0E\u670D\u52A1\u6761\u6B3E\u3002\u60A8\u7406\u89E3\uFF0C\u5982\u98DE\u4E66\u53D1\u751F\u6570\u636E\u6CC4\u9732\u3001\u6587\u6863\u8BEF\u5220\u6216\u63A5\u53E3\u53D8\u66F4\u5BFC\u81F4\u4E0A\u4F20\u5931\u8D25\u7B49\u60C5\u51B5\uFF0C\u4E0E\u672C\u63D2\u4EF6\u65E0\u5173\u3002

## \u4E00\u3001\u9690\u79C1\u4E0E\u5B89\u5168

1. **\u6240\u6709\u6570\u636E\u5904\u7406\u5747\u5728\u672C\u5730\u5B8C\u6210\u3002** \u6211\u4EEC\u9AD8\u5EA6\u91CD\u89C6\u60A8\u7684\u9690\u79C1\uFF0C\u672C\u63D2\u4EF6\u7684\u6240\u6709\u529F\u80FD\u8FD0\u884C\u5747\u5728\u60A8\u7684\u8BBE\u5907\u672C\u5730\u8FDB\u884C\uFF0C\u4E0A\u4F20\u884C\u4E3A\u5C06\u53EA\u5728\u60A8\u7684\u8BBE\u5907\u4E0E\u76EE\u6807\u670D\u52A1\uFF08"\u98DE\u4E66"\u53CA\u5176\u4ED6\u53EF\u80FD\u7684\u670D\u52A1\u5546\uFF09\u4E4B\u95F4\u8FDB\u884C\uFF0C\u4E0D\u4F1A\u5C06\u4EFB\u4F55\u5185\u5BB9\u3001\u7B14\u8BB0\u3001\u914D\u7F6E\u6216\u5143\u6570\u636E\u4E0A\u4F20\u81F3\u4EFB\u4F55\u7B2C\u4E09\u65B9\u3002

2. **\u7EDD\u4E0D\u6536\u96C6\u3001\u5B58\u50A8\u6216\u4F20\u8F93\u7528\u6237\u6570\u636E\u3002** \u6211\u4EEC**\u4E0D\u6536\u96C6\u3001\u4E0D\u5206\u6790\u3001\u4E0D\u5171\u4EAB**\u4EFB\u4F55\u7528\u6237\u7684\u7B14\u8BB0\u5185\u5BB9\u3001\u6587\u4EF6\u8DEF\u5F84\u3001\u6807\u7B7E\u3001\u8BBE\u7F6E\u4FE1\u606F\u6216\u5176\u4ED6\u4E2A\u4EBA\u6570\u636E\u3002\u65E0\u8BBA\u4F55\u79CD\u60C5\u51B5\uFF0C\u60A8\u7684\u6570\u636E\u59CB\u7EC8\u5C5E\u4E8E\u60A8\u672C\u4EBA\u3002\u60A8\u7684\u76F8\u5173\u8BBE\u7F6E\u4FE1\u606F\u3001\u654F\u611F\u4EE4\u724C\u6216\u5176\u4ED6\u4F7F\u7528\u672C\u63D2\u4EF6\u65F6\u4EA7\u751F\u7684\u6570\u636E\uFF0C\u5C06\u50A8\u5B58\u5728\u60A8\u7684\u8BBE\u5907\u672C\u5730\uFF0C\u60A8\u53EF\u4EE5\u5728\u672C\u63D2\u4EF6\u6587\u4EF6\u5939 \`data.json\` \u4E2D\u968F\u65F6\u67E5\u770B\u3002

3. **\u65E0\u76D1\u63A7\u3001\u65E0\u8FFD\u8E2A\u3001\u65E0\u5E7F\u544A\u3002** \u672C\u63D2\u4EF6\u4E0D\u4F1A\u542F\u7528\u4EFB\u4F55\u5F62\u5F0F\u7684\u6570\u636E\u8FFD\u8E2A\u3001\u7528\u6237\u884C\u4E3A\u76D1\u63A7\u3001\u6027\u80FD\u7EDF\u8BA1\u6216\u5E7F\u544A\u6295\u653E\u673A\u5236\u3002

4. **\u900F\u660E\u4E0E\u53EF\u5BA1\u8BA1**\u3002\u672C\u63D2\u4EF6\u6E90\u4EE3\u7801\u5B8C\u5168\u5F00\u6E90\uFF0C\u60A8\u53EF\u4EE5\u81EA\u7531\u67E5\u770B\u3001\u5BA1\u67E5\u548C\u9A8C\u8BC1\u5176\u884C\u4E3A\u3002\u6211\u4EEC\u9F13\u52B1\u793E\u533A\u53C2\u4E0E\u4EE3\u7801\u5BA1\u8BA1\uFF0C\u5171\u540C\u7EF4\u62A4\u9690\u79C1\u5B89\u5168\u3002

## \u4E8C\u3001\u4E0A\u4F20\u884C\u4E3A\u8D23\u4EFB\u8BF4\u660E

1. **\u63D2\u4EF6\u672C\u8EAB\u4E0D\u4E3B\u52A8\u4E0A\u4F20\u6570\u636E**\u3002\u672C\u63D2\u4EF6\u4E0D\u4F1A\u81EA\u52A8\u6216\u9ED8\u8BA4\u5C06\u4EFB\u4F55\u5185\u5BB9\u4E0A\u4F20\u81F3\u4E92\u8054\u7F51\u3002\u82E5\u67D0\u529F\u80FD\u6D89\u53CA\u7F51\u7EDC\u8BF7\u6C42\uFF08\u5982\u4E0B\u8F7D\u6A21\u677F\u3001\u83B7\u53D6\u66F4\u65B0\u3001\u8BBF\u95EE\u516C\u5F00 API \u7B49\uFF09\uFF0C\u8BE5\u884C\u4E3A\u5FC5\u987B\u7531\u7528\u6237\u4E3B\u52A8\u89E6\u53D1\uFF0C\u6216\u8005\u5C06\u660E\u786E\u63D0\u793A\u7528\u6237\uFF0C\u5E76\u9700\u7528\u6237**\u4E3B\u52A8\u786E\u8BA4**\u540E\u65B9\u53EF\u6267\u884C\u3002

2. **\u7528\u6237\u81EA\u884C\u627F\u62C5\u4E0A\u4F20\u98CE\u9669**\u3002\u82E5\u60A8\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u65F6\u9009\u62E9\u901A\u8FC7\u5176\u529F\u80FD\u4E0A\u4F20\u6587\u4EF6\u3001\u540C\u6B65\u5230\u4E91\u670D\u52A1\u3001\u53D1\u9001\u81F3\u5916\u90E8\u63A5\u53E3\u7B49\u64CD\u4F5C\uFF0C**\u8BE5\u884C\u4E3A\u5B8C\u5168\u7531\u60A8\u81EA\u4E3B\u51B3\u5B9A**\u3002\u60A8\u5E94\u5145\u5206\u4E86\u89E3\u76EE\u6807\u670D\u52A1\uFF08"\u98DE\u4E66"\u53CA\u5176\u4ED6\u53EF\u80FD\u7684\u670D\u52A1\u5546\uFF09\u7684\u9690\u79C1\u653F\u7B56\u53CA\u6570\u636E\u5904\u7406\u65B9\u5F0F\uFF0C\u5E76\u81EA\u884C\u627F\u62C5\u7531\u6B64\u4EA7\u751F\u7684\u4EFB\u4F55\u98CE\u9669\u3002\u82E5\u60A8\u5F00\u542F\u4E92\u8054\u7F51\u516C\u5F00\u529F\u80FD\uFF0C\u4F60\u9700\u8981\u9075\u5B88\u76EE\u6807\u670D\u52A1\u7684\u7BA1\u7406\u89C4\u5B9A\uFF0C\u8BE5\u529F\u80FD\u5F00\u542F\u540E\uFF0C\u4E92\u8054\u7F51\u4E0A\u83B7\u5F97\u94FE\u63A5\u7684\u4EBA\u90FD\u80FD\u591F\u8BBF\u95EE\u8BE5\u6587\u6863\u3002\u60A8\u4F5C\u4E3A\u6587\u6863\u6240\u6709\u8005\uFF0C\u9700\u5BF9\u5176\u5408\u6CD5\u5408\u89C4\u6027\u8D1F\u8D23\uFF0C\u4E0E\u672C\u63D2\u4EF6\u65E0\u5173\u3002

3. **\u6211\u4EEC\u4E0D\u5BF9\u7B2C\u4E09\u65B9\u670D\u52A1\u8D1F\u8D23**\u3002\u4E00\u65E6\u6570\u636E\u79BB\u5F00\u60A8\u7684\u8BBE\u5907\uFF0C\u5176\u540E\u7EED\u5904\u7406\u4E0D\u518D\u53D7\u672C\u63D2\u4EF6\u63A7\u5236\u3002\u6211\u4EEC\u4E0D\u5BF9\u7B2C\u4E09\u65B9\u5E73\u53F0\u7684\u884C\u4E3A\u3001\u6570\u636E\u6CC4\u9732\u3001\u6EE5\u7528\u6216\u4E22\u5931\u627F\u62C5\u8D23\u4EFB\u3002

## \u4E09\u3001\u77E5\u8BC6\u4EA7\u6743\u4E0E\u8BB8\u53EF

1. **\u63D2\u4EF6\u8457\u4F5C\u6743\u5F52\u5C5E**\u3002\u672C\u63D2\u4EF6\u53CA\u5176\u6240\u6709\u6E90\u4EE3\u7801\u3001\u6587\u6863\u3001\u56FE\u6807\u3001\u754C\u9762\u8BBE\u8BA1\u7B49\u5185\u5BB9\uFF08\u4EE5\u4E0B\u7B80\u79F0"\u4F5C\u54C1"\uFF09\u7684\u8457\u4F5C\u6743\u53CA\u76F8\u5173\u77E5\u8BC6\u4EA7\u6743\u5747\u5F52\u539F\u4F5C\u8005\u53CA\u8D21\u732E\u8005\u6240\u6709\u3002\u672A\u7ECF\u4E66\u9762\u8BB8\u53EF\uFF0C\u4EFB\u4F55\u5355\u4F4D\u6216\u4E2A\u4EBA\u4E0D\u5F97\u4EE5\u590D\u5236\u3001\u4FEE\u6539\u3001\u5206\u53D1\u3001\u5546\u4E1A\u4F7F\u7528\u7B49\u65B9\u5F0F\u4F7F\u7528\u672C\u4F5C\u54C1\u3002

2. **\u7528\u6237\u5185\u5BB9\u6240\u6709\u6743**\u3002\u60A8\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u8FC7\u7A0B\u4E2D\u4E0A\u4F20\u81F3\u98DE\u4E66\u6216\u5176\u4ED6\u76EE\u6807\u670D\u52A1\u7684\u6240\u6709\u7B14\u8BB0\u5185\u5BB9\u3001\u6587\u6863\u3001\u56FE\u7247\u3001\u5143\u6570\u636E\u7B49\uFF08\u4EE5\u4E0B\u7B80\u79F0"\u7528\u6237\u5185\u5BB9"\uFF09\uFF0C\u5176\u77E5\u8BC6\u4EA7\u6743\u59CB\u7EC8\u5F52\u5C5E\u4E8E\u60A8\u672C\u4EBA\u3002\u672C\u63D2\u4EF6\u4E0D\u4E3B\u5F20\u5BF9\u4EFB\u4F55\u7528\u6237\u5185\u5BB9\u4EAB\u6709\u6743\u5229\u3002

## \u56DB\u3001\u8D23\u4EFB\u9650\u5236\u4E0E\u514D\u8D23\u6761\u6B3E

1. **\u65E0\u660E\u793A\u6216\u6697\u793A\u62C5\u4FDD**\u3002\u672C\u63D2\u4EF6\u6309"\u73B0\u72B6"\u548C"\u53EF\u7528"\u57FA\u7840\u63D0\u4F9B\uFF0C\u4F5C\u8005\u53CA\u7EF4\u62A4\u56E2\u961F**\u4E0D\u4F5C\u4EFB\u4F55\u660E\u793A\u6216\u6697\u793A\u7684\u4FDD\u8BC1**\uFF0C\u5305\u62EC\u4F46\u4E0D\u9650\u4E8E\uFF1A\u9002\u9500\u6027\u3001\u7279\u5B9A\u7528\u9014\u9002\u7528\u6027\u3001\u4E0D\u4FB5\u6743\u3001\u65E0\u9519\u8BEF\u6216\u4E2D\u65AD\u3001\u6301\u7EED\u53EF\u7528\u6027\u7B49\u3002\u4F7F\u7528\u672C\u63D2\u4EF6\u7684\u98CE\u9669\u7531\u60A8\u81EA\u884C\u627F\u62C5\u3002

2. **\u4E0D\u627F\u62C5\u95F4\u63A5\u635F\u5931**\u3002\u5728\u4EFB\u4F55\u60C5\u51B5\u4E0B\uFF0C\u65E0\u8BBA\u57FA\u4E8E\u5408\u540C\u3001\u4FB5\u6743\u3001\u4E25\u683C\u8D23\u4EFB\u6216\u5176\u4ED6\u6CD5\u5F8B\u7406\u8BBA\uFF0C\u4F5C\u8005\u53CA\u5173\u8054\u65B9\u5747\u4E0D\u5BF9\u56E0\u4F7F\u7528\u6216\u65E0\u6CD5\u4F7F\u7528\u672C\u63D2\u4EF6\u800C\u5BFC\u81F4\u7684**\u4EFB\u4F55\u95F4\u63A5\u3001\u9644\u5E26\u3001\u7279\u6B8A\u3001\u540E\u679C\u6027\u635F\u5BB3**\uFF08\u5305\u62EC\u4F46\u4E0D\u9650\u4E8E\u6570\u636E\u4E22\u5931\u3001\u4E1A\u52A1\u4E2D\u65AD\u3001\u5229\u6DA6\u635F\u5931\u3001\u4FE1\u606F\u6CC4\u9732\uFF09\u627F\u62C5\u8D23\u4EFB\u3002

3. **\u670D\u52A1\u4E2D\u65AD\u6216\u63A5\u53E3\u53D8\u66F4\u98CE\u9669**\u3002\u98DE\u4E66\u53CA\u5176\u4ED6\u76EE\u6807\u670D\u52A1\u5546\u53EF\u80FD\u968F\u65F6\u8C03\u6574\u5176 API \u63A5\u53E3\u89C4\u8303\u3001\u8BBF\u95EE\u7B56\u7565\u6216\u7EC8\u6B62\u670D\u52A1\u3002\u82E5\u56E0\u4E0A\u8FF0\u539F\u56E0\u5BFC\u81F4\u672C\u63D2\u4EF6\u529F\u80FD\u5931\u6548\u3001\u4E0A\u4F20\u5931\u8D25\u6216\u6570\u636E\u5F02\u5E38\uFF0C\u4F5C\u8005\u4E0D\u627F\u62C5\u4EFB\u4F55\u8D23\u4EFB\u3002\u5EFA\u8BAE\u60A8\u5B9A\u671F\u5907\u4EFD\u91CD\u8981\u6570\u636E\uFF0C\u5E76\u5173\u6CE8\u76EE\u6807\u5E73\u53F0\u516C\u544A\u3002

4. **\u7528\u6237\u884C\u4E3A\u5408\u89C4\u4E49\u52A1**\u3002\u60A8\u627F\u8BFA\u5728\u4F7F\u7528\u672C\u63D2\u4EF6\u4E0A\u4F20\u5185\u5BB9\u65F6\uFF0C\u9075\u5B88\u60A8\u6240\u5728\u5730\u533A\u76F8\u5173\u6CD5\u5F8B\u6CD5\u89C4\u5B9A\u3002\u7981\u6B62\u4E0A\u4F20\u542B\u6709\u8FDD\u6CD5\u4E0D\u826F\u4FE1\u606F\u3001\u4FB5\u72AF\u4ED6\u4EBA\u7248\u6743\u3001\u9690\u79C1\u6743\u6216\u5546\u4E1A\u79D8\u5BC6\u7684\u5185\u5BB9\u3002\u82E5\u56E0\u4E0A\u4F20\u5185\u5BB9\u5F15\u53D1\u7EA0\u7EB7\u6216\u6CD5\u5F8B\u8D23\u4EFB\uFF0C\u7531\u60A8\u81EA\u884C\u627F\u62C5\u5168\u90E8\u540E\u679C\u3002

## \u4E94\u3001\u534F\u8BAE\u4FEE\u6539\u4E0E\u7EC8\u6B62

1. **\u534F\u8BAE\u66F4\u65B0\u901A\u77E5**\u3002\u4F5C\u8005\u4FDD\u7559\u968F\u65F6\u4FEE\u8BA2\u672C\u534F\u8BAE\u7684\u6743\u5229\u3002\u91CD\u5927\u53D8\u66F4\u5C06\u901A\u8FC7 Obsidian \u63D2\u4EF6\u5E02\u573A\u516C\u544A\u3001GitHub \u53D1\u5E03\u8BF4\u660E\u7B49\u65B9\u5F0F\u901A\u77E5\u7528\u6237\u3002\u7EE7\u7EED\u4F7F\u7528\u672C\u63D2\u4EF6\u5373\u89C6\u4E3A\u63A5\u53D7\u6700\u65B0\u7248\u672C\u534F\u8BAE\u3002

2. **\u7528\u6237\u81EA\u4E3B\u9000\u51FA\u673A\u5236**\u3002\u60A8\u53EF\u968F\u65F6\u5378\u8F7D\u672C\u63D2\u4EF6\u6216\u5220\u9664\u672C\u5730\u914D\u7F6E\u6587\u4EF6\uFF08\u5982 \`data.json\`\uFF09\u4EE5\u7EC8\u6B62\u4F7F\u7528\u3002\u4E00\u65E6\u5378\u8F7D\uFF0C\u6240\u6709\u672C\u5730\u7F13\u5B58\u6570\u636E\u5C06\u88AB\u6E05\u9664\uFF0C\u4F46\u60A8\u5728\u98DE\u4E66\u7B49\u5916\u90E8\u5E73\u53F0\u5DF2\u7ECF\u4E0A\u4F20\u7684\u5185\u5BB9\u4E0D\u4F1A\u56E0\u6B64\u5220\u9664\uFF0C\u4ECD\u9700\u60A8\u81EA\u884C\u5904\u7406\uFF0C\u60A8\u4ECD\u9700\u5BF9\u4E0A\u4F20\u81F3\u98DE\u4E66\u7B49\u5916\u90E8\u5E73\u53F0\u7684\u5185\u5BB9\u8D1F\u8D23\u3002

3. **\u63D2\u4EF6\u7EC8\u6B62\u4F7F\u7528**\u3002\u82E5\u53D1\u73B0\u672C\u63D2\u4EF6\u5B58\u5728\u4E25\u91CD\u5B89\u5168\u6F0F\u6D1E\u3001\u6076\u610F\u884C\u4E3A\u6216\u8FDD\u53CD\u5F00\u6E90\u539F\u5219\u7684\u60C5\u51B5\uFF0C\u4F5C\u8005\u6709\u6743\u7ACB\u5373\u505C\u6B62\u7EF4\u62A4\u6216\u53D1\u5E03\u7EC8\u6B62\u7248\u672C\u3002\u5C4A\u65F6\u5EFA\u8BAE\u7528\u6237\u5C3D\u5FEB\u8FC1\u79FB\u6570\u636E\u5E76\u505C\u6B62\u4F7F\u7528\u3002`;
    void import_obsidian4.MarkdownRenderer.render(this.app, agreementText, agreementContainer, "", this.component);
    const buttonContainer = contentEl.createDiv({ cls: "obshare-agreement-buttons" });
    const rejectButton = buttonContainer.createEl("button", {
      text: "\u62D2\u7EDD"
    });
    rejectButton.onclick = () => {
      this.close();
      new import_obsidian4.Notice("\u60A8\u5DF2\u62D2\u7EDD\u7528\u6237\u534F\u8BAE\uFF0C\u63D2\u4EF6\u529F\u80FD\u5C06\u4E0D\u53EF\u7528\u3002", 5e3);
    };
    const agreeButton = buttonContainer.createEl("button", {
      text: "\u540C\u610F\u5E76\u7EE7\u7EED",
      cls: "mod-cta"
    });
    agreeButton.onclick = () => {
      void (async () => {
        this.plugin.settings.agreedToTerms = true;
        await this.plugin.saveSettings();
        this.plugin.completeInitialization();
        this.close();
        new import_obsidian4.Notice("\u6B22\u8FCE\u4F7F\u7528 Obshare\uFF01", 3e3);
      })();
    };
  }
  onClose() {
    const { contentEl } = this;
    contentEl.empty();
  }
};
